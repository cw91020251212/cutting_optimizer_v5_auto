<!DOCTYPE html>
<html lang="zh">
<head>
    <style>
      /* Equalize height and look for algorithm select and saw thickness input */
      #algorithmSelector.equal-height,
      #sawThickness.equal-height { height: 40px !important; }
      /* Use input-group to keep unit label same height */
      .equalize .form-control,
      .equalize .input-group-text { height: 40px !important; }
      .equalize .input-group-text { background-color: #f8f9fa; border-color: #ccc; color: #212529; }
      /* Make select visually consistent */
      #algorithmSelector.equal-height { padding-top: .25rem !important; padding-bottom: .25rem !important; font-size: 1rem !important; }

      /* Mobile: place Algorithm and Saw Thickness on same row (50% each) */
      @media (max-width: 767.98px) {
        #settings-card .row.g-3:nth-of-type(1) > .col-md-3:nth-child(3),
        #settings-card .row.g-3:nth-of-type(1) > .col-md-3:nth-child(4) {
          flex: 0 0 50% !important;
          max-width: 50% !important;
        }
      }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>é‹æåˆ‡å‰²æ’ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ... ä¿æŒåŸæœ‰çš„CSSæ¨£å¼ä¸è®Š ... */
        body {
            background-color: #2c3e50;
            color: #fff;
            padding: 15px;
        }

        .container-fluid {
            max-width: 1600px;
            margin: auto;
        }

        .card {
            background-color: #454d55;
            border: 1px solid #6c757d;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .card-body-light {
            background-color: #e9ecef;
            color: #212529;
        }

        .card-body {
            padding: 1.25rem;
        }

        .form-control {
            background-color: #fff;
            color: #212529;
            border: 2px solid #495057;
        }

        .form-control::placeholder {
            color: #6c757d;
        }

        .form-control.is-invalid {
            border-color: #dc3545;
        }

        .form-label {
            color: inherit;
            font-weight: 500;
            font-size: 1.05em;
        }

        .small-hint {
            font-size: .9em;
            color: #6c757d;
            margin-top: 3px;
            display: block;
        }

        .card-body-light .small-hint {
            color: #5a6268;
        }

        .error-message {
            font-size: .9em;
            color: #dc3545;
            margin-top: 3px;
            display: none;
        }

        canvas {
            border: 1px solid #6c757d;
            width: 100%;
            height: auto;
            overflow-y: auto;
            background-color: #fff;
            display: block;
            margin-top: 15px;
        }

        .btn {
            transition: all 50ms ease-in-out;
            font-weight: 700;
            font-size: 1.05em;
            text-shadow: 0 0 1px #000, 0 0 1px #000;
            box-shadow: inset 2px 2px 0 rgba(255, 255, 255, .6), inset -2px -2px 0 rgba(0, 0, 0, .4), 0 2px 3px rgba(0, 0, 0, .4);
            position: relative;
        }

        .btn:hover {
            box-shadow: inset 2px 2px 0 rgba(255, 255, 255, .8), inset -2px -2px 0 rgba(0, 0, 0, .5), 0 3px 5px rgba(0, 0, 0, .5);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: inset 2px 2px 0 rgba(0, 0, 0, .5), inset -2px -2px 0 rgba(255, 255, 255, .3), inset 0 0 3px rgba(0, 0, 0, .6);
        }

        .fade-in {
            animation: fadeIn .5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .cutting-item,
        .material-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #868e96;
        }

        .cutting-item:last-child,
        .material-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .progress {
            margin-top: 10px;
            display: none;
            height: 20px;
            background-color: #6c757d;
        }

        .progress-bar {
            background-color: #007bff;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            color: #fff;
            font-size: 12px;
            line-height: 20px;
        }

        .result-details {
            margin-top: 20px;
            font-size: .95em;
            color: #ced4da;
        }

        .result-details ul {
            padding-left: 20px;
        }

        .result-details li {
            margin-bottom: 8px;
        }

        #pageTitle {
            background: linear-gradient(45deg, #4b6cb7, #182848);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, .3);
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            border: 2px solid #ffc107;
        }

        #titleText {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .5);
        }

        .section-header {
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            color: #fff;
            font-weight: 700;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #3a7bd5, #00d2ff);
            border-left: 8px solid #004d40;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-indicator {
            background-color: #ffc107;
            color: #212529;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .step-badge {
            background: #495057;
            color: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: .85em;
            margin-left: 10px;
        }

        @media (min-width: 768px) {

            .cutting-item .row>div {
                padding-right: 8px;
                padding-left: 8px;
            }

            .cutting-item .col-md-4 {
                flex: 0 0 40%;
                max-width: 40%;
            }

            .cutting-item .col-md-3 {
                flex: 0 0 20%;
                max-width: 20%;
            }

            .cutting-item .col-md-4.purpose-col {
                flex: 0 0 30%;
                max-width: 30%;
            }

            .cutting-item .col-md-1 {
                flex: 0 0 10%;
                max-width: 10%;
            }

            .material-item .col-md-5 {
                flex: 0 0 70%;
                max-width: 70%;
            }

            .material-item .col-md-2 {
                flex: 0 0 30%;
                max-width: 30%;
            }

            .length-input-group .form-control {
                font-size: 1rem;
                padding: 6px;
            }

            .length-input-group .col-md-2 {
                flex: 0 0 25%;
                max-width: 25%;
            }

            .length-input-group .col-md-1 {
                flex: 0 0 15%;
                max-width: 15%;
            }

            .unit-select {
                max-width: 100%;
            }

            .form-control.cutQty,
            .form-control.materialQty {
                max-width: 100px;
            }

            .form-control.cutPurpose {
                max-width: 100%;
            }
        }

        @media (max-width: 767.98px) {
            body {
                padding: 10px;
            }

            .card-body {
                padding: 1rem;
            }

            h2#pageTitle {
                font-size: 1.5rem;
            }

            .form-label {
                font-size: 1.05em;
            }

            .error-message,
            .small-hint {
                font-size: .85em;
                margin-top: 2px;
            }

            .button-group>.btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .button-group>.btn:last-child {
                margin-bottom: 0;
            }
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .quantity-needed,
        .schemes-identical {
            color: #ffc107;
            font-weight: 700;
            margin-top: 10px;
        }

        .scheme-selector {
            margin: 15px 0;
        }

        .scheme-selector button {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        #colorLegend {
            margin-top: 15px;
            display: none;
        }

        .color-legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #6c757d;
        }

        @media (max-width: 767.98px) {
            .color-legend-item {
                display: flex;
                margin-bottom: 8px;
            }
        }

        .form-check-label {
            display: flex;
            flex-direction: column;
        }

        .form-check-label .description {
            font-size: .85em;
            color: #6c757d;
            margin-top: 2px;
        }

        .length-input-group .form-control {
            font-size: 1.1rem;
            padding: 8px;
        }

        .unit-select {
            max-width: 160px;
            white-space: nowrap;
        }

        @media (max-width: 767.98px) {

            .length-input-group .form-control {
                font-size: .95rem;
                padding: 6px;
            }

            .unit-select {
                max-width: 140px;
                white-space: nowrap;
            }
        }

        .unit-select.metric-active {
            background-color: #28a745;
            color: #fff;
            border-color: #28a745;
        }

        .unit-select.imperial-active {
            background-color: #17a2b8;
            color: #fff;
            border-color: #17a2b8;
        }

        .waste-label {
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            position: absolute;
            background-color: #fff;
            padding: 2px 4px;
            border: 1px solid #000;
            z-index: 10;
            pointer-events: none;
        }

        @media print {

            body>.container-fluid>:not(.card):not(#pageTitle) {
                display: none;
            }

            #settings-card:not(.print-section) {
                display: none;
            }

            #cutting-items-card:not(.print-section) {
                display: none;
            }

            #materials-card:not(.print-section) {
                display: none;
            }

            #results-card:not(.print-section) {
                display: none;
            }

            #results-card #resultDetails:not(.print-section-results) {
                display: none;
            }

            #results-card #cuttingCanvas:not(.print-section-visualization) {
                display: none;
            }

            #results-card #colorLegend:not(.print-section-legend) {
                display: none;
            }

            #results-card .quantity-needed:not(.print-section-results) {
                display: none;
            }

            #results-card .scheme-selector:not(.print-section-results) {
                display: none;
            }

            .card {
                border: 1px solid #000;
                box-shadow: none;
                background-color: #fff;
                color: #000;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }

            .card-body-light {
                background-color: #fff;
                color: #000;
            }

            h3 {
                color: #000;
            }

            .form-control {
                border: none;
                background-color: transparent;
            }

            .error-message,
            .small-hint,
            button {
                display: none !important;
            }

            canvas {
                max-width: 100%;
                height: auto !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #progressBar {
                display: none;
            }

            #pageTitle {
                display: block;
                text-align: center;
                margin-bottom: 20px;
            }

            .color-swatch {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        .saw-thickness-input {
            display: flex;
            align-items: center;
        }

        .saw-thickness-input .form-control {
            max-width: 120px;
            margin-right: 10px;
        }

        .saw-thickness-input .unit-label {
            font-size: .95em;
        }

        .btn {
            padding: .5rem 1rem;
            min-width: 44px;
            min-height: 44px;
        }

        input,
        select,
        textarea {
            min-height: 44px;
        }

        .canvas-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .zoom-btn {
            padding: .25rem .5rem;
            font-size: .8rem;
        }

        .save-scheme-btn {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: #fff;
        }

        .save-scheme-btn:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        .load-scheme-btn {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: #fff;
        }

        .load-scheme-btn:hover {
            background-color: #5a32a3;
            border-color: #512da8;
        }

        .help-btn {
            background-color: #6c757d;
            border-color: #5a6268;
            color: #fff;
        }

        .help-btn:hover {
            background-color: #5a6268;
        }

        .modal-content {
            color: #212529;
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-control {
            border-width: 1px !important;
            border-color: #ccc !important;
        }

        .form-control:focus {
            border-color: #999 !important;
            box-shadow: 0 0 0 .1rem rgba(0, 0, 0, .05) !important;
        }

        .form-select {
            border-width: 1px !important;
            border-color: #ccc !important;
        }

        .form-select:focus {
            border-color: #999 !important;
            box-shadow: 0 0 0 .1rem rgba(0, 0, 0, .05) !important;
        }

        @keyframes rulerWiggle {

            0%,
            100% {
                transform: rotate(0)
            }

            25% {
                transform: rotate(10deg)
            }

            50% {
                transform: rotate(-5deg)
            }

            75% {
                transform: rotate(5deg)
            }
        }

        .ruler-anim {
            display: inline-block;
            animation: rulerWiggle 2.5s ease-in-out infinite;
            transform-origin: center center;
        }

        @media (max-width: 767.98px) {
            #pageTitle {
                gap: 14px;
            }

            #pageTitle i.fa-layer-group,
            #pageTitle i.fa-ruler-combined {
                font-size: 1.7rem !important;
                color: #ffc107 !important;
            }

            body.lang-zh #titleText {
                white-space: nowrap;
            }

            body.lang-en #titleText {
                white-space: normal;
                display: inline-block;
                max-width: 18ch;
                text-align: center;
                line-height: 1.1;
            }
        }

        .edit-mode {
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5) !important;
        }

        .table-row-edit {
            background-color: #fff3cd !important;
            color: #212529 !important;
        }

        .btn-sm {
            min-width: auto;
            min-height: auto;
            padding: .25rem .5rem;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .update-btn {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .update-btn:hover {
            background-color: #e0a800;
            border-color: #d39e00;
            color: #212529;
        }
    /* è®“åˆ‡å‰²é …ç›®ä¸­çš„ã€Œå°º/å¯¸/åˆ†ã€ä¸‰æ¬„æ°´å¹³æ’åˆ—ä¸¦ç­‰å¯¬ */


/* æ§åˆ¶åˆ‡å‰²é …ç›®ç¬¬ä¸‰è¡Œï¼ˆæ–°å¢ï½œæ¸…é™¤ï½œå–®ä½ï¼‰ç‚ºåŒæ’ä¸”ä¸æ›è¡Œï¼Œä¸¦é¿å…æŒ‰éˆ•æ–‡å­—æ›è¡Œé€ æˆé«˜åº¦ä¸ä¸€è‡´ */
#cuttingItems .controls-row { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
#cuttingItems .controls-row .btn { flex: 1 1 0; white-space: nowrap; padding: .5rem .75rem; height: 38px !important; display: flex !important; align-items: center !important; justify-content: center !important; }
#cuttingItems .controls-row .unit-select { max-width: 45px !important; min-width: 45px !important; width: 45px !important; height: 38px !important; font-size: 1rem !important; text-align: center !important; padding: 0.2rem 0.1rem !important; box-sizing: border-box !important; }
@media (max-width: 390px) {
  #cuttingItems .controls-row { gap: 6px; }
  #cuttingItems .controls-row .unit-select { max-width: 45px !important; min-width: 45px !important; width: 45px !important; height: 38px !important; }
}

        /* æ§åˆ¶ç¬¬ä¸‰è¡Œï¼ˆæ–°å¢ï½œæ¸…é™¤ï½œå–®ä½ï¼‰å›ºå®šåŒä¸€è¡Œä¸”ä¸å‡ºç•Œ */
        .controls-row {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            width: 100%;
        }
        .controls-row .btn {
            flex: 1 1 0;
            min-width: 86px; height: 38px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-sizing: border-box !important; border-width: 1px !important; }
        .controls-row .unit-select {
            flex: 0 0 auto;
            min-width: 45px !important;
            max-width: 45px !important; width: 45px !important; height: 38px !important; font-size: 1rem !important; text-align: center !important; padding: 0.2rem 0.1rem !important; box-sizing: border-box !important;
            white-space: nowrap;
            -webkit-appearance: none;
            appearance: none;
        }
        /* é€²ä¸€æ­¥ç´„æŸç¬¬ä¸‰è¡Œå¯¬åº¦ï¼ˆå–®ä½æ›´ç´°ã€å…©é‚ŠæŒ‰éˆ•ä¿æŒè¼ƒå¤§ï¼‰*/
        @media (max-width: 767.98px) {
            .controls-row { gap: 6px; }
            .controls-row .btn { font-size: .95rem; padding: .40rem .60rem; white-space: nowrap; flex: 1 1 0; min-width: 90px; height: 38px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-sizing: border-box !important; border-width: 1px !important; }
            /* å–®ä½ä¸‹æ‹‰æ¥µé™ç¸®ç´°ï¼šå­—é«”ã€å…§è·ã€å¯¬åº¦æ›´å° */
            .controls-row .unit-select { width: auto !important; flex: 0 0 clamp(72px, 18vw, 96px); max-width: 45px !important; min-width: 45px !important; width: 45px !important; height: 38px !important; box-sizing: border-box !important; white-space: nowrap; font-size: 1rem; text-align: center; padding: 0 !important; line-height: 38px !important; -webkit-appearance: none; appearance: none; display: inline-flex; align-items: center; justify-content: center; }
        }
</style>

<style>
/* å¼·åˆ¶è¦†è“‹ Bootstrap æ¨£å¼ - æé«˜æ¬Šé‡ */
body select.unit-select.metric-active {
    background-color: #198754 !important; /* Bootstrap success green - æ·±ç¶  */
    color: white !important;
    border-color: #157347 !important;
    background-image: none !important;
}

body select.unit-select.imperial-active {
    background-color: #0d6efd !important; /* Bootstrap primary blue - æ·±è— */
    color: white !important;
    border-color: #0a58ca !important;
    background-image: none !important;
}
body select.unit-select option {
    background-color: white;
    color: black;
}

    /* å–®ä½é¸æ“‡å™¨çš„3Dæ•ˆæœ */
    select.unit-select.btn-3d,
    #globalCutUnit,
    #globalMaterialUnit {
        text-align: center !important;
        font-size: 1rem !important;
        font-weight: 700 !important;
        padding: 0.25rem 0.1rem !important;
        height: 38px !important;
        width: 45px !important;
        max-width: 45px !important;
        min-width: 45px !important;
        box-sizing: border-box !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        background-image: none !important;
        line-height: 1.2 !important;
        /* 3Dæ•ˆæœ */
        transition: all 50ms ease-in-out !important;
        box-shadow: inset 2px 2px 0 rgba(255, 255, 255, .6), 
                    inset -2px -2px 0 rgba(0, 0, 0, .4), 
                    0 2px 3px rgba(0, 0, 0, .4) !important;
        position: relative !important;
        border: 2px solid #495057 !important;
    }

    /* è¨­ç½®é é¢çš„å–®ä½é¸æ“‡å™¨ç¨å¤§ä¸€é» */
    #unit {
        width: 60px !important;
        max-width: 60px !important;
        min-width: 60px !important;
        font-size: 1.1rem !important;
        text-align: center !important;
        font-weight: 700 !important;
        padding: 0.25rem 0.1rem !important;
        height: 38px !important;
        box-sizing: border-box !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        background-image: none !important;
        line-height: 1.2 !important;
    }

    select.unit-select.btn-3d:active,
    #unit:active,
    #globalCutUnit:active,
    #globalMaterialUnit:active {
        transform: translateY(2px) !important;
        box-shadow: inset 2px 2px 0 rgba(0, 0, 0, .5), 
                    inset -2px -2px 0 rgba(255, 255, 255, .3), 
                    inset 0 0 3px rgba(0, 0, 0, .6) !important;
    }

    /* ç§»é™¤inline styleçš„å½±éŸ¿ */
    #globalCutUnit[style],
    #globalMaterialUnit[style] {
        min-width: 45px !important;
        max-width: 45px !important;
        width: 45px !important;
    }
    
        #unitLabel { font-weight: 400 !important; font-size: 0.875rem !important; margin-bottom: 0.5rem !important; display: block !important; text-align: left !important; }
        #unit.unit-select { height: 40px !important; width: 40px !important; min-width: 40px !important; max-width: 40px !important; font-size: 1rem !important; font-weight: 500 !important; text-align: center !important; text-align-last: center !important; padding: 0 !important; line-height: 40px !important; border-radius: 6px !important; cursor: pointer !important; box-sizing: border-box !important; }
        #unit.unit-select option { text-align: center; padding: 8px; }
        select.unit-select:not(#unit), .unit-select:not(#unit) { text-align: center !important; text-align-last: center !important; padding-left: 0 !important; padding-right: 0 !important; line-height: 38px !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; }
        </style>
    <style>
      /* Optional note styling for non-required fields */
      .optional-note { font-size: .85em; color: #ffc107; margin-left: 0; }
      /* In light sections ensure readable color */
      .card-body-light .optional-note { color: #d39e00; }
    </style>
    <style>
      /* Force Algorithm + Saw Thickness to sit sideâ€‘byâ€‘side on phones */
      @media (max-width: 767.98px) {
        #settings-card .row.g-3 > .col-6.col-md-3 { display: inline-block !important; width: 50% !important; vertical-align: top; }
      }
    </style>
    <style>
      /* Align saw-thickness unit text without boxed chip (mobile + desktop) */
      .saw-thickness-input { display:flex; align-items:center; gap:6px; }
.saw-thickness-input .form-control { flex: 1 1 auto; }
.saw-thickness-input .unit-label { flex: 0 0 auto; white-space: nowrap; font-size: .95rem; margin-left: 0; line-height: 40px; height: 40px; }
/* é¿å…å–®ä½æ›è¡Œå£“ä½æç¤ºæ–‡å­— */
#sawThicknessLabel + .saw-thickness-input + #sawThicknessHint { margin-top: 6px; }
      .saw-thickness-input .form-control { height:40px !important; }
      .saw-thickness-input .unit-label { height:40px; line-height:40px; padding:0 4px; border:0; background:transparent; color:#212529; }
      #algorithmSelector.equal-height { height:40px !important; padding-top:.25rem !important; padding-bottom:.25rem !important; font-size:1rem !important; }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h2 class="d-flex justify-content-center align-items-center text-nowrap mb-4" id="pageTitle">
            <i class="fa-solid fa-layer-group fa-2x me-2"></i>
            <span id="titleText">é‹æåˆ‡å‰²æ’ç‰ˆ</span>
            <i class="fa-solid fa-ruler-combined fa-2x ms-2 ruler-anim"></i>
        </h2>

        <div class="card" id="settings-card">
            <div class="card-body card-body-light">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fa-solid fa-gear fa-lg me-2"></i>
                        <span id="settingsTitle">è¨­ç½®</span>
                    </div>
                    <span class="step-indicator">1/4</span>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label" id="languageLabel">èªè¨€:</label>
                        <select id="language" class="form-select form-select-sm" onchange="updateLanguage()">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex flex-column align-items-start">
                            <label class="form-label mb-2" id="unitLabel" style="font-size: 0.875rem;">é¡¯ç¤ºå–®ä½:</label>
                            <select id="unit" class="form-select unit-select" onchange="updateInputLabels()" style="height: 40px; width: 40px; font-size: 1rem; font-weight: 500;">
                                <option value="metric" selected="selected">å…¬</option>
                                <option value="imperial">è‹±</option>
                                <option value="imperial_decimal">è‹±(D)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label" id="algorithmLabel">ç®—æ³•:</label>
                        <select id="algorithmSelector" class="form-select equal-height">
                            <option value="AutoBest">è‡ªå‹•æœ€æ…³æ–™</option>
                            <option value="BFD">BFD</option>
                            <option value="FFD">FFD</option>
                            <option value="SizeGrouping">æ™ºèƒ½å„ªåŒ–</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label" id="sawThicknessLabel">é‹¸ç‰‡åšåº¦:</label>
                        <div class="saw-thickness-input equalize">
                            <input class="form-control" id="sawThickness" placeholder="3.2" style="width: 100px;">
                            <span class="unit-label" id="sawThicknessUnitLabel">æ¯«ç±³</span>
                        </div>
                        <div class="small-hint" id="sawThicknessHint">ä¾‹å¦‚: 3.2 (æ¯«ç±³) æˆ– 1/8 (åˆ†)</div>
                        <div class="error-message" id="sawThicknessError"></div>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-12">
                        <label class="form-label" id="schemeManagementLabel">æ–¹æ¡ˆç®¡ç†:</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm save-scheme-btn" onclick="saveScheme()" id="saveSchemeButton">
                                <i class="fas fa-save me-1"></i>å„²å­˜æ–¹æ¡ˆ
                            </button>
                            <button class="btn btn-sm load-scheme-btn" onclick="loadScheme()" id="loadSchemeButton">
                                <i class="fas fa-folder-open me-1"></i>è¼‰å…¥æ–¹æ¡ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="cutting-items-card">
            <div class="card-body card-body-light">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fa-solid fa-list-check fa-lg me-2"></i>
                        <span id="cuttingItemsTitle">åˆ‡å‰²é …ç›®</span>
                    </div>
                    <span class="step-indicator">2/4</span>
                </div>
                <div id="cuttingItems">
                    <div class="cutting-item">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-12">
                                <label class="form-label cutLengthLabel">é•·åº¦:</label>
                                <div class="row g-2 length-input-group d-flex align-items-end">
                                    <div class="col">
                                        <input type="number" step="0.001" inputmode="decimal"
                                            class="form-control form-control-lg cutLengthPart" data-part="ft"
                                            placeholder="0">
                                        <label class="small-hint cutLengthHint">ç±³</label>
                                        <div class="error-message cutLengthError"></div>
                                    </div>
                                    <div class="col">
                                        <input type="number" step="0.001" inputmode="decimal"
                                            class="form-control form-control-lg cutLengthPart" data-part="in"
                                            placeholder="0">
                                        <label class="small-hint cutLengthHint">å˜ç±³</label>
                                    </div>
                                    <div class="col">
                                        <input type="number" step="0.001" inputmode="decimal"
                                            class="form-control form-control-lg cutLengthPart" data-part="eighth"
                                            placeholder="0">
                                        <label class="small-hint cutLengthHint">æ¯«ç±³</label>
                                    </div>
                                </div>
                            </div>
                            <!-- ç¬¬äºŒè¡Œï¼šæ•¸é‡ï½œç”¨é€” -->
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <label class="form-label cutQtyLabel">æ•¸é‡:</label>
                                    <input type="number" class="cutQty form-control form-control-sm" placeholder="0" min="0">
                                    <div class="small-hint cutQtyHint">ä¾‹å¦‚ï¼š5</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label cutPurposeLabel">ç”¨é€”:</label>
                                    <input class="cutPurpose form-control form-control-sm" placeholder="">
                                    <div class="small-hint cutPurposeHint">ä¾‹å¦‚ï¼šé‚Šæ¡†</div>
                                </div>
                            </div>
                            <!-- ç¬¬ä¸‰è¡Œï¼šæ–°å¢ï½œæ¸…é™¤ï½œå–®ä½ï¼ˆå›ºå®šåŒä¸€è¡Œï¼‰ -->
                            <div class="d-flex mt-2 gap-2 flex-nowrap align-items-center controls-row">
                                <button class="btn btn-success btn-sm flex-fill" onclick="addCuttingItem()" id="addCuttingButton">
                                    <i class="fas fa-plus me-1"></i>æ–°å¢é …ç›®
                                </button>
                                <button class="btn btn-secondary btn-sm flex-fill" onclick="clearCuttingInputs()" id="clearCuttingButton">
                                    <i class="fas fa-times me-1"></i>æ¸…é™¤è¼¸å…¥
                                </button>
                                <select id="globalCutUnit" class="form-select form-select-sm unit-select cutLengthUnit flex-shrink-0" style="min-width:110px; max-width:160px; white-space:nowrap">
                                    <option value="metric" selected="selected">å…¬</option>
                                    <option value="imperial">è‹±</option>
                                    </select>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <table id="cuttingItemsTable" class="table table-sm table-hover mt-3">
                    <thead>
                        <tr class="table-active">
                            <th>é•·åº¦</th>
                            <th>æ•¸é‡</th>
                            <th>ç”¨é€”</th>
                            <th class="text-center" style="width:100px">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-warning btn-sm update-btn" onclick="updateCuttingItem()" id="updateCuttingButton" style="display:none">
                        <i class="fas fa-edit me-1"></i>æ›´æ–°é …ç›®
                    </button>
                </div>
                <input type="hidden" id="editingCuttingIndex" value="-1">
            </div>
        </div>

        <div class="card mt-3" id="materials-card">
            <div class="card-body card-body-light">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fa-solid fa-ruler-combined fa-lg me-2"></i>
                        <span id="materialTitle">ææ–™</span>
                    </div>
                    <span class="step-indicator">3/4</span>
                </div>
                <div id="materialItems">
                    <div class="material-item">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-12">
                                <label class="form-label materialLengthLabel">ææ–™é•·åº¦:</label>
                                <div class="row g-2 length-input-group d-flex align-items-end">
                                    <div class="col">
                                        <input type="number" step="0.001" inputmode="decimal"
                                            class="form-control form-control-lg materialLengthPart" data-part="ft"
                                            placeholder="0">
                                        <label class="small-hint materialLengthHint">ç±³</label>
                                        <div class="error-message materialLengthError"></div>
                                    </div>
                                    <div class="col">
                                        <input type="number" step="0.001" inputmode="decimal"
                                            class="form-control form-control-lg materialLengthPart" data-part="in"
                                            placeholder="0">
                                        <label class="small-hint materialLengthHint">å˜ç±³</label>
                                    </div>
                                    <div class="col">
                                        <input type="number" step="0.001" inputmode="decimal"
                                            class="form-control form-control-lg materialLengthPart" data-part="eighth"
                                            placeholder="0">
                                        <label class="small-hint materialLengthHint">æ¯«ç±³</label>
                                    </div>
                                </div>
                            </div>
                            <!-- æ•¸é‡ -->
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <label class="form-label materialQtyLabel">æ•¸é‡:</label>
                                    <input type="number" class="materialQty form-control form-control-sm" value="1" min="1">
                                    <div class="small-hint materialQtyHint">10</div>
                                </div>
                            </div>
                            <!-- æ§åˆ¶æŒ‰éˆ•è¡Œ -->
                            <div class="d-flex mt-2 gap-2 flex-nowrap align-items-center controls-row">
                                <button class="btn btn-success btn-sm flex-fill" onclick="addMaterialItem()" id="addMaterialButton">
                                    <i class="fas fa-plus me-1"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm flex-fill" onclick="clearMaterialInputs()" id="clearMaterialButton">
                                    <i class="fas fa-times me-1"></i>
                                </button>
                                <select id="globalMaterialUnit" class="form-select form-select-sm unit-select materialLengthUnit flex-shrink-0 btn-3d">
                                    <option value="metric" selected="selected">å…¬</option>
                                    <option value="imperial">è‹±</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <table id="materialItemsTable" class="table table-sm table-hover mt-3">
                    <thead>
                        <tr class="table-active">
                            <th>ææ–™é•·åº¦</th>
                            <th>æ•¸é‡</th>
                            <th class="text-center" style="width:100px">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-warning btn-sm update-btn" onclick="updateMaterialItem()" id="updateMaterialButton" style="display:none">
                        <i class="fas fa-edit me-1"></i>æ›´æ–°ææ–™
                    </button>
                </div>
                <input type="hidden" id="editingMaterialIndex" value="-1">
            </div>
        </div>

        <div class="card" id="results-card">
            <div class="card-body text-center">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fa-solid fa-chart-bar fa-lg me-2"></i>
                        <span id="resultTitle">åˆ‡å‰²çµæœ</span>
                    </div>
                    <span class="step-indicator">4/4</span>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="calculate()" id="calculateButton">
                        <i class="fas fa-calculator me-2"></i>è¨ˆç®—
                    </button>
                    <button class="btn btn-danger" onclick="reset()" id="resetButton">
                        <i class="fas fa-undo me-2"></i>é‡ç½®
                    </button>
                    <button class="btn btn-success" onclick="showPrintOptions()" id="printOptionsButton"
                        style="display:none">
                        <i class="fas fa-print me-2"></i>åˆ—å°é¸é …
                    </button>
                    <button class="btn btn-success" onclick="triggerPrint()" id="printButton" style="display:none">
                        <i class="fas fa-print me-2"></i>åˆ—å°å ±å‘Š
                    </button>
                    <button class="btn help-btn" onclick="showHelp()" id="helpButton">
                        <i class="fas fa-question-circle me-2"></i>ä½¿ç”¨èªªæ˜
                    </button>
                </div>
                <div class="progress mt-3" id="progressBar" style="display:none">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width:0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBarInner">
                    </div>
                    <span class="progress-text" id="progressText"></span>
                </div>
                <div class="scheme-selector" id="schemeSelector" style="display:none">
                    <h5 id="schemeTitle">é¸æ“‡åˆ‡å‰²æ–¹æ¡ˆ:</h5>
                    <div id="schemeButtons"></div>
                </div>
                <div class="result-details text-start" id="resultDetails" style="display:none">
                    <div id="optimizationResults"></div>
                    <div class="quantity-needed" id="quantityNeededMessage" style="display:none"></div>
                </div>
                <canvas id="cuttingCanvas" class="mt-3" style="display:none"></canvas>
                <div id="colorLegend" style="display:none">
                    <h4><span id="colorLegendTitle"><i class="fa-solid fa-palette me-2"></i>é¡è‰²åœ–ä¾‹</span></h4>
                    <div id="colorLegendItems"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ—å°é¸é …æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="printOptionsModal" tabindex="-1" aria-labelledby="printOptionsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="printOptionsModalLabel">åˆ—å°é¸é …</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>é¸æ“‡è¦åˆ—å°çš„å…§å®¹:</p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="printSettings" checked="checked">
                        <label class="form-check-label" for="printSettings">
                            è¨­ç½®
                            <span class="description">èªè¨€ã€é¡¯ç¤ºå–®ä½ã€é‹¸ç‰‡åšåº¦</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="printCuttingItems" checked="checked">
                        <label class="form-check-label" for="printCuttingItems">
                            åˆ‡å‰²é …ç›®
                            <span class="description">æ‰€æœ‰è¼¸å…¥çš„åˆ‡å‰²é•·åº¦ã€æ•¸é‡å’Œç”¨é€”</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="printMaterials" checked="checked">
                        <label class="form-check-label" for="printMaterials">
                            ææ–™
                            <span class="description">æ‰€æœ‰è¼¸å…¥çš„ææ–™é•·åº¦å’Œæ•¸é‡</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="printResults" checked="checked">
                        <label class="form-check-label" for="printResults">
                            åˆ‡å‰²çµæœ (åŒ…å«æ‘˜è¦)
                            <span class="description">å„ªåŒ–å¾Œçš„åˆ‡å‰²æ–¹æ¡ˆè©³æƒ…</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="printVisualization" checked="checked">
                        <label class="form-check-label" for="printVisualization">
                            è¦–è¦ºåŒ–åœ–è¡¨
                            <span class="description">åˆ‡å‰²æ–¹æ¡ˆçš„åœ–å½¢åŒ–å±•ç¤º</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="printLegend" checked="checked">
                        <label class="form-check-label" for="printLegend">
                            é¡è‰²åœ–ä¾‹
                            <span class="description">åˆ‡å‰²ä»¶é•·åº¦å°æ‡‰é¡è‰²èªªæ˜</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="triggerPrint()">ç¢ºèªåˆ—å°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å„²å­˜æ–¹æ¡ˆæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="saveSchemeModal" tabindex="-1" aria-labelledby="saveSchemeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveSchemeModalLabel">å„²å­˜æ–¹æ¡ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="schemeName" class="form-label">æ–¹æ¡ˆåç¨±:</label>
                        <input class="form-control" id="schemeName" placeholder="è¼¸å…¥æ–¹æ¡ˆåç¨±">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSaveScheme()">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥æ–¹æ¡ˆæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="loadSchemeModal" tabindex="-1" aria-labelledby="loadSchemeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loadSchemeModalLabel">è¼‰å…¥æ–¹æ¡ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #ddd">
                        <h6>ğŸ“ å¾æª”æ¡ˆä¸Šè¼‰æ–¹æ¡ˆ</h6>
                        <input type="file" id="schemeFileInput" accept=".json" style="margin-top:10px">
                        <button type="button" class="btn btn-primary" onclick="uploadSchemeFile()"
                            style="margin-top:10px;background-color:#0056b3;color:#fff;font-weight:700;font-size:15px;padding:8px 18px;border:none;border-radius:4px">ğŸ“¤
                            ä¸Šè¼‰</button>
                    </div>
                    <div>
                        <h6>ğŸ“‹ å·²å„²å­˜çš„æ–¹æ¡ˆ</h6>
                        <div id="savedSchemesList"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">ä½¿ç”¨èªªæ˜</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="helpContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å¸¸æ•¸å®šç¾©
        let INCH_TO_MM = 25.4;
        let MM_TO_INCH = 1 / INCH_TO_MM;
        let FT_TO_MM = 304.8;
        let M_TO_MM = 1000;
        let CM_TO_MM = 10;
        let EIGHTH_TO_MM = INCH_TO_MM / 8;

        // å…¨åŸŸå®‰å…¨è½‰ç¾©ï¼ˆé˜²æ­¢ DOM XSSï¼‰ï¼Œä¾›æ‰€æœ‰æ¨¡æ¿ä½¿ç”¨
        function escapeHTML(str) {
            if (str === null || str === undefined) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        // å…¨å±€è®Šé‡ï¼Œç”¨æ–¼è¨˜éŒ„ç·¨è¼¯ç‹€æ…‹
        let editingCuttingIndex = -1;
        let editingMaterialIndex = -1;

        // å¤šèªè¨€æ–‡æœ¬
        const elements = {
            titleText: {
                zh: "é‹æåˆ‡å‰²æ’ç‰ˆ",
                en: "Aluminum Cutting<br>Optimization"
            },
            settingsTitle: {
                zh: "è¨­ç½®",
                en: "Settings"
            },
            languageLabel: {
                zh: "èªè¨€:",
                en: "Language:"
            },
            unitLabel: {
                zh: "é¡¯ç¤ºå–®ä½:",
                en: "Result Display Unit:"
            },
            algorithmLabel: {
                zh: "ç®—æ³•:",
                en: "Algorithm:"
            },
            sawThicknessLabel: {
                zh: "é‹¸ç‰‡åšåº¦:",
                en: "Saw Thickness:"
            },
            schemeManagementLabel: {
                zh: "æ–¹æ¡ˆç®¡ç†:",
                en: "Scheme Management:"
            },
            saveSchemeButton: {
                zh: '<i class="fas fa-save me-1"></i>å„²å­˜æ–¹æ¡ˆ',
                en: '<i class="fas fa-save me-1"></i>Save Scheme'
            },
            loadSchemeButton: {
                zh: '<i class="fas fa-folder-open me-1"></i>è¼‰å…¥æ–¹æ¡ˆ',
                en: '<i class="fas fa-folder-open me-1"></i>Load Scheme'
            },
            cuttingItemsTitle: {
                zh: "åˆ‡å‰²é …ç›®",
                en: "Cutting Items"
            },
            cutLengthLabel: {
                zh: "é•·åº¦:",
                en: "Length:"
            },
            cutQtyLabel: {
                zh: "æ•¸é‡:",
                en: "Quantity:"
            },
            cutPurposeLabel: {
                zh: "ç”¨é€”:",
                en: "Purpose:"
            },
            addCuttingButton: {
                zh: '<i class="fas fa-plus me-1"></i>æ–°å¢é …ç›®',
                en: '<i class="fas fa-plus me-1"></i>Add Item'
            },
            updateCuttingButton: {
                zh: '<i class="fas fa-edit me-1"></i>æ›´æ–°é …ç›®',
                en: '<i class="fas fa-edit me-1"></i>Update Item'
            },
            clearCuttingButton: {
                zh: '<i class="fas fa-times me-1"></i>æ¸…é™¤è¼¸å…¥',
                en: '<i class="fas fa-times me-1"></i>Clear Input'
            },
            materialTitle: {
                zh: "ææ–™",
                en: "Material"
            },
            materialLengthLabel: {
                zh: "ææ–™é•·åº¦:",
                en: "Material Length:"
            },
            materialQtyLabel: {
                zh: "æ•¸é‡:",
                en: "Quantity:"
            },
            addMaterialButton: {
                zh: '<i class="fas fa-plus me-1"></i>æ–°å¢ææ–™',
                en: '<i class="fas fa-plus me-1"></i>Add Material'
            },
            updateMaterialButton: {
                zh: '<i class="fas fa-edit me-1"></i>æ›´æ–°ææ–™',
                en: '<i class="fas fa-edit me-1"></i>Update Material'
            },
            clearMaterialButton: {
                zh: '<i class="fas fa-times me-1"></i>æ¸…é™¤è¼¸å…¥',
                en: '<i class="fas fa-times me-1"></i>Clear Input'
            },
            calculateButton: {
                zh: '<i class="fas fa-calculator me-2"></i>è¨ˆç®—',
                en: '<i class="fas fa-calculator me-2"></i>Calculate'
            },
            resetButton: {
                zh: '<i class="fas fa-undo me-2"></i>é‡ç½®',
                en: '<i class="fas fa-undo me-2"></i>Reset'
            },
            printOptionsButton: {
                zh: '<i class="fas fa-print me-2"></i>åˆ—å°é¸é …',
                en: '<i class="fas fa-print me-2"></i>Print Options'
            },
            printButton: {
                zh: '<i class="fas fa-print me-2"></i>åˆ—å°å ±å‘Š',
                en: '<i class="fas fa-print me-2"></i>Print Report'
            },
            schemeTitle: {
                zh: "é¸æ“‡åˆ‡å‰²æ–¹æ¡ˆ:",
                en: "Select Cutting Scheme:"
            },
            resultTitle: {
                zh: "åˆ‡å‰²çµæœ",
                en: "Cutting Results"
            },
            colorLegendTitle: {
                zh: '<i class="fa-solid fa-palette me-2"></i>é¡è‰²åœ–ä¾‹',
                en: '<i class="fa-solid fa-palette me-2"></i>Color Legend'
            },
            cutLengthHint: {
                zh: "ä¾‹å¦‚ï¼š5 0 0",
                en: "e.g., 5 0 0"
            },
            cutQtyHint: {
                zh: "ä¾‹å¦‚ï¼š5",
                en: "e.g., 5"
            },
            cutPurposeHint: {
                zh: "ä¾‹å¦‚ï¼šé‚Šæ¡†",
                en: "e.g., Frame"
            },
            materialLengthHint: {
                zh: "ä¾‹å¦‚ï¼š5 0 0",
                en: "e.g., 5 0 0"
            },
            materialQtyHint: {
                zh: "ä¾‹å¦‚ï¼š10",
                en: "e.g., 10"
            },
            sawThicknessHint: {
                zh: "ä¾‹å¦‚: 3.2 (æ¯«ç±³) æˆ– 1/8 (åˆ†)",
                en: "e.g., 3.2 (mm) or 1/8 (eighth)"
            }
        };

        // æ›´æ–°èªè¨€
        function updateLanguage() {
            let lang = document.getElementById("language").value;
            document.body.classList.toggle("lang-en", lang === "en");
            document.body.classList.toggle("lang-zh", lang === "zh");

            // æ›´æ–°æ‰€æœ‰å…ƒç´ æ–‡æœ¬
            for (const [id, texts] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element && texts[lang]) {
                    if (id === "titleText") {
                        element.innerHTML = texts[lang];
                    } else {
                        element.innerHTML = texts[lang];
                    }
                }
            }

            // æ›´æ–°è¡¨å–®æ¨™ç±¤
            document.querySelectorAll(".cutLengthLabel").forEach(e => e.textContent = elements.cutLengthLabel[lang]);
            document.querySelectorAll(".cutQtyLabel").forEach(e => e.textContent = elements.cutQtyLabel[lang]);
            document.querySelectorAll(".cutPurposeLabel").forEach(e => e.textContent = elements.cutPurposeLabel[lang]);
            document.querySelectorAll(".materialLengthLabel").forEach(e => e.textContent = elements.materialLengthLabel[lang]);
            document.querySelectorAll(".materialQtyLabel").forEach(e => e.textContent = elements.materialQtyLabel[lang]);
            document.querySelectorAll("#addCuttingButton").forEach(e => e.innerHTML = elements.addCuttingButton[lang]);
            document.querySelectorAll("#updateCuttingButton").forEach(e => e.innerHTML = elements.updateCuttingButton[lang]);
            document.querySelectorAll("#clearCuttingButton").forEach(e => e.innerHTML = elements.clearCuttingButton[lang]);
            document.querySelectorAll("#addMaterialButton").forEach(e => e.innerHTML = elements.addMaterialButton[lang]);
            document.querySelectorAll("#updateMaterialButton").forEach(e => e.innerHTML = elements.updateMaterialButton[lang]);
            document.querySelectorAll("#clearMaterialButton").forEach(e => e.innerHTML = elements.clearMaterialButton[lang]);
            document.querySelectorAll(".cutLengthHint").forEach(e => e.textContent = elements.cutLengthHint[lang]);
            document.querySelectorAll(".cutQtyHint").forEach(e => e.textContent = elements.cutQtyHint[lang]);
            document.querySelectorAll(".cutPurposeHint").forEach(e => e.textContent = elements.cutPurposeHint[lang]);
            document.querySelectorAll(".materialLengthHint").forEach(e => e.textContent = elements.materialLengthHint[lang]);
            document.querySelectorAll(".materialQtyHint").forEach(e => e.textContent = elements.materialQtyHint[lang]);

            // æ›´æ–°é‹¸ç‰‡åšåº¦æç¤º
            document.getElementById("sawThicknessHint").textContent = elements.sawThicknessHint[lang];

            // æ›´æ–°æ¨¡æ…‹æ¡†æ¨™é¡Œ
            const modalTitles = {
                printOptionsModalLabel: lang === "zh" ? "åˆ—å°é¸é …" : "Print Options",
                saveSchemeModalLabel: lang === "zh" ? "å„²å­˜æ–¹æ¡ˆ" : "Save Scheme",
                loadSchemeModalLabel: lang === "zh" ? "è¼‰å…¥æ–¹æ¡ˆ" : "Load Scheme",
                helpModalLabel: lang === "zh" ? "ä½¿ç”¨èªªæ˜" : "User Guide"
            };

            for (const [id, text] of Object.entries(modalTitles)) {
                const element = document.getElementById(id);
                if (element) element.textContent = text;
            }

            updateInputLabels();
        }

        // æ›´æ–°è‹±åˆ¶æ¨™ç±¤
        function updateImperialLabels(template) {
            const hintLabels = template.querySelectorAll(".small-hint");
            if (hintLabels.length >= 3) {
                const lang = document.getElementById("language").value;
                if (lang === "zh") {
                    hintLabels[0].textContent = "å°º";
                    hintLabels[1].textContent = "å¯¸";
                    hintLabels[2].textContent = "åˆ†";
                } else {
                    hintLabels[0].textContent = "ft";
                    hintLabels[1].textContent = "in";
                    hintLabels[2].textContent = "eighth";
                }
            }
        }

        // æ›´æ–°å…¬åˆ¶æ¨™ç±¤
        function updateMetricLabels(template) {
            const hintLabels = template.querySelectorAll(".small-hint");
            if (hintLabels.length >= 3) {
                const lang = document.getElementById("language").value;
                if (lang === "zh") {
                    hintLabels[0].textContent = "ç±³";
                    hintLabels[1].textContent = "å˜ç±³";
                    hintLabels[2].textContent = "æ¯«ç±³";
                } else {
                    hintLabels[0].textContent = "m";
                    hintLabels[1].textContent = "cm";
                    hintLabels[2].textContent = "mm";
                }
            }
        }

        // æ›´æ–°è¼¸å…¥æ¨™ç±¤
        function updateInputLabels() {
            // Prefer settings unit (#unit); fallback to globalCutUnit
            const unitElem = document.getElementById("unit") || document.getElementById("globalCutUnit");
            const unit = unitElem ? unitElem.value : "metric";
            const lang = document.getElementById("language").value;

            const labels = {
                imperial: lang === "zh" ? ["å°º", "å¯¸", "åˆ†"] : ["ft", "in", "eighth"],
                imperial_decimal: lang === "zh" ? ["", "å¯¸", ""] : ["", "in", ""],
                metric: lang === "zh" ? ["ç±³", "å˜ç±³", "æ¯«ç±³"] : ["m", "cm", "mm"]
            };

            // æª¢æŸ¥æ˜¯å¦åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹
            const cuttingEditMode = document.querySelector("#cuttingItems .cutting-item.edit-mode");
            const materialEditMode = document.querySelector("#materialItems .material-item.edit-mode");

            // æ›´æ–°è¨­ç½®é é¢çš„å–®ä½é¸æ“‡å™¨æ¨£å¼
            const settingsUnitSelect = document.getElementById("unit");
            if (settingsUnitSelect) {
                settingsUnitSelect.classList.remove("metric-active", "imperial-active");
                if (settingsUnitSelect.value === "metric") {
                    settingsUnitSelect.classList.add("metric-active");
                } else {
                    settingsUnitSelect.classList.add("imperial-active");
                }
            }

            // æ›´æ–°é•·åº¦è¼¸å…¥æç¤ºï¼ˆåˆ‡å‰²èˆ‡ææ–™å–®ä½å„è‡ªç¨ç«‹ï¼‰
            document.querySelectorAll('.length-input-group').forEach(group => {
                if (group.closest('.edit-mode')) return; // ç·¨è¼¯ä¸­è·³é
                // åˆ¤æ–·æ‰€å±¬å€åŸŸï¼šåˆ‡å‰²æˆ–ææ–™
                let unitSelect = group.querySelector('.unit-select');
                if (!unitSelect) {
                    if (group.closest('#cuttingItems')) unitSelect = document.getElementById('globalCutUnit');
                    else if (group.closest('#materialItems')) unitSelect = document.getElementById('globalMaterialUnit');
                }
                const unitType = unitSelect ? unitSelect.value : 'metric';
                const hintLabels = labels[unitType] || labels.metric;
                group.querySelectorAll('.form-control').forEach((input, index) => {
                    const hint = input.nextElementSibling;
                    if (hint && hint.classList.contains('small-hint')) {
                        hint.textContent = hintLabels[index] || '';
                    }
                });
            });

            // æ›´æ–°é‹¸ç‰‡åšåº¦å–®ä½èˆ‡ç¯„ä¾‹
            const sawThicknessInput = document.getElementById("sawThickness");
            const sawThicknessUnit = document.getElementById("sawThicknessUnitLabel");
            if (unit === "imperial" || unit === "imperial_decimal") {
                // å–®ä½é¡¯ç¤ºã€Œåˆ†ã€ï¼ˆè‹±æ–‡ç‚º eighthï¼‰ï¼Œç¯„ä¾‹/placeholder é¡¯ç¤º 1/8
                if (SawThicknessUnit) {}
                sawThicknessUnit.textContent = lang === "zh" ? "åˆ†" : "eighth";
                sawThicknessInput.setAttribute("placeholder", "1/8");
                if (!sawThicknessInput.value || sawThicknessInput.value === "3.2") {
                    sawThicknessInput.value = "1/8";
                }
            } else {
                // å…¬åˆ¶é¡¯ç¤ºæ¯«ç±³ï¼Œç¯„ä¾‹/placeholder é¡¯ç¤º 3.2
                sawThicknessUnit.textContent = lang === "zh" ? "æ¯«ç±³" : "mm";
                sawThicknessInput.setAttribute("placeholder", "3.2");
                if (!sawThicknessInput.value || sawThicknessInput.value === "1/8") {
                    sawThicknessInput.value = "3.2";
                }
            }
        }

        // è§£æé‹¸ç‰‡åšåº¦
        function parseSawThickness() {
            const input = document.getElementById("sawThickness").value.trim();
            const errorElement = document.getElementById("sawThicknessError");
            const unitElem = document.getElementById("unit") || document.getElementById("globalCutUnit");
            const unit = unitElem ? unitElem.value : "metric";
            const lang = document.getElementById("language").value;

            if (!input) {
                errorElement.textContent = lang === "zh" ? "è«‹è¼¸å…¥é‹¸ç‰‡åšåº¦" : "Please enter saw thickness";
                errorElement.style.display = "block";
                document.getElementById("sawThickness").classList.add("is-invalid");
                return { value: 0, error: errorElement.textContent };
            }

            // è™•ç†åˆ†æ•¸æ ¼å¼ (å¦‚ 1/8)
            if (input.includes("/")) {
                const parts = input.split("/");
                if (parts.length === 2) {
                    const numerator = parseFloat(parts[0]);
                    const denominator = parseFloat(parts[1]);
                    if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                        const value = (numerator / denominator) * (unit === "imperial" ? EIGHTH_TO_MM : 1);
                        errorElement.textContent = "";
                        errorElement.style.display = "none";
                        document.getElementById("sawThickness").classList.remove("is-invalid");
                        return { value: value, error: "" };
                    }
                }
            }

            // è™•ç†å°æ•¸æ ¼å¼
            const value = parseFloat(input);
            if (isNaN(value) || value <= 0) {
                errorElement.textContent = lang === "zh" ? "è«‹è¼¸å…¥æœ‰æ•ˆçš„é‹¸ç‰‡åšåº¦" : "Please enter valid saw thickness";
                errorElement.style.display = "block";
                document.getElementById("sawThickness").classList.add("is-invalid");
                return { value: 0, error: errorElement.textContent };
            }

            const finalValue = unit === "imperial" ? value * EIGHTH_TO_MM : value;
            errorElement.textContent = "";
            errorElement.style.display = "none";
            document.getElementById("sawThickness").classList.remove("is-invalid");
            return { value: finalValue, error: "" };
        }

        // è§£æé•·åº¦
        function parseLength(lengthInputGroup) {
            // æ ¹æ“šæ‰€å±¬å€åŸŸä½¿ç”¨å°æ‡‰çš„å…¨åŸŸå–®ä½ï¼Œé¿å…äº’ç›¸å½±éŸ¿
            let unitSelect = lengthInputGroup.querySelector('.unit-select');
            if (!unitSelect) {
                if (lengthInputGroup.closest('#cuttingItems')) unitSelect = document.getElementById('globalCutUnit');
                else if (lengthInputGroup.closest('#materialItems')) unitSelect = document.getElementById('globalMaterialUnit');
            }
            const unit = unitSelect ? unitSelect.value : 'metric';
            const inputs = lengthInputGroup.querySelectorAll(".form-control");
            const lang = document.getElementById("language").value;

            let totalMM = 0;

            if (unit === "imperial") {
                const ft = parseFloat(inputs[0].value) || 0;
                const inch = parseFloat(inputs[1].value) || 0;
                const eighth = parseFloat(inputs[2].value) || 0;

                if (isNaN(ft) && isNaN(inch) && isNaN(eighth)) {
                    return { value: 0, error: lang === "zh" ? "é•·åº¦ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥" : "Invalid length, please check" };
                }

                totalMM = ft * FT_TO_MM + inch * INCH_TO_MM + eighth * (INCH_TO_MM / 8);
            } else {
                const m = parseFloat(inputs[0].value) || 0;
                const cm = parseFloat(inputs[1].value) || 0;
                const mm = parseFloat(inputs[2].value) || 0;

                if (isNaN(m) && isNaN(cm) && isNaN(mm)) {
                    return { value: 0, error: lang === "zh" ? "é•·åº¦ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥" : "Invalid length, please check" };
                }

                totalMM = m * M_TO_MM + cm * CM_TO_MM + mm;
            }

            if (totalMM < 0) {
                return { value: 0, error: lang === "zh" ? "é•·åº¦ä¸èƒ½ç‚ºè² " : "Length cannot be negative" };
            }

            return { value: totalMM, error: "" };
        }

        // é©—è­‰è¼¸å…¥
        function validateInput(inputGroup, errorElement) {
            const result = parseLength(inputGroup);
            if (result.error) {
                inputGroup.querySelectorAll(".form-control").forEach(input => input.classList.add("is-invalid"));
                errorElement.textContent = result.error;
                errorElement.style.display = "block";
            } else {
                inputGroup.querySelectorAll(".form-control").forEach(input => input.classList.remove("is-invalid"));
                errorElement.textContent = "";
                errorElement.style.display = "none";
            }
        }

        // æ ¼å¼åŒ–é•·åº¦é¡¯ç¤º
        function formatLengthForDisplay(mm, unit) {
            if (unit === "imperial_decimal") {
                return parseFloat((mm / 25.4).toFixed(3)) + '"';
            }

            if (unit === "imperial") {
                const totalInches = mm * MM_TO_INCH;
                const preciseInches = parseFloat(totalInches.toFixed(8));
                const feet = Math.floor(preciseInches / 12);
                const inches = Math.floor(preciseInches % 12);
                const eighths = Math.round((preciseInches % 1) * 8);

                let result = "";
                if (feet > 0) result += feet + " å°º ";
                if (inches > 0) result += inches + " å¯¸ ";
                if (eighths > 0) result += eighths + " åˆ†";

                return result.trim() || "0 å¯¸";
            }

            return mm.toFixed(2) + " mm";
        }

        // æ¸…é™¤åˆ‡å‰²é …ç›®è¼¸å…¥æ¬„
        function clearCuttingInputs() {
            const template = document.querySelector("#cuttingItems .cutting-item");
            template.querySelectorAll(".form-control").forEach(input => {
                if (!input.classList.contains("cutQty") && !input.classList.contains("cutPurpose")) {
                    input.value = "";
                }
            });
            template.querySelector(".cutQty").value = "0";
            template.querySelector(".cutPurpose").value = "";
            
            template.querySelector('[data-part="ft"]').focus();
        }

        // æ¸…é™¤ææ–™é …ç›®è¼¸å…¥æ¬„
        function clearMaterialInputs() {
            const template = document.querySelector("#materialItems .material-item");
            template.querySelectorAll(".form-control").forEach(input => {
                if (!input.classList.contains("materialQty")) {
                    input.value = "";
                }
            });
            template.querySelector(".materialQty").value = "1";
            
            template.querySelector('[data-part="ft"]').focus();
        }

        // é€²å…¥åˆ‡å‰²é …ç›®ç·¨è¼¯æ¨¡å¼
        function enterCuttingEditMode(index) {
            const row = document.querySelectorAll("#cuttingItemsTable tbody tr")[index];
            if (!row) return;
            
            const template = document.querySelector("#cuttingItems .cutting-item");
            const unit = row.dataset.inputUnit || "metric";
            const lengthMM = parseFloat(row.dataset.length);
            
            // è¨­ç½®è¼¸å…¥æ¬„å–®ä½
            const unitSelect = template.querySelector(".unit-select");
            unitSelect.value = unit;
            
            // ç§»é™¤å’Œæ·»åŠ å–®ä½æ¨£å¼é¡
            unitSelect.classList.remove("metric-active", "imperial-active");
            if (unit === "metric") {
                unitSelect.classList.add("metric-active");
            } else {
                unitSelect.classList.add("imperial-active");
            }
            
            // æ ¹æ“šå–®ä½è¨­ç½®è¼¸å…¥å€¼
            if (unit === "imperial") {
                const totalInches = lengthMM * MM_TO_INCH;
                const feet = Math.floor(totalInches / 12);
                const inches = Math.floor(totalInches % 12);
                const eighths = Math.round((totalInches % 1) * 8);
                
                template.querySelector('[data-part="ft"]').value = feet;
                template.querySelector('[data-part="in"]').value = inches;
                template.querySelector('[data-part="eighth"]').value = eighths;
                
                // ç«‹å³æ›´æ–°è‹±åˆ¶æ¨™ç±¤
                updateImperialLabels(template);
                
            } else {
                const meters = Math.floor(lengthMM / 1000);
                const cm = Math.floor((lengthMM % 1000) / 10);
                const mm = Math.round(lengthMM % 10);
                
                template.querySelector('[data-part="ft"]').value = meters;
                template.querySelector('[data-part="in"]').value = cm;
                template.querySelector('[data-part="eighth"]').value = mm;
                
                // ç«‹å³æ›´æ–°å…¬åˆ¶æ¨™ç±¤
                updateMetricLabels(template);
            }
            
            template.querySelector(".cutQty").value = row.dataset.quantity;
            template.querySelector(".cutPurpose").value = row.dataset.purpose || "";
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById("addCuttingButton").style.display = "none";
            document.getElementById("updateCuttingButton").style.display = "inline-block";
            
            // è¨­ç½®ç·¨è¼¯æ¨¡å¼æ¨£å¼
            template.classList.add("edit-mode");
            row.classList.add("table-row-edit");
            
            // æ›´æ–°å…¨å±€è®Šé‡
            editingCuttingIndex = index;
            document.getElementById("editingCuttingIndex").value = index;
            
            template.querySelector('[data-part="ft"]').focus();
        }

        // é€€å‡ºåˆ‡å‰²é …ç›®ç·¨è¼¯æ¨¡å¼
        function exitCuttingEditMode() {
            const template = document.querySelector("#cuttingItems .cutting-item");
            
            // ç§»é™¤ç·¨è¼¯æ¨¡å¼æ¨£å¼
            template.classList.remove("edit-mode");
            document.querySelectorAll("#cuttingItemsTable tbody tr").forEach(row => {
                row.classList.remove("table-row-edit");
            });
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById("addCuttingButton").style.display = "inline-block";
            document.getElementById("updateCuttingButton").style.display = "none";
            
            // é‡ç½®å…¨å±€è®Šé‡
            editingCuttingIndex = -1;
            document.getElementById("editingCuttingIndex").value = "-1";
            
            // æ¸…é™¤è¼¸å…¥ï¼ˆæ›´æ–°å¾Œæ‡‰è©²æ­¸é›¶ï¼‰
            clearCuttingInputs();
            
            // æ¢å¾©è¼¸å…¥æ¬„çš„å–®ä½é¡¯ç¤º
            updateInputLabels();
        }

        // é€²å…¥ææ–™é …ç›®ç·¨è¼¯æ¨¡å¼
        function enterMaterialEditMode(index) {
            const row = document.querySelectorAll("#materialItemsTable tbody tr")[index];
            if (!row) return;
            
            const template = document.querySelector("#materialItems .material-item");
            const unit = row.dataset.inputUnit || "metric";
            const lengthMM = parseFloat(row.dataset.length);
            
            // è¨­ç½®è¼¸å…¥æ¬„å–®ä½
            const unitSelect = template.querySelector(".unit-select");
            unitSelect.value = unit;
            
            // ç§»é™¤å’Œæ·»åŠ å–®ä½æ¨£å¼é¡
            unitSelect.classList.remove("metric-active", "imperial-active");
            if (unit === "metric") {
                unitSelect.classList.add("metric-active");
            } else {
                unitSelect.classList.add("imperial-active");
            }
            
            // æ ¹æ“šå–®ä½è¨­ç½®è¼¸å…¥å€¼
            if (unit === "imperial") {
                const totalInches = lengthMM * MM_TO_INCH;
                const feet = Math.floor(totalInches / 12);
                const inches = Math.floor(totalInches % 12);
                const eighths = Math.round((totalInches % 1) * 8);
                
                template.querySelector('[data-part="ft"]').value = feet;
                template.querySelector('[data-part="in"]').value = inches;
                template.querySelector('[data-part="eighth"]').value = eighths;
                
                // ç«‹å³æ›´æ–°è‹±åˆ¶æ¨™ç±¤
                updateImperialLabels(template);
                
            } else {
                const meters = Math.floor(lengthMM / 1000);
                const cm = Math.floor((lengthMM % 1000) / 10);
                const mm = Math.round(lengthMM % 10);
                
                template.querySelector('[data-part="ft"]').value = meters;
                template.querySelector('[data-part="in"]').value = cm;
                template.querySelector('[data-part="eighth"]').value = mm;
                
                // ç«‹å³æ›´æ–°å…¬åˆ¶æ¨™ç±¤
                updateMetricLabels(template);
            }
            
            template.querySelector(".materialQty").value = row.dataset.quantity;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById("addMaterialButton").style.display = "none";
            document.getElementById("updateMaterialButton").style.display = "inline-block";
            
            // è¨­ç½®ç·¨è¼¯æ¨¡å¼æ¨£å¼
            template.classList.add("edit-mode");
            row.classList.add("table-row-edit");
            
            // æ›´æ–°å…¨å±€è®Šé‡
            editingMaterialIndex = index;
            document.getElementById("editingMaterialIndex").value = index;
            
            template.querySelector('[data-part="ft"]').focus();
        }

        // é€€å‡ºææ–™é …ç›®ç·¨è¼¯æ¨¡å¼
        function exitMaterialEditMode() {
            const template = document.querySelector("#materialItems .material-item");
            
            // ç§»é™¤ç·¨è¼¯æ¨¡å¼æ¨£å¼
            template.classList.remove("edit-mode");
            document.querySelectorAll("#materialItemsTable tbody tr").forEach(row => {
                row.classList.remove("table-row-edit");
            });
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById("addMaterialButton").style.display = "inline-block";
            document.getElementById("updateMaterialButton").style.display = "none";
            
            // é‡ç½®å…¨å±€è®Šé‡
            editingMaterialIndex = -1;
            document.getElementById("editingMaterialIndex").value = "-1";
            
            // æ¸…é™¤è¼¸å…¥ï¼ˆæ›´æ–°å¾Œæ‡‰è©²æ­¸é›¶ï¼‰
            clearMaterialInputs();
            
            // æ¢å¾©è¼¸å…¥æ¬„çš„å–®ä½é¡¯ç¤º
            updateInputLabels();
        }

        // æ·»åŠ åˆ‡å‰²é …ç›®
        function addCuttingItem() {
            const template = document.querySelector("#cuttingItems .cutting-item");
            const lengthResult = parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é•·åº¦");
                return;
            }

            const quantity = parseInt(template.querySelector(".cutQty").value) || 0;
            if (quantity <= 0) {
                alert("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                return;
            }

            const purpose = template.querySelector(".cutPurpose").value || "";
            const unit = template.querySelector(".unit-select").value;

            // ç²å–è¼¸å…¥å€¼
            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            // ç”Ÿæˆé¡¯ç¤ºå­—ç¬¦ä¸²
            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "å°º " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "å¯¸ " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "åˆ†" : "");
                display = display.trim() || "0å¯¸";
            }

            // æ·»åŠ åˆ°è¡¨æ ¼
            const tbody = document.querySelector("#cuttingItemsTable tbody");
            const row = document.createElement("tr");

            row.dataset.length = lengthResult.value;
            row.dataset.quantity = quantity;
            row.dataset.purpose = purpose;
            row.dataset.display = display;
            row.dataset.inputUnit = unit;

            const rowIndex = tbody.children.length;
            
            row.innerHTML = `
                <td>${escapeHTML(display)}</td>
                <td>${quantity}</td>
                <td>${escapeHTML(purpose || "-")}</td>
                <td class="text-center">
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-warning" onclick="enterCuttingEditMode(${rowIndex})" title="ç·¨è¼¯">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitCuttingEditMode();" title="åˆªé™¤">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);

            // æ¸…ç©ºè¼¸å…¥æ¡†ï¼ˆæ­¸é›¶ï¼‰
            clearCuttingInputs();
        }

        // æ›´æ–°åˆ‡å‰²é …ç›® - ä¿®æ”¹å¾Œè‡ªå‹•æ­¸é›¶
        function updateCuttingItem() {
            if (editingCuttingIndex === -1) {
                alert("æ²’æœ‰é¸ä¸­è¦ç·¨è¼¯çš„é …ç›®");
                return;
            }

            const template = document.querySelector("#cuttingItems .cutting-item");
            const lengthResult = parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é•·åº¦");
                return;
            }

            const quantity = parseInt(template.querySelector(".cutQty").value) || 0;
            if (quantity <= 0) {
                alert("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                return;
            }

            const purpose = template.querySelector(".cutPurpose").value || "";
            const unit = template.querySelector(".unit-select").value;

            // ç²å–è¼¸å…¥å€¼
            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            // ç”Ÿæˆé¡¯ç¤ºå­—ç¬¦ä¸²
            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "å°º " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "å¯¸ " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "åˆ†" : "");
                display = display.trim() || "0å¯¸";
            }

            // æ›´æ–°è¡¨æ ¼è¡Œ
            const row = document.querySelectorAll("#cuttingItemsTable tbody tr")[editingCuttingIndex];
            if (row) {
                row.dataset.length = lengthResult.value;
                row.dataset.quantity = quantity;
                row.dataset.purpose = purpose;
                row.dataset.display = display;
                row.dataset.inputUnit = unit;

                row.innerHTML = `
                    <td>${display}</td>
                    <td>${quantity}</td>
                    <td>${purpose || "-"}</td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-warning" onclick="enterCuttingEditMode(${editingCuttingIndex})" title="ç·¨è¼¯">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitCuttingEditMode();" title="åˆªé™¤">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
            }

            // é€€å‡ºç·¨è¼¯æ¨¡å¼ä¸¦æ¸…ç©ºè¼¸å…¥æ¬„ï¼ˆæ­¸é›¶ï¼‰
            exitCuttingEditMode();
        }

        // æ·»åŠ ææ–™é …ç›®
        function addMaterialItem() {
            const template = document.querySelector("#materialItems .material-item");
            const lengthResult = parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ææ–™é•·åº¦");
                return;
            }

            const quantity = parseInt(template.querySelector(".materialQty").value) || 0;
            if (quantity <= 0) {
                alert("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                return;
            }

            const unit = template.querySelector(".unit-select").value;

            // ç²å–è¼¸å…¥å€¼
            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            // ç”Ÿæˆé¡¯ç¤ºå­—ç¬¦ä¸²
            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "å°º " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "å¯¸ " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "åˆ†" : "");
                display = display.trim() || "0å¯¸";
            }

            // æ·»åŠ åˆ°è¡¨æ ¼
            const tbody = document.querySelector("#materialItemsTable tbody");
            const row = document.createElement("tr");

            row.dataset.length = lengthResult.value;
            row.dataset.quantity = quantity;
            row.dataset.display = display;
            row.dataset.inputUnit = unit;

            const rowIndex = tbody.children.length;
            
            row.innerHTML = `
                <td>${display}</td>
                <td>${quantity}</td>
                <td class="text-center">
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-warning" onclick="enterMaterialEditMode(${rowIndex})" title="ç·¨è¼¯">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitMaterialEditMode();" title="åˆªé™¤">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);

            // æ¸…ç©ºè¼¸å…¥æ¡†ï¼ˆæ­¸é›¶ï¼‰
            clearMaterialInputs();
        }

        // æ›´æ–°ææ–™é …ç›® - ä¿®æ”¹å¾Œè‡ªå‹•æ­¸é›¶
        function updateMaterialItem() {
            if (editingMaterialIndex === -1) {
                alert("æ²’æœ‰é¸ä¸­è¦ç·¨è¼¯çš„é …ç›®");
                return;
            }

            const template = document.querySelector("#materialItems .material-item");
            const lengthResult = parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ææ–™é•·åº¦");
                return;
            }

            const quantity = parseInt(template.querySelector(".materialQty").value) || 0;
            if (quantity <= 0) {
                alert("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                return;
            }

            const unit = template.querySelector(".unit-select").value;

            // ç²å–è¼¸å…¥å€¼
            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            // ç”Ÿæˆé¡¯ç¤ºå­—ç¬¦ä¸²
            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "å°º " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "å¯¸ " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "åˆ†" : "");
                display = display.trim() || "0å¯¸";
            }

            // æ›´æ–°è¡¨æ ¼è¡Œ
            const row = document.querySelectorAll("#materialItemsTable tbody tr")[editingMaterialIndex];
            if (row) {
                row.dataset.length = lengthResult.value;
                row.dataset.quantity = quantity;
                row.dataset.display = display;
                row.dataset.inputUnit = unit;

                row.innerHTML = `
                    <td>${display}</td>
                    <td>${quantity}</td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-warning" onclick="enterMaterialEditMode(${editingMaterialIndex})" title="ç·¨è¼¯">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitMaterialEditMode();" title="åˆªé™¤">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
            }

            // é€€å‡ºç·¨è¼¯æ¨¡å¼ä¸¦æ¸…ç©ºè¼¸å…¥æ¬„ï¼ˆæ­¸é›¶ï¼‰
            exitMaterialEditMode();
        }

        // ç²å–åˆ‡å‰²é …ç›®
        function getCuttingItems() {
            let items = [];
            document.querySelectorAll("#cuttingItemsTable tbody tr").forEach(row => {
                const length = parseFloat(row.dataset.length) || 0;
                const quantity = parseInt(row.dataset.quantity) || 0;
                const purpose = row.dataset.purpose || "";
                const display = row.dataset.display || "";

                if (length > 0 && quantity > 0) {
                    items.push({
                        length: length,
                        quantity: quantity,
                        purpose: purpose,
                        display: display
                    });
                }
            });
            return items;
        }

        // ç²å–ææ–™é …ç›®
        function getMaterialItems() {
            let items = [];
            document.querySelectorAll("#materialItemsTable tbody tr").forEach(row => {
                const length = parseFloat(row.dataset.length) || 0;
                const quantity = parseInt(row.dataset.quantity) || 0;
                const display = row.dataset.display || "";

                if (length > 0 && quantity > 0) {
                    items.push({
                        length: length,
                        quantity: quantity,
                        display: display
                    });
                }
            });
            return items;
        }

        // å„ªåŒ–ç®—æ³• - FFD
        function optimizeCutsFFD(cuts, materials, sawThickness, algorithm) {
            let allCuts = [];
            cuts.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    allCuts.push({
                        length: item.length,
                        purpose: item.purpose,
                        display: item.display || ""
                    });
                }
            });

            allCuts.sort((a, b) => b.length - a.length);

            let bins = [];
            let availableMaterials = materials.flatMap(item =>
                Array(item.quantity).fill(item.length)
            ).sort((a, b) => b - a);

            const defaultLength = materials.length > 0 ?
                materials.reduce((max, item) => Math.max(max, item.length || 0), 0) : 6000;

            allCuts.forEach(cut => {
                let placed = false;

                for (let i = 0; i < bins.length; i++) {
                    const bin = bins[i];
                    const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
                    const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;

                    if (usedLength + kerfLength + cut.length + (bin.cuts.length > 0 ? sawThickness : 0) <= bin.length) {
                        bin.cuts.push(cut);
                        placed = true;
                        break;
                    }
                }

                if (!placed) {
                    let binLength;
                    if (availableMaterials.length > 0) {
                        binLength = availableMaterials.shift();
                    } else {
                        binLength = defaultLength;
                    }

                    bins.push({
                        length: binLength,
                        cuts: [cut],
                        autoAdded: availableMaterials.length === 0 && materials.length === 0
                    });
                }
            });

            return bins;
        }

        // å„ªåŒ–ç®—æ³• - BFD
        function optimizeCutsBFD(cuts, materials, sawThickness, algorithm) {
            let allCuts = [];
            cuts.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    allCuts.push({
                        length: item.length,
                        purpose: item.purpose,
                        display: item.display || ""
                    });
                }
            });

            allCuts.sort((a, b) => b.length - a.length);

            let bins = [];
            let availableMaterials = materials.flatMap(item =>
                Array(item.quantity).fill(item.length)
            ).sort((a, b) => b - a);

            const defaultLength = materials.length > 0 ?
                materials.reduce((max, item) => Math.max(max, item.length || 0), 0) : 6000;

            allCuts.forEach(cut => {
                let bestBin = null;
                let bestRemaining = Infinity;

                for (let i = 0; i < bins.length; i++) {
                    const bin = bins[i];
                    const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
                    const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                    const required = cut.length + (bin.cuts.length > 0 ? sawThickness : 0);
                    const remaining = bin.length - (usedLength + kerfLength + required);

                    if (remaining >= 0 && remaining < bestRemaining) {
                        bestRemaining = remaining;
                        bestBin = bin;
                    }
                }

                if (bestBin) {
                    bestBin.cuts.push(cut);
                } else {
                    let binLength;
                    if (availableMaterials.length > 0) {
                        binLength = availableMaterials.shift();
                    } else {
                        binLength = defaultLength;
                    }

                    bins.push({
                        length: binLength,
                        cuts: [cut],
                        autoAdded: availableMaterials.length === 0 && materials.length === 0
                    });
                }
            });

            return bins;
        }

        // å„ªåŒ–ç®—æ³• - æ™ºèƒ½å„ªåŒ–
        function optimizeCutsSizeGrouping(cuts, materials, sawThickness, algorithm) {
            let allCuts = [];
            cuts.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    allCuts.push({
                        length: item.length,
                        purpose: item.purpose,
                        display: item.display || ""
                    });
                }
            });

            let lengthGroups = {};
            allCuts.forEach(cut => {
                if (!lengthGroups[cut.length]) {
                    lengthGroups[cut.length] = [];
                }
                lengthGroups[cut.length].push(cut);
            });

            const sortedLengths = Object.keys(lengthGroups).map(Number).sort((a, b) => b - a);

            let bins = [];
            let availableMaterials = materials.flatMap(item =>
                Array(item.quantity).fill(item.length)
            ).sort((a, b) => b - a);

            const defaultLength = materials.length > 0 ?
                materials.reduce((max, item) => Math.max(max, item.length || 0), 0) : 6000;

            sortedLengths.forEach(length => {
                let groupCuts = lengthGroups[length];

                while (groupCuts.length > 0) {
                    let bestBin = null;
                    let bestCount = 0;

                    for (let i = 0; i < bins.length; i++) {
                        const bin = bins[i];
                        const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
                        const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;

                        let count = 0;
                        let currentLength = usedLength + kerfLength;

                        for (let j = 0; j < groupCuts.length; j++) {
                            const required = length + (bin.cuts.length + count > 0 ? sawThickness : 0);
                            if (currentLength + required <= bin.length) {
                                count++;
                                currentLength += required;
                            } else {
                                break;
                            }
                        }

                        if (count > bestCount) {
                            bestCount = count;
                            bestBin = bin;
                        }
                    }

                    if (bestBin && bestCount > 0) {
                        for (let i = 0; i < bestCount; i++) {
                            bestBin.cuts.push(groupCuts.shift());
                        }
                    } else {
                        let binLength;
                        if (availableMaterials.length > 0) {
                            binLength = availableMaterials.shift();
                        } else {
                            binLength = defaultLength;
                        }

                        const newBin = {
                            length: binLength,
                            cuts: []
                        };

                        let placedCount = 0;
                        let currentLength = 0;

                        while (groupCuts.length > 0) {
                            const required = length + (newBin.cuts.length > 0 ? sawThickness : 0);
                            if (currentLength + required <= binLength) {
                                newBin.cuts.push(groupCuts.shift());
                                currentLength += required;
                                placedCount++;
                            } else {
                                break;
                            }
                        }

                        if (placedCount > 0) {
                            bins.push(newBin);
                        } else {
                            bins.push({
                                length: binLength,
                                cuts: [groupCuts.shift()],
                                autoAdded: availableMaterials.length === 0 && materials.length === 0
                            });
                        }
                    }
                }
            });

            return bins;
        }

        // è¨ˆç®—
        function calculate() {
            try {
                const cuttingItems = getCuttingItems();
                const materialItems = getMaterialItems();
                const sawThickness = parseSawThickness();

                if (cuttingItems.length === 0) {
                    alert("è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹åˆ‡å‰²é …ç›®");
                    return;
                }

                if (materialItems.length === 0) {
                    alert("è«‹è¼¸å…¥è‡³å°‘ä¸€ç¨®ææ–™");
                    return;
                }

                if (sawThickness.error) {
                    alert(sawThickness.error);
                    return;
                }

                const algorithm = document.getElementById("algorithmSelector").value || "BFD";
                let optimizedResult;

                // ===== AutoBest: åŒæ™‚è¨ˆç®—ä¸‰ç®—æ³•ï¼Œé¸æ“‡ç¸½é¤˜æ–™æœ€å°‘è€… =====
                if (algorithm === 'AutoBest') {
                    const resFFD = optimizeCutsFFD(cuttingItems, materialItems, sawThickness.value, 'FFD');
                    const resBFD = optimizeCutsBFD(cuttingItems, materialItems, sawThickness.value, 'BFD');
                    const resSG  = optimizeCutsSizeGrouping(cuttingItems, materialItems, sawThickness.value, 'SizeGrouping');

                    const st = Number(sawThickness.value) || 0;
                    function evaluate(bins) {
                        let totalWaste = 0;
                        let usedBars = 0;
                        bins.forEach(bin => {
                            if (!bin) return;
                            usedBars++;
                            const usedLength = (bin.cuts || []).reduce((sum, c) => sum + (Number(c.length) || 0), 0);
                            const kerfLength = (bin.cuts && bin.cuts.length > 0) ? (bin.cuts.length - 1) * st : 0;
                            const waste = (Number(bin.length) || 0) - (usedLength + kerfLength);
                            totalWaste += Math.max(0, waste);
                        });
                        return { totalWaste, usedBars };
                    }

                    const scoreFFD = evaluate(resFFD);
                    const scoreBFD = evaluate(resBFD);
                    const scoreSG  = evaluate(resSG);

                    function better(a, b) {
                        if (a.totalWaste !== b.totalWaste) return a.totalWaste < b.totalWaste;
                        return a.usedBars < b.usedBars;
                    }

                    let bestAlgo = 'FFD';
                    let bestRes = resFFD;
                    let bestScore = scoreFFD;
                    if (better(scoreBFD, bestScore)) { bestAlgo = 'BFD'; bestRes = resBFD; bestScore = scoreBFD; }
                    if (better(scoreSG,  bestScore)) { bestAlgo = 'SizeGrouping'; bestRes = resSG;  bestScore = scoreSG;  }

                    optimizedResult = bestRes;

                    const resultDetails = document.getElementById('resultDetails');
                    if (resultDetails) {
                        const banner = document.createElement('div');
                        banner.style.margin = '12px 0';
                        banner.style.padding = '10px';
                        banner.style.backgroundColor = '#e8f5e9';
                        banner.style.border = '1px solid #c8e6c9';
                        banner.style.borderRadius = '6px';
                        banner.style.color = '#2e7d32';
                        banner.innerHTML = `<strong>è‡ªå‹•æœ€æ…³æ–™</strong> å·²é¸æ“‡ï¼š<code>${bestAlgo}</code>ï½œç¸½é¤˜æ–™ï¼š<code>${bestScore.totalWaste.toFixed(3)}</code>ï½œç”¨æ–™æ”¯æ•¸ï¼š<code>${bestScore.usedBars}</code>`;
                        resultDetails.prepend(banner);
                    }
                } else {

                switch (algorithm) {
                    case "FFD":
                        optimizedResult = optimizeCutsFFD(cuttingItems, materialItems, sawThickness.value, algorithm);
                        break;
                    case "SizeGrouping":
                        optimizedResult = optimizeCutsSizeGrouping(cuttingItems, materialItems, sawThickness.value, algorithm);
                        break;
                    case "BFD":
                    default:
                        optimizedResult = optimizeCutsBFD(cuttingItems, materialItems, sawThickness.value, algorithm);
                        break;
                }

                }

                renderCuttingResults(optimizedResult, sawThickness.value);

                const resultsCard = document.getElementById("results-card");
                if (resultsCard) {
                    resultsCard.style.display = "block";
                    resultsCard.scrollIntoView({ behavior: "smooth" });
                }

                console.log("è¨ˆç®—å®Œæˆ:", optimizedResult);

            } catch (error) {
                console.error("è¨ˆç®—å‡ºéŒ¯:", error);
                alert("è¨ˆç®—éç¨‹å‡ºéŒ¯ï¼š" + error.message);
            }
        }

        // æ¸²æŸ“åˆ‡å‰²çµæœ
        function renderCuttingResults(bins, sawThickness) {
            const unit = document.getElementById("unit").value;

            // æ”¶é›†æ‰€æœ‰ç¨ç‰¹çš„é•·åº¦
            let uniqueLengths = [];
            bins.forEach(bin => {
                bin.cuts.forEach(cut => {
                    const roundedLength = Math.round(cut.length * 10) / 10;
                    if (!uniqueLengths.includes(roundedLength)) {
                        uniqueLengths.push(roundedLength);
                    }
                });
            });

            uniqueLengths.sort((a, b) => b - a);

            // åˆ†é…é¡è‰²å’Œæ¨™ç±¤
            const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#98D8C8", "#F7DC6F", "#BB8FCE", "#85C1E2"];
            const lengthColorMap = {};
            const lengthLabelMap = {};

            uniqueLengths.forEach((length, index) => {
                lengthColorMap[length] = colors[index % colors.length];
                lengthLabelMap[length] = String.fromCharCode(65 + index);
            });

            // é¡¯ç¤ºçµæœ
            const resultDetails = document.getElementById("resultDetails");
            resultDetails.style.display = "block";

            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalBins = bins.length;
            const totalUsedLength = bins.reduce((sum, bin) => {
                return sum + bin.cuts.reduce((cutSum, cut) => cutSum + cut.length, 0);
            }, 0);

            const totalMaterialLength = bins.reduce((sum, bin) => sum + bin.length, 0);
            const totalWaste = bins.reduce((sum, bin) => {
                const usedLength = bin.cuts.reduce((cutSum, cut) => cutSum + cut.length, 0);
                const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                return sum + (bin.length - usedLength - kerfLength);
            }, 0);

            const utilizationRate = ((totalUsedLength / totalMaterialLength) * 100).toFixed(1);

            // ç”ŸæˆHTML
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 10px 0; color: #1b5e20;">ğŸ“Š å„ªåŒ–æ‘˜è¦</h4>
                    <div style="display: flex; justify-content: space-around; font-size: 14px;">
                        <div>
                            <strong>æ‰€éœ€æ”¯æ•¸</strong><br>
                            <span style="color: #d32f2f; font-size: 24px; font-weight: bold;">${totalBins}</span>
                        </div>
                        <div>
                            <strong>åˆ©ç”¨ç‡</strong><br>
                            <span style="color: #388e3c; font-size: 24px; font-weight: bold;">${utilizationRate}%</span>
                        </div>
                        <div>
                            <strong>ç¸½é¤˜æ–™</strong><br>
                            <span style="color: #f57c00; font-size: 16px;">${formatLengthForDisplay(totalWaste, unit)}</span>
                        </div>
                    </div>
                </div>
            `;

            // ç”Ÿæˆæ¯å€‹åŸæ–™çš„è©³ç´°ä¿¡æ¯
            bins.forEach((bin, binIndex) => {
                const usedLength = bin.cuts.reduce((sum, cut) => sum + cut.length, 0);
                const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                const waste = bin.length - usedLength - kerfLength;
                const wastePercentage = ((waste / bin.length) * 100).toFixed(1);

                html += `
                    <div style="margin-bottom: 15px; border: 1px solid #ccc; padding: 12px; border-radius: 6px; background: #f9f9f9;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
                            åŸæ–™ #${binIndex + 1} - ${formatLengthForDisplay(bin.length, unit)}
                            ${bin.autoAdded ? ' <span style="color: #f57c00; font-size: 0.9em;">[è‡ªå‹•æ·»åŠ ]</span>' : ''}
                        </div>
                        <div style="display: flex; height: 50px; border: 1px solid #000; border-radius: 4px; overflow: hidden; margin-bottom: 8px; background: white;">
                `;

                // æ·»åŠ åˆ‡å‰²ä»¶
                bin.cuts.forEach((cut, cutIndex) => {
                    const roundedLength = Math.round(cut.length * 10) / 10;
                    const percentage = (cut.length / bin.length) * 100;
                    const color = lengthColorMap[roundedLength];
                    const label = lengthLabelMap[roundedLength];

                    html += `
                        <div style="width: ${percentage.toFixed(1)}%; background: ${color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; padding: 0 4px; text-align: center; border-right: 1px solid #000;" 
                             title="${formatLengthForDisplay(cut.length, unit)}">
                            ${label}
                        </div>
                    `;
                });

                // æ·»åŠ é¤˜æ–™
                if (waste > 0) {
                    const wastePercentageVisual = (waste / bin.length) * 100;
                    html += `
                        <div style="width: ${wastePercentageVisual.toFixed(1)}%; background: repeating-linear-gradient(45deg, #ffcccc 0px, #ffcccc 5px, #ff9999 5px, #ff9999 10px); display: flex; align-items: center; justify-content: center; color: #a00; font-weight: bold; font-size: 11px; padding: 0 4px;">
                            é¤˜æ–™
                        </div>
                    `;
                }

                html += `
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            <strong>ä½¿ç”¨é•·åº¦ï¼š</strong> ${formatLengthForDisplay(usedLength + kerfLength, unit)} | 
                            <strong>é¤˜æ–™ï¼š</strong> ${formatLengthForDisplay(waste, unit)} (${wastePercentage}%)
                        </div>
                        <div style="font-size: 11px; color: #999;">
                            <strong>åˆ‡å‰²é †åºï¼š</strong> 
                            ${bin.cuts.map(cut => formatLengthForDisplay(Math.round(cut.length * 10) / 10, unit)).join(" â†’ ")}
                        </div>
                    </div>
                `;
            });

            resultDetails.innerHTML = html;

            // ç”Ÿæˆé¡è‰²åœ–ä¾‹
            let legendHtml = `
                <div style="margin-top: 20px; padding: 15px; background: white; border: 1px solid #000; border-radius: 6px;">
                    <h5 style="margin: 0 0 12px 0; color: #000; font-size: 16px;">ğŸ“‹ åˆ‡å‰²ä»¶å°ºå¯¸åœ–ä¾‹</h5>
                    <div style="display: grid; gap: 8px;">
            `;

            uniqueLengths.forEach(length => {
                legendHtml += `
                    <div style="display: flex; align-items: center; padding: 6px; background: #f0f0f0; border-radius: 4px;">
                        <div style="width: 20px; height: 20px; background: ${lengthColorMap[length]}; border: 1px solid #000; margin-right: 10px;"></div>
                        <strong style="color: #000; min-width: 25px;">${lengthLabelMap[length]}</strong>
                        <span style="color: #000; margin-left: 10px;">${formatLengthForDisplay(length, unit)}</span>
                    </div>
                `;
            });

            legendHtml += `
                    </div>
                </div>
            `;

            document.getElementById("colorLegendItems").innerHTML = legendHtml;
            document.getElementById("colorLegend").style.display = "block";
            document.getElementById("printOptionsButton").style.display = "inline-block";
            document.getElementById("printButton").style.display = "inline-block";
        }

        // ä¿å­˜æ–¹æ¡ˆ
        function saveScheme() {
            const cuttingRows = document.querySelectorAll("#cuttingItemsTable tbody tr").length;
            const materialRows = document.querySelectorAll("#materialItemsTable tbody tr").length;

            if (cuttingRows === 0 && materialRows === 0) {
                const lang = document.getElementById("language").value;
                alert(lang === "zh" ?
                    "æ²’æœ‰å¯ä¿å­˜çš„æ•¸æ“šï¼Œè«‹å…ˆè¼¸å…¥åˆ‡å‰²é …ç›®å’Œææ–™" :
                    "No data to save. Please enter cutting items and materials first.");
                return;
            }

            const now = new Date();
            const defaultName = now.getFullYear() + "-" +
                String(now.getMonth() + 1).padStart(2, "0") + "-" +
                String(now.getDate()).padStart(2, "0") + " " +
                String(now.getHours()).padStart(2, "0") + ":" +
                String(now.getMinutes()).padStart(2, "0");

            const nameInput = document.getElementById("schemeName");
            if (nameInput) {
                nameInput.value = defaultName;
            }

            new bootstrap.Modal(document.getElementById("saveSchemeModal")).show();
        }

        // ç¢ºèªä¿å­˜æ–¹æ¡ˆ
        function confirmSaveScheme() {
            const schemeName = document.getElementById("schemeName").value.trim();
            const lang = document.getElementById("language").value;

            if (!schemeName) {
                alert(lang === "zh" ? "è«‹è¼¸å…¥æ–¹æ¡ˆåç¨±" : "Please enter scheme name");
                return;
            }

            // ç²å–åˆ‡å‰²é …ç›®ï¼ˆåŒ…å«å–®ä½ï¼‰
            const cuttingItems = [];
            document.querySelectorAll("#cuttingItemsTable tbody tr").forEach(row => {
                cuttingItems.push({
                    length: row.dataset.length || "0",
                    quantity: row.dataset.quantity || "1",
                    purpose: row.dataset.purpose || "",
                    display: row.dataset.display || "",
                    inputUnit: row.dataset.inputUnit || "metric"
                });
            });

            // ç²å–ææ–™é …ç›®ï¼ˆåŒ…å«å–®ä½ï¼‰
            const materials = [];
            document.querySelectorAll("#materialItemsTable tbody tr").forEach(row => {
                materials.push({
                    length: row.dataset.length || "0",
                    quantity: row.dataset.quantity || "1",
                    display: row.dataset.display || "",
                    inputUnit: row.dataset.inputUnit || "metric"
                });
            });

            // ç²å–è¼¸å…¥éƒ¨åˆ†çš„ç•¶å‰å–®ä½
            const cuttingInputUnit = document.querySelector("#cuttingItems .unit-select")?.value || "metric";
            const materialInputUnit = document.querySelector("#materialItems .unit-select")?.value || "metric";

            // å‰µå»ºæ–¹æ¡ˆæ•¸æ“š
            const schemeData = {
                name: schemeName,
                date: new Date().toLocaleString(),
                language: document.getElementById("language").value,
                unit: document.getElementById("unit").value,
                sawThickness: document.getElementById("sawThickness").value,
                algorithm: document.getElementById("algorithmSelector").value,
                cuttingInputUnit: cuttingInputUnit,
                materialInputUnit: materialInputUnit,
                cuttingItems: cuttingItems,
                materials: materials
            };

            // ä¿å­˜åˆ°localStorage
            let savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
            savedSchemes.push(schemeData);
            localStorage.setItem("aluminumCuttingSchemes", JSON.stringify(savedSchemes));

            // é—œé–‰æ¨¡æ…‹æ¡†
            bootstrap.Modal.getInstance(document.getElementById("saveSchemeModal")).hide();
            document.getElementById("schemeName").value = "";
            alert(lang === "zh" ? "æ–¹æ¡ˆå·²å„²å­˜" : "Scheme saved successfully");

            // åˆ·æ–°æ–¹æ¡ˆåˆ—è¡¨
            loadScheme();
        }

        // ä¸Šå‚³æ–¹æ¡ˆæ–‡ä»¶
        function uploadSchemeFile() {
            const fileInput = document.getElementById("schemeFileInput");
            const lang = document.getElementById("language").value;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert(lang === "zh" ? "è«‹é¸æ“‡æª”æ¡ˆ" : "Please select a file");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const schemeData = JSON.parse(e.target.result);

                    if (schemeData.name && schemeData.cuttingItems && schemeData.materials) {
                        let savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
                        savedSchemes.push(schemeData);
                        localStorage.setItem("aluminumCuttingSchemes", JSON.stringify(savedSchemes));

                        fileInput.value = "";
                        loadScheme();
                        
                        // alert(lang === "zh" ? "æ–¹æ¡ˆå·²ä¸Šè¼‰æˆåŠŸ" : "Scheme uploaded successfully"); // Disabled for auto flow

                        // --- è‡ªå‹•å°èˆªé‚è¼¯é–‹å§‹ ---
                        // 1. ç²å–æ–°åŠ å…¥æ–¹æ¡ˆçš„ç´¢å¼• (æœ€å¾Œä¸€å€‹)
                        const newIndex = savedSchemes.length - 1;

                        // 2. é—œé–‰æ¨¡æ…‹æ¡†
                        const modalEl = document.getElementById("loadSchemeModal");
                        if (modalEl) {
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                    // æ»¾å‹•åˆ°è¨ˆç®—å€åŸŸ
                    setTimeout(function() {
                        const resultsCard = document.getElementById('results-card');
                        if (resultsCard) {
                            resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 500);
                        }

                        // 3. è¼‰å…¥æ•¸æ“šåˆ°è¼¸å…¥æ¡†
                        loadSchemeData(newIndex);

                        // 4. å»¶é²åŸ·è¡Œè¨ˆç®—ä¸¦è·³è½‰ (çµ¦äºˆ DOM æ›´æ–°æ™‚é–“)
                        setTimeout(() => {
                            // åŸ·è¡Œè¨ˆç®—
                            if (typeof calculate === 'function') {
                                calculate();
                            }

                            // æ»¾å‹•åˆ°è¦–è¦ºåŒ–åœ–è¡¨
                            const canvas = document.getElementById("cuttingCanvas");
                            if (canvas) {
                                canvas.scrollIntoView({behavior: 'smooth', block: 'start'});
                            }

                            // å˜—è©¦é»æ“Šå¯èƒ½å­˜åœ¨çš„ "åˆ‡å‰²çµæœ" æˆ– "Result" åˆ†é æŒ‰éˆ•
                            // éæ­·æ‰€æœ‰æŒ‰éˆ•å°‹æ‰¾åŒ¹é…æ–‡æœ¬
                            const buttons = document.getElementsByTagName('button');
                            for (let i = 0; i < buttons.length; i++) {
                                const txt = buttons[i].textContent || buttons[i].innerText;
                                if (txt.includes('åˆ‡å‰²çµæœ') || txt.includes('Result') || txt.includes('Results')) {
                                    // ç¢ºä¿ä¸æ˜¯ "åˆ—å°" æŒ‰éˆ•
                                    if (!txt.includes('åˆ—å°') && !txt.includes('Print')) {
                                        buttons[i].click();
                                        break; 
                                    }
                                }
                            }

                        }, 300);
                        // --- è‡ªå‹•å°èˆªé‚è¼¯çµæŸ ---

                    } else {
                        alert(lang === "zh" ? "æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º" : "Invalid file format");
                    }
                } catch (error) {
                    alert(lang === "zh" ? "ç„¡æ³•è®€å–æª”æ¡ˆ: " : "Cannot read file: " + error.message);
                }
            };

            reader.readAsText(file);
        }

        // è¼‰å…¥æ–¹æ¡ˆ
        function loadScheme() {
            const savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
            const schemesList = document.getElementById("savedSchemesList");
            const lang = document.getElementById("language").value;

            if (savedSchemes.length === 0) {
                schemesList.innerHTML = `<p>${lang === "zh" ? "æ²’æœ‰å·²å„²å­˜çš„æ–¹æ¡ˆ" : "No saved schemes found"}</p>`;
            } else {
                schemesList.innerHTML = savedSchemes.map((scheme, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <span style="color:#212529">${escapeHTML(scheme.name)}</span>
                        <div>
                            <button class="btn btn-sm btn-primary me-2" onclick="loadSchemeData(${index})">
                                ${lang === "zh" ? "è¼‰å…¥" : "Load"}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteScheme(${index})">
                                ${lang === "zh" ? "åˆªé™¤" : "Delete"}
                            </button>
                        </div>
                    </div>
                `).join("");
            }

            new bootstrap.Modal(document.getElementById("loadSchemeModal")).show();
        }

        // è¼‰å…¥æ–¹æ¡ˆæ•¸æ“š
        function loadSchemeData(index) {
            const savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
            const scheme = savedSchemes[index];

            if (!scheme) return;

            // è¨­ç½®åŸºæœ¬è¨­ç½®
            document.getElementById("language").value = scheme.language || "zh";
            document.getElementById("unit").value = scheme.unit || "metric";
            document.getElementById("sawThickness").value = scheme.sawThickness || "3.2";
            document.getElementById("algorithmSelector").value = scheme.algorithm || "BFD";

            // æ¸…ç©ºç•¶å‰è¡¨æ ¼
            document.querySelector("#cuttingItemsTable tbody").innerHTML = "";
            document.querySelector("#materialItemsTable tbody").innerHTML = "";

            // è¨­ç½®è¼¸å…¥éƒ¨åˆ†çš„å–®ä½é¸æ“‡å™¨
            const cuttingUnitSelect = document.querySelector("#cuttingItems .unit-select");
            const materialUnitSelect = document.querySelector("#materialItems .unit-select");
            
            if (cuttingUnitSelect) {
                cuttingUnitSelect.value = scheme.cuttingInputUnit || "metric";
                cuttingUnitSelect.classList.remove("metric-active", "imperial-active");
                cuttingUnitSelect.value === "metric" ? 
                    cuttingUnitSelect.classList.add("metric-active") : 
                    cuttingUnitSelect.classList.add("imperial-active");
            }
            
            if (materialUnitSelect) {
                materialUnitSelect.value = scheme.materialInputUnit || "metric";
                materialUnitSelect.classList.remove("metric-active", "imperial-active");
                materialUnitSelect.value === "metric" ? 
                    materialUnitSelect.classList.add("metric-active") : 
                    materialUnitSelect.classList.add("imperial-active");
            }

            // è¼‰å…¥åˆ‡å‰²é …ç›®
            if (scheme.cuttingItems && scheme.cuttingItems.length > 0) {
                scheme.cuttingItems.forEach(item => {
                    const length = item.length || "0";
                    const quantity = item.quantity || "1";
                    const purpose = item.purpose || "";
                    let display = item.display || "";
                    let inputUnit = item.inputUnit || scheme.cuttingInputUnit || "metric";

                    // å¦‚æœæ²’æœ‰é¡¯ç¤ºå­—ç¬¦ä¸²ï¼Œæ ¹æ“šé•·åº¦ç”Ÿæˆä¸€å€‹
                    if (!display && length !== "0") {
                        const lengthNum = parseFloat(length);
                        if (!isNaN(lengthNum)) {
                            display = formatLengthForDisplay(lengthNum, inputUnit);
                        } else {
                            display = length;
                        }
                    }

                    // å‰µå»ºè¡¨æ ¼è¡Œ
                    const row = document.createElement("tr");
                    row.dataset.length = length;
                    row.dataset.quantity = quantity;
                    row.dataset.purpose = purpose;
                    row.dataset.display = display;
                    row.dataset.inputUnit = inputUnit;

                    const tbody = document.querySelector("#cuttingItemsTable tbody");
                    const rowIndex = tbody.children.length;
                    
                    row.innerHTML = `
                        <td>${display}</td>
                        <td>${quantity}</td>
                        <td>${purpose || "-"}</td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-warning" onclick="enterCuttingEditMode(${rowIndex})" title="ç·¨è¼¯">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitCuttingEditMode();" title="åˆªé™¤">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            // è¼‰å…¥ææ–™é …ç›®
            if (scheme.materials && scheme.materials.length > 0) {
                scheme.materials.forEach(item => {
                    const length = item.length || "0";
                    const quantity = item.quantity || "1";
                    let display = item.display || "";
                    let inputUnit = item.inputUnit || scheme.materialInputUnit || "metric";

                    // å¦‚æœæ²’æœ‰é¡¯ç¤ºå­—ç¬¦ä¸²ï¼Œæ ¹æ“šé•·åº¦ç”Ÿæˆä¸€å€‹
                    if (!display && length !== "0") {
                        const lengthNum = parseFloat(length);
                        if (!isNaN(lengthNum)) {
                            display = formatLengthForDisplay(lengthNum, inputUnit);
                        } else {
                            display = length;
                        }
                    }

                    // å‰µå»ºè¡¨æ ¼è¡Œ
                    const row = document.createElement("tr");
                    row.dataset.length = length;
                    row.dataset.quantity = quantity;
                    row.dataset.display = display;
                    row.dataset.inputUnit = inputUnit;

                    const tbody = document.querySelector("#materialItemsTable tbody");
                    const rowIndex = tbody.children.length;
                    
                    row.innerHTML = `
                        <td>${display}</td>
                        <td>${quantity}</td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-warning" onclick="enterMaterialEditMode(${rowIndex})" title="ç·¨è¼¯">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitMaterialEditMode();" title="åˆªé™¤">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            // é€€å‡ºä»»ä½•ç·¨è¼¯æ¨¡å¼
            exitCuttingEditMode();
            exitMaterialEditMode();

            // æ›´æ–°ç•Œé¢
            updateLanguage();
            updateInputLabels();

            // åˆå§‹åŒ–æ‰€æœ‰å–®ä½é¸æ“‡å™¨çš„é¡è‰²
            setTimeout(function() {
                const settingsUnit = document.getElementById("unit");
                if (settingsUnit) {
                    settingsUnit.classList.remove("metric-active", "imperial-active");
                    if (settingsUnit.value === "metric") {
                        settingsUnit.classList.add("metric-active");
                    } else {
                        settingsUnit.classList.add("imperial-active");
                    }
                }

                const initCutUnit = document.getElementById("globalCutUnit");
                if (initCutUnit) {
                    initCutUnit.classList.remove("metric-active", "imperial-active");
                    if (initCutUnit.value === "metric") {
                        initCutUnit.classList.add("metric-active");
                    } else {
                        initCutUnit.classList.add("imperial-active");
                    }
                }

                const initMaterialUnit = document.getElementById("globalMaterialUnit");
                if (initMaterialUnit) {
                    initMaterialUnit.classList.remove("metric-active", "imperial-active");
                    if (initMaterialUnit.value === "metric") {
                        initMaterialUnit.classList.add("metric-active");
                    } else {
                        initMaterialUnit.classList.add("imperial-active");
                    }
                }
            }, 50);

            // é—œé–‰æ¨¡æ…‹æ¡†
            bootstrap.Modal.getInstance(document.getElementById("loadSchemeModal")).hide();
        }

        // åˆªé™¤æ–¹æ¡ˆ
        function deleteScheme(index) {
            const lang = document.getElementById("language").value;

            if (confirm(lang === "zh" ? "ç¢ºå®šè¦åˆªé™¤æ­¤æ–¹æ¡ˆå—ï¼Ÿ" : "Are you sure you want to delete this scheme?")) {
                let savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
                savedSchemes.splice(index, 1);
                localStorage.setItem("aluminumCuttingSchemes", JSON.stringify(savedSchemes));
                loadScheme();
            }
        }

        // é‡ç½®
        function reset() {
            // é€€å‡ºç·¨è¼¯æ¨¡å¼
            exitCuttingEditMode();
            exitMaterialEditMode();

            // æ¸…ç©ºè¡¨æ ¼
            document.querySelector("#cuttingItemsTable tbody").innerHTML = "";
            document.querySelector("#materialItemsTable tbody").innerHTML = "";

            // æ¸…é™¤è¼¸å…¥
            clearCuttingInputs();
            clearMaterialInputs();

            // éš±è—çµæœå€åŸŸ
            document.getElementById("resultDetails").style.display = "none";
            document.getElementById("cuttingCanvas").style.display = "none";
            document.getElementById("colorLegend").style.display = "none";
            document.getElementById("progressBar").style.display = "none";
            document.getElementById("schemeSelector").style.display = "none";
            document.getElementById("printOptionsButton").style.display = "none";
            document.getElementById("printButton").style.display = "none";

            // é‡ç½®é‹¸ç‰‡åšåº¦
            const unit = document.getElementById("unit").value;
            document.getElementById("sawThickness").value = unit === "imperial" ? "1/8" : "3.2";

            // æ›´æ–°ç•Œé¢
            updateLanguage();
            updateInputLabels();

            // åˆå§‹åŒ–æ‰€æœ‰å–®ä½é¸æ“‡å™¨çš„é¡è‰²
            setTimeout(function() {
                const settingsUnit = document.getElementById("unit");
                if (settingsUnit) {
                    settingsUnit.classList.remove("metric-active", "imperial-active");
                    if (settingsUnit.value === "metric") {
                        settingsUnit.classList.add("metric-active");
                    } else {
                        settingsUnit.classList.add("imperial-active");
                    }
                }

                const initCutUnit = document.getElementById("globalCutUnit");
                if (initCutUnit) {
                    initCutUnit.classList.remove("metric-active", "imperial-active");
                    if (initCutUnit.value === "metric") {
                        initCutUnit.classList.add("metric-active");
                    } else {
                        initCutUnit.classList.add("imperial-active");
                    }
                }

                const initMaterialUnit = document.getElementById("globalMaterialUnit");
                if (initMaterialUnit) {
                    initMaterialUnit.classList.remove("metric-active", "imperial-active");
                    if (initMaterialUnit.value === "metric") {
                        initMaterialUnit.classList.add("metric-active");
                    } else {
                        initMaterialUnit.classList.add("imperial-active");
                    }
                }
            }, 50);
        }

        // é¡¯ç¤ºåˆ—å°é¸é …
        function showPrintOptions() {
            new bootstrap.Modal(document.getElementById("printOptionsModal")).show();
        }

        // è§¸ç™¼åˆ—å°
        function triggerPrint() {
            const printSettings = document.getElementById("printSettings").checked;
            const printCuttingItems = document.getElementById("printCuttingItems").checked;
            const printMaterials = document.getElementById("printMaterials").checked;
            const printResults = document.getElementById("printResults").checked;
            const printVisualization = document.getElementById("printVisualization").checked;
            const printLegend = document.getElementById("printLegend").checked;

            // è¨­ç½®åˆ—å°æ¨£å¼
            document.getElementById("settings-card").classList.toggle("print-section", printSettings);
            document.getElementById("cutting-items-card").classList.toggle("print-section", printCuttingItems);
            document.getElementById("materials-card").classList.toggle("print-section", printMaterials);
            document.getElementById("results-card").classList.toggle("print-section", printResults || printVisualization || printLegend);
            document.getElementById("resultDetails").classList.toggle("print-section-results", printResults);
            document.getElementById("cuttingCanvas").classList.toggle("print-section-visualization", printVisualization);
            document.getElementById("colorLegend").classList.toggle("print-section-legend", printLegend);

            // é—œé–‰æ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById("printOptionsModal"));
            if (modal) modal.hide();

            // è§¸ç™¼åˆ—å°
            window.print();

            // åˆ—å°å¾Œæ¢å¾©æ¨£å¼
            const cleanup = () => {
                document.getElementById("settings-card").classList.remove("print-section");
                document.getElementById("cutting-items-card").classList.remove("print-section");
                document.getElementById("materials-card").classList.remove("print-section");
                document.getElementById("results-card").classList.remove("print-section");
                document.getElementById("resultDetails").classList.remove("print-section-results");
                document.getElementById("cuttingCanvas").classList.remove("print-section-visualization");
                document.getElementById("colorLegend").classList.remove("print-section-legend");
            };

            // ç›£è½åˆ—å°çµæŸ
            if (window.matchMedia) {
                window.matchMedia("print").addListener(function (mq) {
                    if (!mq.matches) {
                        cleanup();
                    }
                });
            } else {
                setTimeout(cleanup, 1000);
            }
        }

        // é¡¯ç¤ºå¹«åŠ©
        function showHelp() {
            const helpContent = document.getElementById("helpContent");
            const lang = document.getElementById("language").value;

            if (lang === "zh") {
                helpContent.innerHTML = `
                    <h5>ä½¿ç”¨èªªæ˜</h5>
                    <ol>
                        <li><strong>è¨­ç½®</strong>ï¼šé¸æ“‡èªè¨€å’Œé¡¯ç¤ºå–®ä½ï¼Œè¼¸å…¥é‹¸ç‰‡åšåº¦</li>
                        <li><strong>åˆ‡å‰²é …ç›®</strong>ï¼šè¼¸å…¥éœ€è¦åˆ‡å‰²çš„é•·åº¦ã€æ•¸é‡å’Œç”¨é€”ï¼Œé»æ“Š"æ–°å¢é …ç›®"æ·»åŠ åˆ°åˆ—è¡¨</li>
                        <li><strong>ç·¨è¼¯é …ç›®</strong>ï¼šé»æ“Šè¡¨æ ¼ä¸­çš„"ç·¨è¼¯"æŒ‰éˆ•å¯å°‡é …ç›®å›å¡«åˆ°è¼¸å…¥æ¬„é€²è¡Œä¿®æ”¹ï¼Œç„¶å¾Œé»æ“Š"æ›´æ–°é …ç›®"ä¿å­˜</li>
                        <li><strong>ææ–™</strong>ï¼šè¼¸å…¥å¯ç”¨ææ–™çš„é•·åº¦å’Œæ•¸é‡ï¼Œé»æ“Š"æ–°å¢ææ–™"æ·»åŠ åˆ°åˆ—è¡¨</li>
                        <li><strong>ç·¨è¼¯ææ–™</strong>ï¼šé»æ“Šè¡¨æ ¼ä¸­çš„"ç·¨è¼¯"æŒ‰éˆ•å¯å°‡ææ–™å›å¡«åˆ°è¼¸å…¥æ¬„é€²è¡Œä¿®æ”¹ï¼Œç„¶å¾Œé»æ“Š"æ›´æ–°ææ–™"ä¿å­˜</li>
                        <li><strong>è¨ˆç®—</strong>ï¼šé»æ“Šè¨ˆç®—æŒ‰éˆ•ç²å–æœ€ä½³åˆ‡å‰²æ–¹æ¡ˆ</li>
                        <li><strong>çµæœ</strong>ï¼šæŸ¥çœ‹åˆ‡å‰²æ–¹æ¡ˆè©³æƒ…å’Œåœ–å½¢åŒ–å±•ç¤º</li>
                        <li>å¯ä»¥å„²å­˜å’Œè¼‰å…¥å¸¸ç”¨æ–¹æ¡ˆ</li>
                        <li>é»æ“Š"åˆ—å°å ±å‘Š"å¯åˆ—å°ç•¶å‰æ–¹æ¡ˆ</li>
                    </ol>
                    <p>æç¤ºï¼š</p>
                    <ul>
                        <li>ä½¿ç”¨å…¬åˆ¶å–®ä½æ™‚è¼¸å…¥ç±³/å˜ç±³/æ¯«ç±³</li>
                        <li>ä½¿ç”¨è‹±åˆ¶å–®ä½æ™‚è¼¸å…¥å°º/å¯¸/åˆ†</li>
                        <li>é‹¸ç‰‡åšåº¦æœƒå½±éŸ¿ææ–™åˆ©ç”¨ç‡</li>
                        <li>ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é¤˜æ–™ä¸¦å„ªåŒ–æ–¹æ¡ˆ</li>
                        <li><strong>æ™ºèƒ½å„ªåŒ–æ–¹æ¡ˆæœƒå°‡ç›¸åŒå°ºå¯¸çš„åˆ‡å‰²ä»¶ç›¡é‡æ’åˆ—åœ¨ä¸€èµ·ï¼Œæé«˜é–‹æ–™æ•ˆç‡</strong></li>
                        <li><strong>é»æ“Š"æ¸…é™¤è¼¸å…¥"æŒ‰éˆ•å¯ä»¥å¿«é€Ÿæ¸…ç©ºè¼¸å…¥æ¬„</strong></li>
                        <li><strong>æ–°å¢æˆ–æ›´æ–°é …ç›®å¾Œï¼Œè¼¸å…¥æ¬„æœƒè‡ªå‹•æ­¸é›¶ï¼Œæ–¹ä¾¿è¼¸å…¥ä¸‹ä¸€å€‹é …ç›®</strong></li>
                        <li><strong>ç·¨è¼¯é …ç›®æ™‚ï¼Œè¼¸å…¥æ¬„çš„å–®ä½æœƒè·Ÿéš¨è©²é …ç›®åŸæœ¬çš„å–®ä½ï¼ˆå…¬åˆ¶/è‹±åˆ¶ï¼‰</strong></li>
                    </ul>
                `;
            } else {
                helpContent.innerHTML = `
                    <h5>User Guide</h5>
                    <ol>
                        <li><strong>Settings</strong>: Select language and display unit, enter saw thickness</li>
                        <li><strong>Cutting Items</strong>: Enter required lengths, quantities and purposes, click "Add Item" to add to list</li>
                        <li><strong>Edit Items</strong>: Click "Edit" button in table to load item back to input fields, modify and click "Update Item" to save</li>
                        <li><strong>Materials</strong>: Enter available material lengths and quantities, click "Add Material" to add to list</li>
                        <li><strong>Edit Materials</strong>: Click "Edit" button in table to load material back to input fields, modify and click "Update Material" to save</li>
                        <li><strong>Calculate</strong>: Click Calculate button to get optimal cutting plan</li>
                        <li><strong>Results</strong>: View cutting details and graphical visualization</li>
                        <li>Save and load frequently used schemes</li>
                        <li>Click "Print Report" to print current scheme</li>
                    </ol>
                    <p>Tips:</p>
                    <ul>
                        <li>Use meters/cm/mm for metric units</li>
                        <li>Use feet/inches/eighths for imperial units</li>
                        <li>Saw thickness affects material utilization</li>
                        <li>System calculates remnants and optimizes plan</li>
                        <li><strong>Smart optimization scheme groups same-size cuts together for better efficiency</strong></li>
                        <li><strong>Click "Clear Input" button to quickly clear input fields</strong></li>
                        <li><strong>After adding or updating items, input fields will automatically reset to zero for next entry</strong></li>
                        <li><strong>When editing items, the input field units will follow the original unit (metric/imperial) of that item</strong></li>
                    </ul>
                `;
            }

            new bootstrap.Modal(document.getElementById("helpModal")).show();
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener("DOMContentLoaded", function () {
            updateLanguage();
            updateInputLabels();

            // åˆå§‹åŒ–æ‰€æœ‰å–®ä½é¸æ“‡å™¨çš„é¡è‰²
            setTimeout(function() {
                const settingsUnit = document.getElementById("unit");
                if (settingsUnit) {
                    settingsUnit.classList.remove("metric-active", "imperial-active");
                    if (settingsUnit.value === "metric") {
                        settingsUnit.classList.add("metric-active");
                    } else {
                        settingsUnit.classList.add("imperial-active");
                    }
                }

                const initCutUnit = document.getElementById("globalCutUnit");
                if (initCutUnit) {
                    initCutUnit.classList.remove("metric-active", "imperial-active");
                    if (initCutUnit.value === "metric") {
                        initCutUnit.classList.add("metric-active");
                    } else {
                        initCutUnit.classList.add("imperial-active");
                    }
                }

                const initMaterialUnit = document.getElementById("globalMaterialUnit");
                if (initMaterialUnit) {
                    initMaterialUnit.classList.remove("metric-active", "imperial-active");
                    if (initMaterialUnit.value === "metric") {
                        initMaterialUnit.classList.add("metric-active");
                    } else {
                        initMaterialUnit.classList.add("imperial-active");
                    }
                }
            }, 50);
            // ç¶å®šåˆ‡å‰²é …ç›®å€çš„å…¨å±€å–®ä½ä¸‹æ‹‰ï¼Œä»¥å³æ™‚æ›´æ–°å°º/å¯¸/åˆ†æç¤º
            const gUnit = document.getElementById("globalCutUnit");
            if (gUnit) {
                gUnit.addEventListener("change", function(){
                    updateCuttingUnitOnly();
                });
            }

            const gMaterialUnit = document.getElementById("globalMaterialUnit");
            if (gMaterialUnit) {
                gMaterialUnit.addEventListener("change", function(){
                    updateMaterialUnitOnly();
                });
            }

            // è¨­ç½®é»˜èªé‹¸ç‰‡åšåº¦
            const unit = document.getElementById("unit").value;
            document.getElementById("sawThickness").value = unit === "imperial" ? "1/8" : "3.2";

            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById("sawThickness").addEventListener("input", function () {
                parseSawThickness();
            });

            document.getElementById("unit").addEventListener("change", function () {
                const unit = this.value;
                const sawThicknessInput = document.getElementById("sawThickness");
                const currentValue = sawThicknessInput.value.trim();

                if (unit === "imperial") {
                    if (!currentValue || currentValue === "3.2") {
                        sawThicknessInput.value = "1/8";
                    }
                } else {
                    if (!currentValue || currentValue === "1/8") {
                        sawThicknessInput.value = "3.2";
                    }
                }

                updateInputLabels();
            });

            // ç‚ºæ‰€æœ‰é•·åº¦è¼¸å…¥æ¡†æ·»åŠ é©—è­‰
            document.querySelectorAll(".length-input-group").forEach(group => {
                const inputs = group.querySelectorAll(".form-control");
                const errorElement = group.querySelector(".error-message");

                inputs.forEach(input => {
                    input.addEventListener("input", () => validateInput(group, errorElement));
                });

                const unitSelect = group.querySelector(".unit-select");
                if (unitSelect) {
                    unitSelect.addEventListener("change", () => {
                        updateInputLabels();
                        validateInput(group, errorElement);
                    });
                }
            });
        });
    </script>

<script>

// Version 5 Fixes

window.forceUpdateUI = function(selectElement) {
    if (!selectElement) return;
    const unit = selectElement.value;
    const group = selectElement.closest(".length-input-group");
    if (!group) return;

    // æ›´æ–°é¡è‰²
    selectElement.classList.remove("metric-active", "imperial-active");
    if (unit === "imperial" || unit === "imperial_decimal") {
        selectElement.classList.add("imperial-active");
    } else {
        selectElement.classList.add("metric-active");
    }

    // æ›´æ–°æ¨™ç±¤
    const lang = document.getElementById("language").value;
    const labels = {
        imperial: lang === "zh" ? ["å°º", "å¯¸", "åˆ†"] : ["ft", "in", "eighth"],
        metric: lang === "zh" ? ["ç±³", "å˜ç±³", "æ¯«ç±³"] : ["m", "cm", "mm"]
    };
    const hintLabels = labels[unit] || labels.metric;

    group.querySelectorAll(".form-control").forEach((input, index) => {
        const hint = input.nextElementSibling;
        if (hint && hint.classList.contains("small-hint")) {
            hint.textContent = hintLabels[index] || "";
        }
    });
};

window.convertInputValues = function(group, targetUnit) {
    const inputs = group.querySelectorAll(".form-control");
    if (inputs.length < 3) return;

    // ç²å–ä¸Šä¸€æ¬¡çš„å–®ä½ï¼Œå¦‚æœæ²’æœ‰å°±é»˜èªç‚º metric
    const oldUnit = group.dataset.currentUnit || "metric"; 

    // å¦‚æœå–®ä½æ²’è®Šï¼Œä¸éœ€è¦è½‰æ›
    if (oldUnit === targetUnit) return; 

    console.log(`Converting from ${oldUnit} to ${targetUnit}`);

    let totalMM = 0;
    const val0 = parseFloat(inputs[0].value) || 0;
    const val1 = parseFloat(inputs[1].value) || 0;
    const val2 = parseFloat(inputs[2].value) || 0;

    // 1. å°‡èˆŠå–®ä½çš„æ•¸å€¼è½‰å›æ¨™æº– mm
    if (oldUnit === "imperial") {
         // ft, in, 8th -> mm
         totalMM = (val0 * 12 + val1 + val2/8) * 25.4;
    } else {
         // m, cm, mm -> mm
         totalMM = val0 * 1000 + val1 * 10 + val2;
    }

    // 2. å°‡ mm è½‰æ›ç‚ºæ–°å–®ä½çš„æ ¼å¼
    if (targetUnit === "imperial") {
         const totalInches = totalMM / 25.4;
         const ft = Math.floor(totalInches / 12);
         const inch = Math.floor(totalInches % 12);
         const eighths = Math.round((totalInches % 1) * 8);
         inputs[0].value = ft;
         inputs[1].value = inch;
         inputs[2].value = eighths;
    } else {
         const m = Math.floor(totalMM / 1000);
         const cm = Math.floor((totalMM % 1000) / 10);
         const mm = Math.round(totalMM % 10);
         inputs[0].value = m;
         inputs[1].value = cm;
         inputs[2].value = mm;
    }

    // 3. æ›´æ–°ç•¶å‰å–®ä½è¨˜éŒ„
    group.dataset.currentUnit = targetUnit;
};

window.parseLength = function(lengthInputGroup) {
    const unitSelect = lengthInputGroup.querySelector(".unit-select");
    const unit = unitSelect ? unitSelect.value : "metric";
    const inputs = lengthInputGroup.querySelectorAll(".form-control");

    const lang = document.getElementById("language").value;
    let totalMM = 0;
    let formatHint = "standard";

    if (unit === "imperial") {
        const ft = parseFloat(inputs[0].value) || 0;
        const inch = parseFloat(inputs[1].value) || 0;
        const eighth = parseFloat(inputs[2].value) || 0;

        if (ft === 0 && inch >= 12) formatHint = "inches_only";

        if (isNaN(ft) && isNaN(inch) && isNaN(eighth)) {
            return { value: 0, error: lang === "zh" ? "é•·åº¦ç„¡æ•ˆ" : "Invalid length" };
        }
        totalMM = (ft * 12 + inch + eighth/8) * 25.4;
    } else {
        const m = parseFloat(inputs[0].value) || 0;
        const cm = parseFloat(inputs[1].value) || 0;
        const mm = parseFloat(inputs[2].value) || 0;
        totalMM = m * 1000 + cm * 10 + mm;
    }
    return { value: totalMM, formatHint: formatHint };
};

window.enterCuttingEditMode = function(index) {
    const row = document.querySelectorAll("#cuttingItemsTable tbody tr")[index];
    if (!row) return;

    document.getElementById("editingCuttingIndex").value = index;
    const template = document.querySelector("#cuttingItems .cutting-item");

    // é€™è£¡æˆ‘å€‘ä¿¡ä»» dataset ä¸­çš„ inputUnit
    // å¦‚æœå®ƒå‡ºéŒ¯ (åƒæˆªåœ–é‚£æ¨£)ï¼Œæˆ‘å€‘åœ¨ä¸‹é¢å¡«å……æ•¸å€¼æ™‚æœƒå¼·åˆ¶ä¿®æ­£å®ƒ
    const unit = row.dataset.inputUnit || "metric";
    const lengthMM = parseFloat(row.dataset.length);
    const formatHint = row.dataset.formatHint || "standard";

    const unitSelect = template.querySelector(".unit-select");
    if(unitSelect) {
        unitSelect.value = unit;
        const group = unitSelect.closest(".length-input-group");
        if(group) group.dataset.currentUnit = unit; // æ­£ç¢ºåˆå§‹åŒ–
        window.forceUpdateUI(unitSelect);
    }

    // å¡«å……æ•¸å€¼ (çµ•å°çœŸç†ä¾†æºï¼šlengthMM)
    if (unit === "imperial") {
        const totalInches = lengthMM / 25.4;
        const eighths = Math.round((totalInches % 1) * 8);
        if (formatHint === "inches_only") {
            template.querySelector('[data-part="ft"]').value = 0;
            template.querySelector('[data-part="in"]').value = Math.floor(totalInches);
        } else {
            template.querySelector('[data-part="ft"]').value = Math.floor(totalInches / 12);
            template.querySelector('[data-part="in"]').value = Math.floor(totalInches % 12);
        }
        template.querySelector('[data-part="eighth"]').value = eighths;
    } else {
        const meters = Math.floor(lengthMM / 1000);
        const cm = Math.floor((lengthMM % 1000) / 10);
        const mm = Math.round(lengthMM % 10);
        template.querySelector('[data-part="ft"]').value = meters;
        template.querySelector('[data-part="in"]').value = cm;
        template.querySelector('[data-part="eighth"]').value = mm;
    }

    template.querySelector(".cutQty").value = row.dataset.quantity;
    template.querySelector(".cutPurpose").value = row.dataset.purpose || "";

    document.getElementById("addCuttingButton").style.display = "none";
    document.getElementById("updateCuttingButton").style.display = "inline-block";
    /* cancelCuttingEditBtn removed: use clearCuttingButton if needed */
};

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".unit-select").forEach(select => {
        const group = select.closest(".length-input-group");

        // åˆå§‹åŒ–ï¼šæ ¹æ“š HTML ä¸­çš„é è¨­å€¼è¨­ç½® dataset
        if (group) {
            group.dataset.currentUnit = select.value;
        }

        // ç¶å®š focusï¼šç•¶ç”¨æˆ¶é»æ“Šä¸‹æ‹‰é¸å–®æ™‚ï¼Œå†æ¬¡ç¢ºèªç•¶å‰ç‹€æ…‹ï¼Œé˜²æ­¢ dataset ä¸åŒæ­¥
        select.addEventListener("focus", function() {
             const group = this.closest(".length-input-group");
             if(group) group.dataset.currentUnit = this.value;
        });

        // ç¶å®š changeï¼šåŸ·è¡Œè½‰æ›
        select.addEventListener("change", function() {
            const group = this.closest(".length-input-group");
            if (group) {
                window.convertInputValues(group, this.value);
                window.forceUpdateUI(this);
            }
        });

        // é é¢åŠ è¼‰æ™‚åŸ·è¡Œä¸€æ¬¡ UI æ›´æ–°
        window.forceUpdateUI(select);
    });
});

</script>

<script>
// ===== è‡ªå‹•è£œæ–™åŠŸèƒ½æ³¨å…¥ (åªåŠ åŠŸèƒ½ï¼Œå””æ”¹å¤–è§€) =====
(function(){
  // è¦†è“‹å„ªåŒ–ç®—æ³•ï¼ŒåŠ å…¥ autoAdded æ¨™è¨˜
  const createOptimizer = (algoType) => {
    return function(cuts, materials, sawThickness) {
      let allCuts = [];
      cuts.forEach(item => {
        for(let i = 0; i < item.quantity; i++) {
          allCuts.push({length: item.length, purpose: item.purpose, display: item.display || ""});
        }
      });

      if(algoType !== 'SizeGrouping') {
        allCuts.sort((a, b) => b.length - a.length);
      }

      let bins = [];
      let availableMaterials = materials.flatMap(item => Array(item.quantity).fill(item.length)).sort((a, b) => b - a);
      const defaultLength = materials.length > 0 ? materials.reduce((max, item) => Math.max(max, item.length || 0), 0) : 6000;

      if(algoType === 'FFD') {
        // First Fit Decreasing
        allCuts.forEach(cut => {
          let placed = false;
          for(let i = 0; i < bins.length; i++) {
            const bin = bins[i];
            const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
            const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
            if(usedLength + kerfLength + cut.length + (bin.cuts.length > 0 ? sawThickness : 0) <= bin.length) {
              bin.cuts.push(cut);
              placed = true;
              break;
            }
          }
          if(!placed) {
            let binLength, autoAdded = false;
            if(availableMaterials.length > 0) {
              binLength = availableMaterials.shift();
            } else {
              binLength = defaultLength;
              autoAdded = true;
            }
            bins.push({length: binLength, cuts: [cut], autoAdded: autoAdded});
          }
        });
      } else if(algoType === 'SizeGrouping') {
        // Size Grouping
        let lengthGroups = {};
        allCuts.forEach(cut => {
          if(!lengthGroups[cut.length]) lengthGroups[cut.length] = [];
          lengthGroups[cut.length].push(cut);
        });
        const sortedLengths = Object.keys(lengthGroups).map(Number).sort((a, b) => b - a);

        sortedLengths.forEach(length => {
          let groupCuts = lengthGroups[length];
          while(groupCuts.length > 0) {
            let bestBin = null, bestCount = 0;
            for(let i = 0; i < bins.length; i++) {
              const bin = bins[i];
              const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
              const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
              let count = 0, currentLength = usedLength + kerfLength;
              for(let j = 0; j < groupCuts.length; j++) {
                const required = length + (bin.cuts.length + count > 0 ? sawThickness : 0);
                if(currentLength + required <= bin.length) {
                  count++;
                  currentLength += required;
                } else {
                  break;
                }
              }
              if(count > 0 && count > bestCount) {
                bestCount = count;
                bestBin = bin;
              }
            }

            if(bestBin) {
              for(let k = 0; k < bestCount; k++) bestBin.cuts.push(groupCuts.shift());
            } else {
              let binLength, autoAdded = false;
              if(availableMaterials.length > 0) {
                binLength = availableMaterials.shift();
              } else {
                binLength = defaultLength;
                autoAdded = true;
              }
              const newBin = {length: binLength, cuts: [], autoAdded: autoAdded};
              let remainingLength = binLength;
              while(groupCuts.length > 0) {
                const cut = groupCuts[0];
                const required = cut.length + (newBin.cuts.length > 0 ? sawThickness : 0);
                if(required <= remainingLength) {
                  newBin.cuts.push(groupCuts.shift());
                  remainingLength -= required;
                } else {
                  break;
                }
              }
              bins.push(newBin);
            }
          }
        });
      } else {
        // BFD (Best Fit Decreasing) - default
        allCuts.forEach(cut => {
          let bestBin = null;
          let bestRemaining = Infinity;
          for(let i = 0; i < bins.length; i++) {
            const bin = bins[i];
            const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
            const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
            const required = cut.length + (bin.cuts.length > 0 ? sawThickness : 0);
            const remaining = bin.length - (usedLength + kerfLength + required);
            if(remaining >= 0 && remaining < bestRemaining) {
              bestRemaining = remaining;
              bestBin = bin;
            }
          }

          if(bestBin) {
            bestBin.cuts.push(cut);
          } else {
            let binLength, autoAdded = false;
            if(availableMaterials.length > 0) {
              binLength = availableMaterials.shift();
            } else {
              binLength = defaultLength;
              autoAdded = true;
            }
            bins.push({length: binLength, cuts: [cut], autoAdded: autoAdded});
          }
        });
      }
      return bins;
    };
  };

  window.optimizeCutsBFD = createOptimizer('BFD');
  window.optimizeCutsFFD = createOptimizer('FFD');
  window.optimizeCutsSizeGrouping = createOptimizer('SizeGrouping');

  // è¦†è“‹ renderCuttingResultsï¼ŒåŠ å…¥è£œæ–™æç¤º
  const originalRender = window.renderCuttingResults;
  window.renderCuttingResults = function(bins, sawThickness) {
    // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰è‡ªå‹•è£œæ–™
    let missingMaterials = {};
    bins.forEach(bin => {
      if(bin && bin.autoAdded) {
        const len = bin.length;
        missingMaterials[len] = (missingMaterials[len] || 0) + 1;
      }
    });

    // å¦‚æœæœ‰è£œæ–™éœ€æ±‚ï¼ŒåŠ å…¥æç¤º
    if(Object.keys(missingMaterials).length > 0) {
      const resultDetails = document.getElementById('resultDetails');
      if(resultDetails) {
        // å»ºç«‹æç¤º HTML
        let missingHtml = `<div style="margin: 15px 0; padding: 12px; background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 5px; color: #856404;">
          <strong><i class="fa-solid fa-triangle-exclamation"></i> ææ–™ä¸è¶³ï¼Œè‡ªå‹•è£œæ–™ (Auto-Replenish):</strong>
          <ul style="margin: 8px 0 0 20px; padding-left: 0;">`;

        for(const [length, count] of Object.entries(missingMaterials)) {
          const displayLen = (typeof formatLengthForDisplay === 'function') ? formatLengthForDisplay(parseFloat(length), document.getElementById('unit') ? document.getElementById('unit').value : 'metric') : length;
          missingHtml += `<li>${displayLen} x ${count} æ”¯</li>`;
        }
        missingHtml += `</ul></div>`;

        // æ’å…¥æç¤ºåˆ°çµæœå€
        const summaryBox = resultDetails.querySelector('[style*="background: #e8f5e9"]') || resultDetails.querySelector('[style*="background-color: #e8f5e9"]');
        if(summaryBox) {
          summaryBox.insertAdjacentHTML('afterend', missingHtml);
        }
      }
    }

    // å‘¼å«åŸæœ¬å˜… render å‡½æ•¸ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if(typeof originalRender === 'function') {
      originalRender.call(this, bins, sawThickness);
    }
  };
})();
</script>

<script>
// ===== Usability fix: auto clear default zero & remove leading zeros =====
(function(){
  const selectors = [
    '.cutQty',
    '.materialQty'
  ];

  function normalizeNumericString(v){
    const s = v.trim();
    if (s === '') return '';
    // Integer -> remove leading zeros
    if (/^\d+$/.test(s)) return String(Number(s));
    // Decimal that starts with 0. -> keep as is (e.g., 0.5)
    if (/^0\.[0-9]+$/.test(s)) return s;
    // General numeric normalization
    const num = Number(s);
    if (!Number.isNaN(num)) return String(num);
    return s; // non-numeric: leave it
  }

  function getDefaultFor(el){
    // custom defaults by field
    if (el.classList && el.classList.contains('materialQty')) return '1';
    return '0';
  }

  function setup(el){
    // Focus: if value is exactly "0", clear for easy input
    el.addEventListener('focus', function(){
      // åªåœ¨ç¬¬ä¸€æ¬¡èšç„¦ä¸”å€¼ç‚º"0"æ™‚æ¸…ç©ºï¼Œé¿å…å¾ŒçºŒç·¨è¼¯æ™‚å¹²æ“¾
      if (this.value === '0' && !this.dataset._clearedOnce) {
        this.value = '';
        this.dataset._clearedOnce = '1';
      }
    });

    // Input: live cleanup of leading zeros for integers
    el.addEventListener('input', function(){
      const v = this.value;
      // åªå°ç´”æ•´æ•¸å»é™¤å‰å°é›¶ï¼Œç›¡é‡ä¸æ”¹è®Šç”¨å®¶è¼¸å…¥çš„å°æ•¸æ ¼å¼
      if (/^\d+$/.test(v)) {
        const normalized = String(Number(v));
        if (normalized !== v) this.value = normalized;
      }
    });

    // Blur: restore default if empty; otherwise normalize number format
    el.addEventListener('blur', function(){
      const v = this.value.trim();
      if (v === '') {
        this.value = getDefaultFor(this);
      } else {
        this.value = normalizeNumericString(v);
      }
    });
  }

  function init(){
    selectors.forEach(sel => {
      document.querySelectorAll(sel).forEach(setup);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
// ===== End usability fix =====
</script>
<script>
// ===== Imperial unit focus fix: clear single zero on first focus =====
(function(){
  function isImperialContext(el){
    // check nearest unit-select inside same group, fallback to global #unit
    const group = el.closest('.length-input-group') || el.closest('.saw-thickness-input') || document;
    const localSelect = group.querySelector('.unit-select');
    const unit = localSelect ? localSelect.value : (document.getElementById('unit') ? document.getElementById('unit').value : 'metric');
    return unit === 'imperial' || unit === 'imperial_decimal';
  }

  function setupImperialZeroClear(selector){
    document.querySelectorAll(selector).forEach(el => {
      el.addEventListener('focus', function(){
        if (!isImperialContext(this)) return;
        // åªåœ¨è‹±åˆ¶æƒ…å¢ƒä¸‹ï¼Œä¸”é¦–æ¬¡èšç„¦å€¼ç‚º "0" æ™‚æ¸…ç©ºï¼Œé¿å…è¼¸å…¥è¢«è¿½åŠ åœ¨ 0 å¾Œé¢
        if (this.value === '0' && !this.dataset._imperialClearedOnce) {
          this.value = '';
          this.dataset._imperialClearedOnce = '1';
        } else if (this.value === '0') {
          // ç¬¬äºŒæ¬¡ä»¥å¾Œï¼šé¸å–å…¨éƒ¨ï¼Œè®“è¼¸å…¥è¦†è“‹ 0
          try { this.select(); } catch(e) {}
        }
      });
    });
  }

  function init(){
    // é‡å°åˆ‡å‰²é …ç›®åŠææ–™çš„è‹±åˆ¶é•·åº¦æ¬„ä½ï¼ˆåˆ†æ‹†ç‚º ft/in/eighthï¼‰ï¼Œä»¥åŠé‹¸ç‰‡åšåº¦è¼¸å…¥
    setupImperialZeroClear('.cutLengthPart');
    setupImperialZeroClear('.materialLengthPart');
    setupImperialZeroClear('#sawThickness');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
// ===== End Imperial unit focus fix =====
</script>

<script>
// è‡ªå‹•é‡ç®—ï¼šé é¢è¼‰å…¥å¾Œï¼Œè‹¥å·²æœ‰æ¸…å–®è³‡æ–™å‰‡è‡ªå‹•ä»¥æ–°å…¬å¼é‡ç®—
(function(){
  function autoRecalc(){
    try {
      const hasData = document.querySelector('#cuttingItemsTable tbody tr') || document.querySelector('#materialItemsTable tbody tr');
      if (hasData && typeof calculate === 'function') {
        calculate();
      }
    } catch(e) {}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', autoRecalc);
  } else {
    setTimeout(autoRecalc, 50);
  }
})();
</script>


    <script>
    // æ™ºèƒ½è‡ªå‹•æ»¾å‹•åŠŸèƒ½ - æ»¾å‹•åˆ°sectionæ¨™é¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        // åˆ‡å‰²é …ç›®çš„é•·åº¦è¼¸å…¥æ¡† - æ»¾å‹•åˆ°åˆ‡å‰²é …ç›®çš„æ¨™é¡Œ
        const cuttingScrollInputs = 
                        }
                    }
                }, 300);
            });
        });

        // ææ–™çš„é•·åº¦è¼¸å…¥æ¡† - æ»¾å‹•åˆ°ææ–™çš„æ¨™é¡Œ
        const materialScrollInputs = document.querySelectorAll('.auto-scroll-material');

        materialScrollInputs.forEach(function(input) {
            input.addEventListener('focus', function() {
                setTimeout(function() {
                    // æ‰¾åˆ°ææ–™å¡ç‰‡çš„section-header
                    const materialCard = document.getElementById('materials-card');
                    if (materialCard) {
                        const sectionHeader = materialCard.querySelector('.section-header');
                        if (sectionHeader) {
                            // æ»¾å‹•åˆ°æ¨™é¡Œä½ç½®ï¼Œè®“æ¨™é¡Œå‡ºç¾åœ¨è¢å¹•é ‚éƒ¨åä¸‹ä¸€é»
                            const rect = sectionHeader.getBoundingClientRect();
                            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                            const targetY = rect.top + scrollTop - 20; // è·é›¢é ‚éƒ¨20px

                            window.scrollTo({
                                top: targetY,
                                behavior: 'smooth'
                            });
                        }
                    }
                }, 300);
            });
        });
    });
    </script>
    
    <script>
    // åªæ›´æ–°åˆ‡å‰²é …ç›®çš„å–®ä½
    function updateCuttingUnitOnly() {
        const cutUnit = document.getElementById('globalCutUnit');
        if (!cutUnit) return;

        const unit = cutUnit.value;
        const lang = document.getElementById('language').value;

        cutUnit.classList.remove('metric-active', 'imperial-active');
        if (unit === 'metric') {
            cutUnit.classList.add('metric-active');
        } else {
            cutUnit.classList.add('imperial-active');
        }

        const labels = {
            imperial: lang === 'zh' ? ['å°º', 'å¯¸', 'åˆ†'] : ['ft', 'in', 'eighth'],
            metric: lang === 'zh' ? ['ç±³', 'å˜ç±³', 'æ¯«ç±³'] : ['m', 'cm', 'mm']
        };
        const hintLabels = labels[unit] || labels.metric;

        const cuttingItems = document.getElementById('cuttingItems');
        if (cuttingItems) {
            const groups = cuttingItems.querySelectorAll('.length-input-group');
            groups.forEach(group => {
                if (group.closest('.edit-mode')) return;
                const inputs = group.querySelectorAll('.form-control');
                inputs.forEach((input, index) => {
                    const hint = input.nextElementSibling;
                    if (hint && hint.classList.contains('small-hint')) {
                        hint.textContent = hintLabels[index] || '';
                    }
                });
            });
        }
    }

    // åªæ›´æ–°ææ–™çš„å–®ä½
    function updateMaterialUnitOnly() {
        const materialUnit = document.getElementById('globalMaterialUnit');
        if (!materialUnit) return;

        const unit = materialUnit.value;
        const lang = document.getElementById('language').value;

        materialUnit.classList.remove('metric-active', 'imperial-active');
        if (unit === 'metric') {
            materialUnit.classList.add('metric-active');
        } else {
            materialUnit.classList.add('imperial-active');
        }

        const labels = {
            imperial: lang === 'zh' ? ['å°º', 'å¯¸', 'åˆ†'] : ['ft', 'in', 'eighth'],
            metric: lang === 'zh' ? ['ç±³', 'å˜ç±³', 'æ¯«ç±³'] : ['m', 'cm', 'mm']
        };
        const hintLabels = labels[unit] || labels.metric;

        const materialItems = document.getElementById('materialItems');
        if (materialItems) {
            const groups = materialItems.querySelectorAll('.length-input-group');
            groups.forEach(group => {
                if (group.closest('.edit-mode')) return;
                const inputs = group.querySelectorAll('.form-control');
                inputs.forEach((input, index) => {
                    const hint = input.nextElementSibling;
                    if (hint && hint.classList.contains('small-hint')) {
                        hint.textContent = hintLabels[index] || '';
                    }
                });
            });
        }
    }

    // è¼‰å…¥æ–¹æ¡ˆå¾Œæ»¾å‹•åˆ°è¨ˆç®—å€åŸŸçš„è¼”åŠ©å‡½æ•¸
    window.scrollToCalculate = function() {
        setTimeout(function() {
            const resultsCard = document.getElementById('results-card');
            if (resultsCard) {
                const header = resultsCard.querySelector('.section-header');
                if (header) {
                    header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }, 300);
    };
    
// ========================================
// è‡ªå‹•æ»¾å‹•åŠŸèƒ½ - æ­£ç¢ºç‰ˆæœ¬ï¼ˆæ‰¾ section-headerï¼‰
// ========================================
(function() {
    console.log('åˆå§‹åŒ–è‡ªå‹•æ»¾å‹•åŠŸèƒ½...');

    // ä½¿ç”¨äº‹ä»¶å§”è¨—ç›£è½æ‰€æœ‰ focus äº‹ä»¶
    document.addEventListener('focus', function(event) {
        const target = event.target;

        // æª¢æŸ¥æ˜¯å¦æ˜¯è¼¸å…¥æ¬„æˆ–é¸æ“‡å™¨
        const isInput = target.matches('input[type="number"], input[type="text"], textarea, select');

        if (isInput) {
            console.log('è¼¸å…¥æ¬„è¢«é»æ“Š:', target.tagName, target.id || target.name);

            // å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ card å®¹å™¨
            let card = target.closest('.card');

            if (card) {
                // åœ¨é€™å€‹ card å…§æ‰¾ section-headerï¼ˆæ­£ç¢ºçš„classåç¨±ï¼ï¼‰
                let sectionHeader = card.querySelector('.section-header');

                if (sectionHeader) {
                    console.log('æ‰¾åˆ°æ¨™é¡Œå€åŸŸ:', sectionHeader.textContent.trim().substring(0, 20));

                    // ç²å–æ¨™é¡Œç•¶å‰ä½ç½®
                    const headerRect = sectionHeader.getBoundingClientRect();
                    const headerTop = headerRect.top;

                    // å¦‚æœæ¨™é¡Œä¸åœ¨é ‚éƒ¨ï¼ˆè¶…é5pxï¼‰ï¼Œå°±æ»¾å‹•
                    if (headerTop > 5 || headerTop < 0) {
                        // è¨ˆç®—éœ€è¦æ»¾å‹•çš„è·é›¢
                        const scrollAmount = window.pageYOffset + headerTop - 5;

                        console.log('æ»¾å‹•åˆ°ä½ç½®:', scrollAmount, '(è·é›¢é ‚éƒ¨5px)');

                        window.scrollTo({
                            top: scrollAmount,
                            behavior: 'smooth'
                        });
                    } else {
                        console.log('å·²ç¶“åœ¨æ­£ç¢ºä½ç½®ï¼Œç„¡éœ€æ»¾å‹•');
                    }
                } else {
                    console.log('æ‰¾ä¸åˆ° .section-header');
                }
            } else {
                console.log('æ‰¾ä¸åˆ° .card');
            }
        }
    }, true); // ä½¿ç”¨æ•ç²éšæ®µ

    console.log('âœ… è‡ªå‹•æ»¾å‹•åŠŸèƒ½å·²å•Ÿå‹•ï¼ˆä½¿ç”¨ .section-headerï¼‰');
})();
</script>
    <script>
    // Auto-hide results when inputs change to avoid showing stale screenshot/results
    (function(){
      function hideResults(){
        const ids = [
          'resultDetails','cuttingCanvas','colorLegend','progressBar',
          'schemeSelector','printOptionsButton','printButton'
        ];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (id === 'progressBar') {
            el.style.display = 'none';
          } else {
            el.style.display = 'none';
          }
        });
      }
      function bind(el){
        if (!el) return;
        el.addEventListener('input', hideResults);
        el.addEventListener('change', hideResults);
      }
      function attachAutoHide(){
        // Basic selectors that impact results
        ['#language','#unit','#algorithmSelector','#sawThickness',
         '#globalCutUnit','#globalMaterialUnit']
         .forEach(sel => document.querySelectorAll(sel).forEach(bind));
        // Cutting inputs
        document.querySelectorAll('.cutLengthPart,.cutQty,.cutPurpose')
          .forEach(bind);
        // Material inputs
        document.querySelectorAll('.materialLengthPart,.materialQty')
          .forEach(bind);
        // Buttons that change data
        ['#addCuttingButton','#clearCuttingButton','#updateCuttingButton',
         '#addMaterialButton','#clearMaterialButton','#updateMaterialButton']
         .forEach(id => { const b=document.querySelector(id); if(b){ b.addEventListener('click', hideResults); }});
        // Table action buttons (edit/delete)
        document.addEventListener('click', function(e){
          const btn = e.target.closest('.action-buttons button');
          if(btn) hideResults();
        });
        // Expose for manual use if needed
        window.hideCuttingResults = hideResults;
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachAutoHide);
      } else {
        attachAutoHide();
      }
    })();
    </script>
      <script>
    // Add small colored optional note to Purpose label (ç”¨é€”)
    (function(){
      function applyOptionalNote(){
        try {
          var langSel = document.getElementById('language');
          var lang = langSel ? langSel.value : 'zh';
          var baseLabel = (lang === 'zh') ? 'ç”¨é€”:' : 'Purpose:';
          var noteText = (lang === 'zh') ? '(éå¿…å¡«)' : '(optional)';
          document.querySelectorAll('.cutPurposeLabel').forEach(function(lbl){
            // Avoid duplicate notes by resetting to base then append note
            lbl.innerHTML = baseLabel + ' <span class="optional-note">' + noteText + '</span>';
          });
        } catch(e) {}
      }
      // Patch updateLanguage to re-apply note after language switch
      var __origUpdateLanguage = window.updateLanguage;
      if (typeof __origUpdateLanguage === 'function') {
        window.updateLanguage = function(){
          __origUpdateLanguage();
          applyOptionalNote();
        };
      }
      // Run on first load as well
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyOptionalNote);
      } else {
        applyOptionalNote();
      }
      // Also re-apply when entering edit mode (UI may re-render labels)
      document.addEventListener('click', function(ev){
        if (ev.target && (ev.target.id === 'addCuttingButton' || ev.target.id === 'updateCuttingButton' || ev.target.id === 'clearCuttingButton')) {
          setTimeout(applyOptionalNote, 0);
        }
      });
      window.applyOptionalPurposeNote = applyOptionalNote; // expose
    })();
  </script>
</body>
</html>
<style>
/* Fix unit label overflow near right edge and on mobile */
.saw-thickness-input { position: relative; }
.saw-thickness-input .unit-label { order: -1; margin-right: 6px; margin-left: 0 !important; }
@media (max-width: 767.98px) {
  .saw-thickness-input .form-control { max-width: 90px !important; }
  .saw-thickness-input .unit-label { font-size: .9rem; }
}
</style>

<style>
/* v3: Keep unit label on RIGHT side within the field, no overflow */
.saw-thickness-input { position: relative; }
.saw-thickness-input .unit-label {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  margin: 0 !important;
  padding: 0 4px !important;
  height: 40px !important;
  line-height: 40px !important;
  background: transparent !important;
  white-space: nowrap !important;
}
/* Prevent overlap: add right padding inside input to make room for the unit label */
.saw-thickness-input .form-control {
  padding-right: 48px !important;
  height: 40px !important;
}
@media (max-width: 767.98px) {
  .saw-thickness-input .unit-label { right: 6px; font-size: .9rem; }
  .saw-thickness-input .form-control { padding-right: 52px !important; }
}
</style>

<script>
// i18n fixes: update unit select option texts and help button when language changes
(function(){
  function updateUnitOptionTexts(){
    var langElem = document.getElementById('language');
    var lang = langElem ? langElem.value : 'zh';
    var labelText = {
      metric: lang === 'zh' ? 'å…¬' : 'Metric',
      imperial: lang === 'zh' ? 'è‹±' : 'Imperial',
      imperial_decimal: lang === 'zh' ? 'è‹±(D)' : 'Imperial (Decimal)'
    };
    // Update all unit-select dropdowns
    document.querySelectorAll('select.unit-select').forEach(function(sel){
      sel.querySelectorAll('option').forEach(function(opt){
        if (labelText[opt.value]) { opt.textContent = labelText[opt.value]; }
      });
    });
    // Also update the Settings unit selector (#unit) if present
    var unitSel = document.getElementById('unit');
    if (unitSel) {
      unitSel.querySelectorAll('option').forEach(function(opt){
        if (labelText[opt.value]) { opt.textContent = labelText[opt.value]; }
      });
    }
  }
  function updateHelpButton(){
    var langElem = document.getElementById('language');
    var lang = langElem ? langElem.value : 'zh';
    var btn = document.getElementById('helpButton');
    if (btn) {
      btn.innerHTML = (lang === 'zh'
        ? '<i class="fas fa-question-circle me-2"></i>ä½¿ç”¨èªªæ˜'
        : '<i class="fas fa-question-circle me-2"></i>User Guide');
    }
  }
  function runFixes(){
    updateUnitOptionTexts();
    updateHelpButton();
  }
  document.addEventListener('DOMContentLoaded', runFixes);
  var langSel = document.getElementById('language');
  if (langSel) { langSel.addEventListener('change', runFixes); }
  window.addEventListener('load', runFixes);
})();
</script>

<script>
// v2 i18n: tables, algorithm options, load/help modals
(function(){
  function getLang(){
    var el = document.getElementById('language');
    return el ? el.value : 'zh';
  }
  function updateAlgorithmOptions(){
    var lang = getLang();
    var sel = document.getElementById('algorithmSelector');
    if (!sel) return;
    var labels = (lang === 'zh')
      ? { AutoBest: 'è‡ªå‹•æœ€æ…³æ–™', BFD: 'BFD', FFD: 'FFD', SizeGrouping: 'æ™ºèƒ½å„ªåŒ–' }
      : { AutoBest: 'Auto Best Saving', BFD: 'BFD', FFD: 'FFD', SizeGrouping: 'Smart Optimization' };
    Array.from(sel.options).forEach(function(opt){
      if (labels[opt.value]) opt.textContent = labels[opt.value];
    });
  }
  function updateTableHeaders(){
    var lang = getLang();
    var cutHead = document.querySelector('#cuttingItemsTable thead');
    if (cutHead) {
      var ths = cutHead.querySelectorAll('th');
      if (ths.length >= 4) {
        if (lang === 'zh') {
          ths[0].textContent = 'é•·åº¦';
          ths[1].textContent = 'æ•¸é‡';
          ths[2].textContent = 'ç”¨é€”';
          ths[3].textContent = 'æ“ä½œ';
        } else {
          ths[0].textContent = 'Length';
          ths[1].textContent = 'Quantity';
          ths[2].textContent = 'Purpose';
          ths[3].textContent = 'Action';
        }
      }
    }
    var matHead = document.querySelector('#materialItemsTable thead');
    if (matHead) {
      var ths2 = matHead.querySelectorAll('th');
      if (ths2.length >= 3) {
        if (lang === 'zh') {
          ths2[0].textContent = 'ææ–™é•·åº¦';
          ths2[1].textContent = 'æ•¸é‡';
          ths2[2].textContent = 'æ“ä½œ';
        } else {
          ths2[0].textContent = 'Material Length';
          ths2[1].textContent = 'Quantity';
          ths2[2].textContent = 'Action';
        }
      }
    }
  }
  function updateLoadModalTexts(){
    var lang = getLang();
    var label = document.getElementById('loadSchemeModalLabel');
    if (label) label.textContent = (lang === 'zh') ? 'è¼‰å…¥æ–¹æ¡ˆ' : 'Load Scheme';
    var body = document.querySelector('#loadSchemeModal .modal-body');
    if (body) {
      var h6s = body.querySelectorAll('h6');
      if (h6s[0]) h6s[0].textContent = (lang === 'zh') ? 'ğŸ“ å¾æª”æ¡ˆä¸Šè¼‰æ–¹æ¡ˆ' : 'ğŸ“ Upload scheme from file';
      if (h6s[1]) h6s[1].textContent = (lang === 'zh') ? 'ğŸ“‹ å·²å„²å­˜çš„æ–¹æ¡ˆ' : 'ğŸ“‹ Saved schemes';
      var uploadBtn = body.querySelector('button.btn.btn-primary');
      if (uploadBtn) uploadBtn.innerHTML = (lang === 'zh') ? 'ğŸ“¤ ä¸Šè¼‰' : 'ğŸ“¤ Upload';
    }
    var footerCancel = document.querySelector('#loadSchemeModal .modal-footer .btn.btn-secondary');
    if (footerCancel) footerCancel.textContent = (lang === 'zh') ? 'å–æ¶ˆ' : 'Cancel';
  }
  function updateHelpModalFooter(){
    var lang = getLang();
    var closeBtn = document.querySelector('#helpModal .modal-footer .btn.btn-secondary');
    if (closeBtn) closeBtn.textContent = (lang === 'zh') ? 'é—œé–‰' : 'Close';
  }
  function runAll(){
    updateAlgorithmOptions();
    updateTableHeaders();
    updateLoadModalTexts();
    updateHelpModalFooter();
  }
  document.addEventListener('DOMContentLoaded', runAll);
  window.addEventListener('load', runAll);
  var langSel = document.getElementById('language');
  if (langSel) langSel.addEventListener('change', runAll);
})();
</script>

<script>
// Ensure saw thickness unit updates when unit changes or on load
(function(){
  function bind(){
    document.addEventListener('DOMContentLoaded', function(){ updateInputLabels(); });
    window.addEventListener('load', function(){ updateInputLabels(); });
    var u = document.getElementById('unit');
    if (u) u.addEventListener('change', updateInputLabels);
    var g = document.getElementById('globalCutUnit');
    if (g) g.addEventListener('change', updateInputLabels);
  }
  bind();
})();
</script>

<script>
// v5: Robust sync for saw thickness unit label
(function(){
  function getUnit(){
    var u = document.getElementById('unit');
    if (u && u.value) return u.value;
    var g = document.getElementById('globalCutUnit');
    return g && g.value ? g.value : 'metric';
  }
  function getLang(){
    var l = document.getElementById('language');
    return l && l.value ? l.value : 'zh';
  }
  function applySawUnit(){
    var unit = getUnit();
    var lang = getLang();
    var label = document.getElementById('sawThicknessUnitLabel');
    var input = document.getElementById('sawThickness');
    if (!label || !input) return;
    if (unit === 'imperial' || unit === 'imperial_decimal'){
      label.textContent = (lang === 'zh') ? 'åˆ†' : 'eighth';
      input.setAttribute('placeholder','1/8');
    } else {
      label.textContent = (lang === 'zh') ? 'æ¯«ç±³' : 'mm';
      input.setAttribute('placeholder','3.2');
    }
  }
  function bind(){
    document.addEventListener('DOMContentLoaded', applySawUnit);
    window.addEventListener('load', applySawUnit);
    var u = document.getElementById('unit');
    if (u) u.addEventListener('change', applySawUnit);
    var g = document.getElementById('globalCutUnit');
    if (g) g.addEventListener('change', applySawUnit);
    var l = document.getElementById('language');
    if (l) l.addEventListener('change', applySawUnit);
    // Safety: periodic sync to avoid other code overwriting
    setInterval(applySawUnit, 500);
  }
  bind();
})();
</script>

<style>
/* Increase vertical spacing between input blocks in Cutting Items and Materials */
#cutting-items-card .card-body, #materials-card .card-body { padding-top: 1.25rem; padding-bottom: 1.5rem; }
#cutting-items-card { margin-bottom: 1.25rem !important; }
#materials-card { margin-top: 1.25rem !important; margin-bottom: 1.25rem !important; }
/* Add extra spacing between each input row */
#cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1rem; }
#cutting-items-card .row.g-2, #materials-card .row.g-2 { margin-bottom: 0.75rem; }
/* Extra bottom space after controls row */
#cuttingItems .controls-row { margin-top: 0.75rem; margin-bottom: 1.25rem; }
/* Make overall section taller on mobile */
@media (max-width: 767.98px) {
  #cutting-items-card .card-body, #materials-card .card-body { padding-top: 1.5rem; padding-bottom: 2rem; }
  #cutting-items-card { margin-bottom: 2.5rem !important; }
  #materials-card { margin-top: 2.5rem !important; margin-bottom: 2.5rem !important; }
  #cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1.25rem; }
}
</style>

<style>
/* v2: Increase vertical spacing further for Cutting Items and Materials sections */
#cutting-items-card .card-body, #materials-card .card-body { padding-top: 2rem !important; padding-bottom: 2.5rem !important; }
#cutting-items-card { margin-bottom: 3rem !important; }
#materials-card { margin-top: 3rem !important; margin-bottom: 3rem !important; }
/* Increase spacing between each input row */
#cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1.5rem !important; }
#cutting-items-card .row.g-2, #materials-card .row.g-2 { margin-bottom: 1.25rem !important; }
/* Extra spacing after controls row */
#cuttingItems .controls-row { margin-top: 1rem !important; margin-bottom: 1.75rem !important; }
/* Mobile: even more generous spacing */
@media (max-width: 767.98px) {
  #cutting-items-card .card-body, #materials-card .card-body { padding-top: 2.25rem !important; padding-bottom: 3rem !important; }
  #cutting-items-card { margin-bottom: 3.25rem !important; }
  #materials-card { margin-top: 3.25rem !important; margin-bottom: 3.25rem !important; }
  #cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1.75rem !important; }
}
</style>

<style>
/* v3: Precisely adjust spacing as requested */
/* 1) Increase gap BETWEEN the length row (horizontal) and the next quantity row */
#cutting-items-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
#cutting-items-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }

#materials-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
#materials-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }

/* 2) Minimize bottom spacing of both sections (as small as possible) */
#cutting-items-card .card-body, #materials-card .card-body { padding-bottom: 0.25rem !important; }
#cutting-items-card { margin-bottom: 0 !important; }
#materials-card { margin-bottom: 0 !important; }

/* Optional: keep controls-row compact at bottom */
#cuttingItems .controls-row { margin-bottom: 0.5rem !important; }

/* Mobile: keep the same focusâ€”big gap between the two rows, tiny bottom space */
@media (max-width: 767.98px) {
  #cutting-items-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
  #cutting-items-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }
  #materials-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
  #materials-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }
  #cutting-items-card .card-body, #materials-card .card-body { padding-bottom: 0.25rem !important; }
}
</style>
