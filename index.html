<!DOCTYPE html>
<html lang="zh">
<head>
<script>
/* Anti-flash：在畫面渲染前，先套用主題/字體（避免先閃灰色畫面） */
(function(){
  try {
    var saved = localStorage.getItem('aluminum_cut_user_prefs_v1');
    var theme = 'normal';
    var fontSize = '';
    if (saved) {
      var s = JSON.parse(saved);
      if (s && s.theme === 'sepia') theme = 'sepia';
      if (s && s.fontSize) fontSize = s.fontSize;
    }
    document.documentElement.classList.add(theme === 'sepia' ? 'preload-sepia' : 'preload-normal');
    document.documentElement.classList.add('no-transitions');
    if (fontSize) document.documentElement.style.fontSize = fontSize;
  } catch(e) {}
})();
</script>
<style>
      /* Equalize height and look for algorithm select and saw thickness input */
      #algorithmSelector.equal-height,
      #sawThickness.equal-height { height: 40px !important; }
      .equalize .form-control,
      .equalize .input-group-text { height: 40px !important; }
      .equalize .input-group-text { background-color: #f8f9fa; border-color: #ccc; color: #212529; }
      #algorithmSelector.equal-height { padding-top: .25rem !important; padding-bottom: .25rem !important; font-size: 1rem !important; }

      @media (max-width: 767.98px) {
        #settings-card .row.g-3:nth-of-type(1) > .col-md-3:nth-child(3),
        #settings-card .row.g-3:nth-of-type(1) > .col-md-3:nth-child(4) {
          flex: 0 0 50% !important;
          max-width: 50% !important;
        }
      }
    </style>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>鋁材切割排版 (間距修正完成)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
        body {
            background-color: #2c3e50;
            background-image:
              linear-gradient(135deg, rgba(255,255,255,0.06) 0, rgba(255,255,255,0.06) 1px, transparent 1px, transparent 12px),
              linear-gradient(45deg,  rgba(0,0,0,0.10) 0, rgba(0,0,0,0.10) 1px, transparent 1px, transparent 12px);
            background-size: 24px 24px;
            background-attachment: fixed;
            color: #fff;
            padding: 8px;
        }

        .container-fluid {
            max-width: 1600px;
            margin: auto;
            padding-left: 6px !important;
            padding-right: 6px !important;
        }

        .container-fluid {
            transition: filter .18s ease, transform .18s ease;
        }

        body.modal-open .container-fluid {
            filter: blur(6px) saturate(.95);
            transform: scale(0.995);
        }

        .modal-backdrop.show {
            background-color: rgba(0,0,0,0.35);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 1;
        }

        #helpModal .modal-content {
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 18px 40px rgba(0,0,0,.35);
        }

        #helpModal .modal-header {
            background: linear-gradient(135deg, #1f3b73, #3b82f6);
            color: #fff;
            border-bottom: none;
        }

        #helpModal .modal-title {
            font-weight: 900;
            letter-spacing: .5px;
        }

        #helpModal .modal-body {
            background: linear-gradient(180deg, #ffffff 0%, #f6f7fb 100%);
            color: #111;
        }

        .help-guide {
            --hg-accent: #2563eb;
        }

        .help-guide .hg-lead {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(37, 99, 235, 0.08);
            border: 1px solid rgba(37, 99, 235, 0.18);
            margin-bottom: 14px;
        }

        .help-guide .hg-lead i {
            color: var(--hg-accent);
            margin-top: 2px;
        }

        .help-guide .hg-section-title {
            font-weight: 900;
            font-size: 1.05rem;
            margin: 16px 0 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-guide .hg-steps {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        @media (max-width: 767.98px) {
            .help-guide .hg-steps {
                grid-template-columns: 1fr;
            }
        }

        .help-guide .hg-step {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 12px 12px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.06);
        }

        .help-guide .hg-step .hg-step-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .help-guide .hg-badge {
            font-weight: 900;
            font-size: .82rem;
            padding: 4px 9px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.12);
            color: #1d4ed8;
            border: 1px solid rgba(37, 99, 235, 0.25);
        }

        .help-guide .hg-step h6 {
            margin: 0;
            font-weight: 900;
        }

        .help-guide .hg-step p {
            margin: 0;
            color: #374151;
            line-height: 1.55;
        }

        .help-guide .hg-tips {
            background: #111827;
            color: #fff;
            border-radius: 12px;
            padding: 12px 14px;
            border: 1px solid rgba(255,255,255,0.12);
        }

        .help-guide .hg-tips ul {
            margin: 8px 0 0;
            padding-left: 18px;
        }

        .help-guide .hg-tips li {
            margin: 6px 0;
            color: rgba(255,255,255,0.92);
        }

        .row { --bs-gutter-x: .75rem; }

        .card {
            background-color: #454d55;
            border: 1px solid #6c757d;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .card-body-light {
            background-color: #e9ecef;
            color: #212529;
            background-image:
              repeating-linear-gradient(
                90deg,
                rgba(255,255,255,0.50) 0px,
                rgba(255,255,255,0.50) 1px,
                rgba(0,0,0,0.05) 2px,
                rgba(255,255,255,0.18) 4px,
                rgba(0,0,0,0.03) 6px
              ),
              linear-gradient(
                180deg,
                rgba(255,255,255,0.55) 0%,
                rgba(255,255,255,0.00) 22%,
                rgba(0,0,0,0.04) 55%,
                rgba(255,255,255,0.20) 100%
              );
            background-size: auto, 100% 100%;
        }

        .card-body {
            padding: 0.9rem;
        }

        #results-card #resultDetails {
            margin-left: -0.55rem;
            margin-right: -0.55rem;
        }
        @media (max-width: 767.98px) {
            #results-card #resultDetails {
                margin-left: -0.75rem;
                margin-right: -0.75rem;
            }
        }

        .form-control {
            background-color: #fff;
            color: #212529;
            border: 2px solid #495057;
        }

        .form-control::placeholder {
            color: #6c757d;
        }

        .form-control.is-invalid {
            border-color: #dc3545;
        }

        .form-label {
            color: inherit;
            font-weight: 500;
            font-size: 1.05em;
        }

        .small-hint {
            font-size: .9em;
            color: #6c757d;
            margin-top: 3px;
            display: block;
        }

        .card-body-light .small-hint {
            color: #5a6268;
        }

        .error-message {
            font-size: .9em;
            color: #dc3545;
            margin-top: 3px;
            display: none;
        }

        canvas {
            border: 1px solid #6c757d;
            width: 100%;
            height: auto;
            overflow-y: auto;
            background-color: #fff;
            display: block;
            margin-top: 15px;
        }

        .btn {
            transition: all 50ms ease-in-out;
            font-weight: 700;
            font-size: 1.05em;
            text-shadow: 0 0 1px #000, 0 0 1px #000;
            box-shadow: inset 1px 1px 0 rgba(255, 255, 255, .25), inset -1px -1px 0 rgba(0, 0, 0, .15), 0 1px 2px rgba(0, 0, 0, .2);
            position: relative;
        }

        .btn:hover {
            box-shadow: inset 1px 1px 0 rgba(255, 255, 255, .35), inset -1px -1px 0 rgba(0, 0, 0, .2), 0 2px 3px rgba(0, 0, 0, .25);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: inset 1px 1px 0 rgba(0, 0, 0, .2), inset -1px -1px 0 rgba(255, 255, 255, .15), inset 0 0 2px rgba(0, 0, 0, .3);
        }

        .fade-in {
            animation: fadeIn .5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }
            to {
                opacity: 1
            }
        }

        .cutting-item,
        .material-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #868e96;
        }

        .cutting-item:last-child,
        .material-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .progress {
            margin-top: 10px;
            display: none;
            height: 20px;
            background-color: #6c757d;
        }

        .progress-bar {
            background-color: #007bff;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            color: #fff;
            font-size: 12px;
            line-height: 20px;
        }

        .result-details {
            margin-top: 20px;
            font-size: .95em;
            color: #ced4da;
        }

        .result-details ul {
            padding-left: 20px;
        }

        .result-details li {
            margin-bottom: 8px;
        }

        #pageTitle {
            background: linear-gradient(45deg, #4b6cb7, #182848);
            padding: 10px 14px;
            height: 100px;
            box-sizing: border-box;
            color: #fff;
            border-radius: 10px;
            margin-bottom: 18px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, .3);
            font-size: 2.0rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            border: 2px solid #ffc107;
        }

        #titleText {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .5);
        }

        .title-nut{
            width: 112px;
            height: 112px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            background: transparent !important;
        }
        .title-nut canvas{
            width: 100% !important;
            height: 100% !important;
            display: block;
            background: transparent !important;
            border: none !important;
            margin-top: 0 !important;
        }
        @media (max-width: 767.98px){
            .title-nut{ width: 84px; height: 84px; }
        }

        .section-header {
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            color: #fff;
            font-weight: 700;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #3a7bd5, #00d2ff);
            position: relative;
            overflow: hidden;
        }

        .section-header::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(180deg, #b9f6ca, #69f0ae);
            border-radius: 8px 0 0 8px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-indicator {
            background-color: #ffc107;
            color: #212529;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .step-badge {
            background: #495057;
            color: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: .85em;
            margin-left: 10px;
        }

        @media (min-width: 768px) {
            .cutting-item .row>div {
                padding-right: 8px;
                padding-left: 8px;
            }
            .cutting-item .col-md-4 {
                flex: 0 0 40%;
                max-width: 40%;
            }
            .cutting-item .col-md-3 {
                flex: 0 0 20%;
                max-width: 20%;
            }
            .cutting-item .col-md-4.purpose-col {
                flex: 0 0 30%;
                max-width: 30%;
            }
            .cutting-item .col-md-1 {
                flex: 0 0 10%;
                max-width: 10%;
            }
            .material-item .col-md-5 {
                flex: 0 0 70%;
                max-width: 70%;
            }
            .material-item .col-md-2 {
                flex: 0 0 30%;
                max-width: 30%;
            }
            .length-input-group .form-control {
                font-size: 1rem;
                padding: 6px;
            }
            .length-input-group .col-md-2 {
                flex: 0 0 25%;
                max-width: 25%;
            }
            .length-input-group .col-md-1 {
                flex: 0 0 15%;
                max-width: 15%;
            }
            .unit-select {
                max-width: 100%;
            }
            .form-control.cutQty,
            .form-control.materialQty {
                max-width: 100px;
            }
            .form-control.cutPurpose {
                max-width: 100%;
            }
        }

        @media (max-width: 767.98px) {
            body {
                padding: 10px;
            }
            .card-body {
                padding: 1rem;
            }
            h2#pageTitle {
                font-size: 1.5rem;
            }
            .form-label {
                font-size: 1.05em;
            }
            .error-message,
            .small-hint {
                font-size: .85em;
                margin-top: 2px;
            }
            .button-group>.btn {
                width: 100%;
                margin-bottom: 10px;
            }
            .button-group>.btn:last-child {
                margin-bottom: 0;
            }
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .quantity-needed,
        .schemes-identical {
            color: #ffc107;
            font-weight: 700;
            margin-top: 10px;
        }

        .scheme-selector {
            margin: 15px 0;
        }

        .scheme-selector button {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        #colorLegend {
            margin-top: 15px;
            display: none;
        }

        .color-legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #6c757d;
        }

        @media (max-width: 767.98px) {
            .color-legend-item {
                display: flex;
                margin-bottom: 8px;
            }
        }

        .form-check-label {
            display: flex;
            flex-direction: column;
        }

        .form-check-label .description {
            font-size: .85em;
            color: #6c757d;
            margin-top: 2px;
        }

        .length-input-group .form-control {
            font-size: 1.1rem;
            padding: 8px;
        }

        .unit-select {
            max-width: 160px;
            white-space: nowrap;
        }

        @media (max-width: 767.98px) {
            .length-input-group .form-control {
                font-size: .95rem;
                padding: 6px;
            }
            .unit-select {
                max-width: 140px;
                white-space: nowrap;
            }
        }

        .unit-select.metric-active {
            background-color: #28a745;
            color: #fff;
            border-color: #28a745;
        }

        .unit-select.imperial-active {
            background-color: #17a2b8;
            color: #fff;
            border-color: #17a2b8;
        }

        .waste-label {
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            position: absolute;
            background-color: #fff;
            padding: 2px 4px;
            border: 1px solid #000;
            z-index: 10;
            pointer-events: none;
        }

        @media print {
            body>.container-fluid>:not(.card):not(#pageTitle) {
                display: none;
            }
            #settings-card:not(.print-section) {
                display: none;
            }
            #cutting-items-card:not(.print-section) {
                display: none;
            }
            #materials-card:not(.print-section) {
                display: none;
            }
            #results-card:not(.print-section) {
                display: none;
            }
            #results-card #resultDetails:not(.print-section-results) {
                display: none;
            }
            #results-card #cuttingCanvas:not(.print-section-visualization) {
                display: none;
            }
            #results-card #colorLegend:not(.print-section-legend) {
                display: none;
            }
            #results-card .quantity-needed:not(.print-section-results) {
                display: none;
            }
            #results-card .scheme-selector:not(.print-section-results) {
                display: none;
            }
            .card {
                border: 1px solid #000;
                box-shadow: none;
                background-color: #fff;
                color: #000;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }
            .card-body-light {
                background-color: #fff;
                color: #000;
            }
            h3 {
                color: #000;
            }
            .form-control {
                border: none;
                background-color: transparent;
            }
            .error-message,
            .small-hint,
            button {
                display: none !important;
            }
            canvas {
                max-width: 100%;
                height: auto !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            #progressBar {
                display: none;
            }
            #pageTitle {
                display: block;
                text-align: center;
                margin-bottom: 20px;
            }
            .color-swatch {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        .saw-thickness-input{ position: relative; display: block; width: 100%; }
        .saw-thickness-input .form-control{
            width: 100% !important;
            max-width: none !important;
            height: 40px !important;
            padding-right: 56px !important;
            margin-right: 0 !important;
            box-sizing: border-box;
        }
        .saw-thickness-input .unit-label{
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            height: 40px;
            line-height: 40px;
            white-space: nowrap;
            font-size: .95em;
            background: transparent;
            margin: 0 !important;
            padding: 0 2px;
            pointer-events: none;
        }
        @media (max-width: 767.98px){
            .saw-thickness-input .form-control{ width: 100% !important; max-width: none !important; padding-right: 56px !important; }
            .saw-thickness-input .unit-label{ right: 8px; font-size: .9em; }
        }

        .btn {
            padding: .5rem 1rem;
            min-width: 44px;
            min-height: 44px;
        }

        input,
        select,
        textarea {
            min-height: 44px;
        }

        .canvas-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .zoom-btn {
            padding: .25rem .5rem;
            font-size: .8rem;
        }

        .save-scheme-btn {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: #fff;
        }

        .save-scheme-btn:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        .load-scheme-btn {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: #fff;
        }

        .load-scheme-btn:hover {
            background-color: #5a32a3;
            border-color: #512da8;
        }

        .help-btn {
            background-color: #6c757d;
            border-color: #5a6268;
            color: #fff;
        }

        .help-btn:hover {
            background-color: #5a6268;
        }

        .top-tools {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: -16px 0 16px 0;
            flex-wrap: wrap;
        }
        .top-tools .tool-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 0 !important;
            min-height: 0 !important;
            line-height: 1;
            box-shadow: none !important;
            text-shadow: none !important;
        }
        .top-tools .tool-btn i { margin: 0 !important; }
        .top-tools .tool-btn .tool-text { font-size: 0.82rem; font-weight: 800; }

        .top-tools .tool-btn.tool-btn-soft {
            background: #e9ecef !important;
            border: 1px solid #adb5bd !important;
            color: #212529 !important;
        }
        .top-tools .tool-btn.tool-btn-soft:hover {
            background: #dee2e6 !important;
            border-color: #9aa3ab !important;
        }

        body.light-mode {
            background-color: #f3f5f7;
            color: #212529;
        }
        body.light-mode .card {
            background-color: #ffffff;
            color: #212529;
            border-color: rgba(0,0,0,0.12);
        }
        body.light-mode .section-header {
            color: #fff;
        }

        .modal-content {
            color: #212529;
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-control {
            border-width: 1px !important;
            border-color: #ccc !important;
        }

        .form-control:focus {
            border-color: #999 !important;
            box-shadow: 0 0 0 .1rem rgba(0, 0, 0, .05) !important;
        }

        .form-select {
            border-width: 1px !important;
            border-color: #ccc !important;
        }

        .form-select:focus {
            border-color: #999 !important;
            box-shadow: 0 0 0 .1rem rgba(0, 0, 0, .05) !important;
        }

        @keyframes rulerWiggle {
            0%,100% { transform: rotate(0) }
            25% { transform: rotate(10deg) }
            50% { transform: rotate(-5deg) }
            75% { transform: rotate(5deg) }
        }

        .ruler-anim {
            display: inline-block;
            animation: rulerWiggle 2.5s ease-in-out infinite;
            transform-origin: center center;
        }

        @media (max-width: 767.98px) {
            #pageTitle {
                gap: 14px;
            }
            #pageTitle i.fa-layer-group,
            #pageTitle i.fa-ruler-combined {
                font-size: 1.7rem !important;
                color: #ffc107 !important;
            }
            body.lang-zh #titleText {
                white-space: nowrap;
            }
            body.lang-en #titleText {
                white-space: normal;
                display: inline-block;
                max-width: 18ch;
                text-align: center;
                line-height: 1.1;
            }
        }

        .edit-mode {
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5) !important;
        }

        .table-row-edit {
            background-color: #fff3cd !important;
            color: #212529 !important;
        }

        .btn-sm {
            min-width: auto;
            min-height: auto;
            padding: .25rem .5rem;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .update-btn {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .update-btn:hover {
            background-color: #e0a800;
            border-color: #d39e00;
            color: #212529;
        }

#cuttingItems .controls-row { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
#cuttingItems .controls-row .btn { flex: 1 1 0; white-space: nowrap; padding: .5rem .75rem; height: 38px !important; display: flex !important; align-items: center !important; justify-content: center !important; }
#cuttingItems .controls-row .unit-select { max-width: 45px !important; min-width: 45px !important; width: 45px !important; height: 38px !important; font-size: 1rem !important; text-align: center !important; padding: 0.2rem 0.1rem !important; box-sizing: border-box !important; }
@media (max-width: 390px) {
  #cuttingItems .controls-row { gap: 6px; }
  #cuttingItems .controls-row .unit-select { max-width: 45px !important; min-width: 45px !important; width: 45px !important; height: 38px !important; }
}

        .controls-row {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            width: 100%;
        }
        .controls-row .btn {
            flex: 1 1 0;
            min-width: 86px; height: 38px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-sizing: border-box !important; border-width: 1px !important; }
        .controls-row .unit-select {
            flex: 0 0 auto;
            min-width: 45px !important;
            max-width: 45px !important; width: 45px !important; height: 38px !important; font-size: 1rem !important; text-align: center !important; padding: 0.2rem 0.1rem !important; box-sizing: border-box !important;
            white-space: nowrap;
            -webkit-appearance: none;
            appearance: none;
        }
        @media (max-width: 767.98px) {
            .controls-row { gap: 6px; }
            .controls-row .btn { font-size: .95rem; padding: .40rem .60rem; white-space: nowrap; flex: 1 1 0; min-width: 90px; height: 38px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-sizing: border-box !important; border-width: 1px !important; }
            .controls-row .unit-select { width: auto !important; flex: 0 0 clamp(72px, 18vw, 96px); max-width: 45px !important; min-width: 45px !important; width: 45px !important; height: 38px !important; box-sizing: border-box !important; white-space: nowrap; font-size: 1rem; text-align: center; padding: 0 !important; line-height: 38px !important; -webkit-appearance: none; appearance: none; display: inline-flex; align-items: center; justify-content: center; }
        }
</style>
<style>
body select.unit-select.metric-active {
    background-color: #198754 !important;
    color: white !important;
    border-color: #157347 !important;
    background-image: none !important;
}
body select.unit-select.imperial-active {
    background-color: #0d6efd !important;
    color: white !important;
    border-color: #0a58ca !important;
    background-image: none !important;
}
body select.unit-select option {
    background-color: white;
    color: black;
}
    select.unit-select.btn-3d,
    #globalCutUnit,
    #globalMaterialUnit {
        text-align: center !important;
        font-size: 1rem !important;
        font-weight: 700 !important;
        padding: 0.25rem 0.1rem !important;
        height: 38px !important;
        width: 45px !important;
        max-width: 45px !important;
        min-width: 45px !important;
        box-sizing: border-box !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        background-image: none !important;
        line-height: 1.2 !important;
        transition: all 50ms ease-in-out !important;
        box-shadow: inset 2px 2px 0 rgba(255, 255, 255, .6), 
                    inset -2px -2px 0 rgba(0, 0, 0, .4), 
                    0 2px 3px rgba(0, 0, 0, .4) !important;
        position: relative !important;
        border: 2px solid #495057 !important;
    }
    #unit {
        width: 60px !important;
        max-width: 60px !important;
        min-width: 60px !important;
        font-size: 1.1rem !important;
        text-align: center !important;
        font-weight: 700 !important;
        padding: 0.25rem 0.1rem !important;
        height: 38px !important;
        box-sizing: border-box !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        background-image: none !important;
        line-height: 1.2 !important;
    }
    select.unit-select.btn-3d:active,
    #unit:active,
    #globalCutUnit:active,
    #globalMaterialUnit:active {
        transform: translateY(2px) !important;
        box-shadow: inset 2px 2px 0 rgba(0, 0, 0, .5), 
                    inset -2px -2px 0 rgba(255, 255, 255, .3), 
                    inset 0 0 3px rgba(0, 0, 0, .6) !important;
    }
    #globalCutUnit[style],
    #globalMaterialUnit[style] {
        min-width: 45px !important;
        max-width: 45px !important;
        width: 45px !important;
    }
    
        #unitLabel { font-weight: 400 !important; font-size: 0.875rem !important; margin-bottom: 0.5rem !important; display: block !important; text-align: left !important; }
        #unit.unit-select { height: 40px !important; width: 40px !important; min-width: 40px !important; max-width: 40px !important; font-size: 1rem !important; font-weight: 500 !important; text-align: center !important; text-align-last: center !important; padding: 0 !important; line-height: 40px !important; border-radius: 6px !important; cursor: pointer !important; box-sizing: border-box !important; }
        #unit.unit-select option { text-align: center; padding: 8px; }
        select.unit-select:not(#unit), .unit-select:not(#unit) { text-align: center !important; text-align-last: center !important; padding-left: 0 !important; padding-right: 0 !important; line-height: 38px !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; }
        </style>
<style>
      .optional-note { font-size: .85em; color: #ffc107; margin-left: 0; }
      .card-body-light .optional-note { color: #d39e00; }
    </style>
<style>
      @media (max-width: 767.98px) {
        #settings-card .row.g-3 > .col-6.col-md-3 { display: inline-block !important; width: 50% !important; vertical-align: top; }
      }
    </style>
<style>
      .saw-thickness-input{ position: relative; display: block; width: 100%; }
      .saw-thickness-input .form-control{
        width: 100% !important;
        max-width: none !important;
        height: 40px !important;
        padding-left: 12px !important;
        padding-right: 56px !important;
        box-sizing: border-box;
      }
      .saw-thickness-input .unit-label{
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        margin: 0 !important;
        padding: 0 2px;
        height: 40px;
        line-height: 40px;
        background: transparent;
        white-space: nowrap;
        pointer-events: none;
        color:#212529;
      }
      #sawThicknessLabel + .saw-thickness-input + #sawThicknessHint { margin-top: 6px; }
      @media (max-width: 767.98px){
        .saw-thickness-input .form-control{ width: 100% !important; max-width: none !important; padding-left: 12px !important; padding-right: 56px !important; }
        .saw-thickness-input .unit-label{ right: 8px; font-size: .9rem; }
      }
      #algorithmSelector.equal-height { height:40px !important; padding-top:.25rem !important; padding-bottom:.25rem !important; font-size:1rem !important; }
    </style>
<style>
.card {
    margin-bottom: 15px !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    border: 1px solid rgba(0,0,0,0.125);
}
#cutting-items-card, #materials-card, #settings-card {
    margin-top: 0 !important;
    margin-bottom: 15px !important;
}
.section-header {
    border-radius: 0 !important;
    margin-bottom: 0 !important;
    width: 100%;
}
.card-body {
    padding-top: 1.5rem !important;
}
</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
h2#pageTitle { display: grid !important; grid-template-columns: 112px 1fr 112px !important; align-items: center !important; gap: 0 12px !important; height: auto !important; min-height: 70px !important; padding: 6px 14px !important; }
h2#pageTitle .title-nut { grid-column: 1; justify-self: start !important; width: 90px !important; height: 90px !important; }
h2#pageTitle #titleText { grid-column: 2; text-align: center !important; justify-self: center !important; width: 100% !important; display: block !important; font-size: 2.2rem !important; }
h2#pageTitle .fa-ruler-combined { grid-column: 3; justify-self: center !important; margin-left: 0 !important; }
body.lang-zh h2#pageTitle #titleText { white-space: nowrap !important; }
body.lang-en h2#pageTitle #titleText { white-space: normal !important; max-width: 18ch; line-height: 1.1; }

@media (max-width: 767.98px) {
  h2#pageTitle { grid-template-columns: 70px 1fr 70px !important; gap: 0 8px !important; min-height: 56px !important; padding: 4px 10px !important; }
  h2#pageTitle .title-nut { width: 70px !important; height: 70px !important; }
  h2#pageTitle #titleText { font-size: 1.6rem !important; }
}

.opt-summary-box {
  border: 2px solid #388e3c !important;
  border-left: 6px solid #4caf50 !important;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
  border-radius: 12px !important;
}

.opt-material-box {
  border: 2px solid #868e96 !important;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
  border-radius: 10px !important;
  margin-top: 20px !important;
}

body.light-mode .opt-summary-box,
body.light-mode .opt-material-box {
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2) !important;
  border-color: #adb5bd !important;
}
body.light-mode .opt-summary-box {
  border-color: #4caf50 !important;
}

body.sepia-mode .opt-summary-box {
  border: 2px solid #8b6f47 !important;
  border-left: 6px solid #8b6f47 !important;
  box-shadow: 0 8px 24px rgba(101, 67, 33, 0.4) !important;
}
body.sepia-mode .opt-material-box {
  border: 2px solid #8b6f47 !important;
  box-shadow: 0 8px 24px rgba(101, 67, 33, 0.4) !important;
}

@media print {
  .opt-summary-box, .opt-material-box {
    box-shadow: none !important;
    border: 1px solid #000 !important;
    border-radius: 0 !important;
  }
}
</style>
<style>
html.preload-normal,
html.preload-normal body {
  background-color: #2c3e50 !important;
  background-image:
    linear-gradient(135deg, rgba(255,255,255,0.06) 0, rgba(255,255,255,0.06) 1px, transparent 1px, transparent 12px),
    linear-gradient(45deg,  rgba(0,0,0,0.10) 0, rgba(0,0,0,0.10) 1px, transparent 1px, transparent 12px) !important;
  background-size: 24px 24px !important;
  background-attachment: fixed !important;
  color: #fff !important;
}
html.preload-sepia,
html.preload-sepia body {
  background-color: #f5e6cc !important;
  background-image:
    linear-gradient(135deg, rgba(139,111,71,0.08) 0, rgba(139,111,71,0.08) 1px, transparent 1px, transparent 12px),
    linear-gradient(45deg, rgba(0,0,0,0.06) 0, rgba(0,0,0,0.06) 1px, transparent 1px, transparent 12px) !important;
  background-size: 24px 24px !important;
  background-attachment: fixed !important;
  color: #3e2a10 !important;
}
body:not(.sepia-mode) {
  background-color: #2c3e50 !important;
  background-image:
    linear-gradient(135deg, rgba(255,255,255,0.06) 0, rgba(255,255,255,0.06) 1px, transparent 1px, transparent 12px),
    linear-gradient(45deg,  rgba(0,0,0,0.10) 0, rgba(0,0,0,0.10) 1px, transparent 1px, transparent 12px) !important;
  background-size: 24px 24px !important;
  background-attachment: fixed !important;
  color: #fff !important;
}
html.no-transitions, html.no-transitions * {
  transition: none !important;
  animation: none !important;
}
</style>
</head>
<body>
<div class="container-fluid">
<h2 class="d-flex justify-content-center align-items-center text-nowrap mb-4" id="pageTitle">
<span id="titleNut" class="title-nut" aria-hidden="true"></span>
<span id="titleText">鋁材切割排版</span>
<i class="fa-solid fa-ruler-combined fa-2x ms-2 ruler-anim"></i>
</h2>

<div class="top-tools" aria-label="工具列">
  <button class="btn tool-btn tool-btn-soft" id="fontIncBtn" type="button" title="文字放大" onclick="adjustFontSize(1)"><span class="tool-text">A+</span></button>
  <button class="btn tool-btn tool-btn-soft" id="fontDecBtn" type="button" title="文字縮細" onclick="adjustFontSize(-1)"><span class="tool-text">A-</span></button>
  <button class="btn tool-btn tool-btn-soft" id="themeToggleBtn" type="button" title="光明/黑暗" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
</div>

<div class="card" id="settings-card"><div class="section-header">
<div class="section-title">
<i class="fa-solid fa-gear fa-lg me-2"></i>
<span id="settingsTitle">設置</span>
</div>
<span class="step-indicator">1/4</span>
</div>
<div class="card-body card-body-light">

<div class="row g-3">
<div class="col-6 col-md-3">
<label class="form-label" id="languageLabel">語言:</label>
<select class="form-select form-select-sm" id="language" onchange="updateLanguage()">
<option value="zh">中文</option>
<option value="en">English</option>
</select>
</div>
<div class="col-md-3">
<div class="d-flex flex-column align-items-start">
<label class="form-label mb-2" id="unitLabel" style="font-size: 0.875rem;">顯示單位:</label>
<select class="form-select unit-select" id="unit" onchange="updateInputLabels()" style="height: 40px; width: 40px; font-size: 1rem; font-weight: 500;">
<option selected="selected" value="metric">公</option>
<option value="imperial">英</option>
<option value="imperial_decimal">英(D)</option>
</select>
</div>
</div>
<div class="col-6 col-md-3">
<label class="form-label" id="algorithmLabel">算法:</label>
<select class="form-select equal-height" id="algorithmSelector">
<option value="AutoBest">自動最慳料</option>
<option value="BFD">BFD</option>
<option value="FFD">FFD</option>
<option value="SizeGrouping">智能優化</option>
</select>
</div>
<div class="col-6 col-md-3">
<label class="form-label" id="sawThicknessLabel">鋸片厚度:</label>
<div class="saw-thickness-input equalize">
  <input class="form-control" id="sawThickness" placeholder="3.2" style="width: 100px;"/>
  <span class="unit-label" id="sawThicknessUnitLabel">毫米</span>
</div>
<div class="small-hint" id="sawThicknessHint">例如: 3.2 (毫米) 或 1 (分)</div>
<div class="error-message" id="sawThicknessError"></div>
</div>
</div>
<div class="row g-3 mt-2">
<div class="col-md-12">
<label class="form-label" id="schemeManagementLabel">方案管理:</label>
<div class="d-flex gap-2">
<button class="btn btn-sm save-scheme-btn" id="saveSchemeButton" onclick="saveScheme()">
<i class="fas fa-save me-1"></i>儲存方案
                            </button>
<button class="btn btn-sm load-scheme-btn" id="loadSchemeButton" onclick="loadScheme()">
<i class="fas fa-folder-open me-1"></i>載入方案
                            </button>
</div>
</div>
</div>
</div>
</div>
<div class="card" id="cutting-items-card"><div class="section-header">
<div class="section-title">
<i class="fa-solid fa-list-check fa-lg me-2"></i>
<span id="cuttingItemsTitle">切割項目</span>
</div>
<span class="step-indicator">2/4</span>
</div>
<div class="card-body card-body-light">

<div id="cuttingItems">
<div class="cutting-item">
<div class="row g-3 align-items-center">
<div class="col-md-12">
<label class="form-label cutLengthLabel">長度:</label>
<div class="row g-2 length-input-group d-flex align-items-end">
<div class="col">
<input class="form-control form-control-lg cutLengthPart" data-part="ft" inputmode="decimal" placeholder="0" step="0.001" type="number"/>
<label class="small-hint cutLengthHint">米</label>
<div class="error-message cutLengthError"></div>
</div>
<div class="col">
<input class="form-control form-control-lg cutLengthPart" data-part="in" inputmode="decimal" placeholder="0" step="0.001" type="number"/>
<label class="small-hint cutLengthHint">厘米</label>
</div>
<div class="col">
<input class="form-control form-control-lg cutLengthPart" data-part="eighth" inputmode="decimal" placeholder="0" step="0.001" type="number"/>
<label class="small-hint cutLengthHint">毫米</label>
</div>
</div>
</div>
<div class="row g-2 mt-2">
<div class="col-6">
<label class="form-label cutQtyLabel">數量:</label>
<input class="cutQty form-control form-control-sm" min="0" placeholder="0" type="number"/>
<div class="small-hint cutQtyHint">例如：5</div>
</div>
<div class="col-6">
<label class="form-label cutPurposeLabel">用途:</label>
<input class="cutPurpose form-control form-control-sm" placeholder=""/>
<div class="small-hint cutPurposeHint">例如：邊框</div>
</div>
</div>
<div class="d-flex mt-2 gap-2 flex-nowrap align-items-center controls-row">
<button class="btn btn-success btn-sm flex-fill" id="addCuttingButton" onclick="addCuttingItem()">
<i class="fas fa-plus me-1"></i>新增項目
                                </button>
<button class="btn btn-secondary btn-sm flex-fill" id="clearCuttingButton" onclick="clearCuttingInputs()">
<i class="fas fa-times me-1"></i>清除輸入
                                </button>
<select class="form-select form-select-sm unit-select cutLengthUnit flex-shrink-0" id="globalCutUnit" style="min-width:110px; max-width:160px; white-space:nowrap">
<option selected="selected" value="metric">公</option>
<option value="imperial">英</option>
</select>
</div>
</div>
</div>
</div>
<table class="table table-sm table-hover mt-3" id="cuttingItemsTable">
<thead>
<tr class="table-active">
<th>長度</th>
<th>數量</th>
<th>用途</th>
<th class="text-center" style="width:100px">操作</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div class="d-flex gap-2 mt-2">
<button class="btn btn-warning btn-sm update-btn" id="updateCuttingButton" onclick="updateCuttingItem()" style="display:none">
<i class="fas fa-edit me-1"></i>更新項目
                    </button>
</div>
<input id="editingCuttingIndex" type="hidden" value="-1"/>
</div>
</div>
<div class="card mt-3" id="materials-card"><div class="section-header">
<div class="section-title">
<i class="fa-solid fa-ruler-combined fa-lg me-2"></i>
<span id="materialTitle">材料</span>
</div>
<span class="step-indicator">3/4</span>
</div>
<div class="card-body card-body-light">

<div id="materialItems">
<div class="material-item">
<div class="row g-3 align-items-center">
<div class="col-md-12">
<label class="form-label materialLengthLabel">材料長度:</label>
<div class="row g-2 length-input-group d-flex align-items-end">
<div class="col">
<input class="form-control form-control-lg materialLengthPart" data-part="ft" inputmode="decimal" placeholder="0" step="0.001" type="number"/>
<label class="small-hint materialLengthHint">米</label>
<div class="error-message materialLengthError"></div>
</div>
<div class="col">
<input class="form-control form-control-lg materialLengthPart" data-part="in" inputmode="decimal" placeholder="0" step="0.001" type="number"/>
<label class="small-hint materialLengthHint">厘米</label>
</div>
<div class="col">
<input class="form-control form-control-lg materialLengthPart" data-part="eighth" inputmode="decimal" placeholder="0" step="0.001" type="number"/>
<label class="small-hint materialLengthHint">毫米</label>
</div>
</div>
</div>
<div class="row g-2 mt-2">
<div class="col-6">
<label class="form-label materialQtyLabel">數量:</label>
<input class="materialQty form-control form-control-sm" min="1" type="number" value="1"/>
<div class="small-hint materialQtyHint">10</div>
</div>
</div>
<div class="d-flex mt-2 gap-2 flex-nowrap align-items-center controls-row">
<button class="btn btn-success btn-sm flex-fill" id="addMaterialButton" onclick="addMaterialItem()">
<i class="fas fa-plus me-1"></i>
</button>
<button class="btn btn-secondary btn-sm flex-fill" id="clearMaterialButton" onclick="clearMaterialInputs()">
<i class="fas fa-times me-1"></i>
</button>
<select class="form-select form-select-sm unit-select materialLengthUnit flex-shrink-0 btn-3d" id="globalMaterialUnit">
<option selected="selected" value="metric">公</option>
<option value="imperial">英</option>
</select>
</div>
</div>
</div>
</div>
<table class="table table-sm table-hover mt-3" id="materialItemsTable">
<thead>
<tr class="table-active">
<th>材料長度</th>
<th>數量</th>
<th class="text-center" style="width:100px">操作</th>
<th class="text-center" style="width:120px">使用狀態</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div class="d-flex gap-2 mt-2">
<button class="btn btn-warning btn-sm update-btn" id="updateMaterialButton" onclick="updateMaterialItem()" style="display:none">
<i class="fas fa-edit me-1"></i>更新材料
                    </button>
</div>
<input id="editingMaterialIndex" type="hidden" value="-1"/>
</div>
</div>
<div class="card" id="results-card"><div class="section-header">
<div class="section-title">
<i class="fa-solid fa-chart-bar fa-lg me-2"></i>
<span id="resultTitle">切割結果</span>
</div>
<span class="step-indicator">4/4</span>
</div>
<div class="card-body text-center">

<div class="button-group">
<button class="btn" id="calculateButton" onclick="calculate()">
<i class="fas fa-calculator me-2"></i>計算
                    </button>
<button class="btn btn-danger" id="resetButton" onclick="reset()">
<i class="fas fa-undo me-2"></i>重置
                    </button>
<button class="btn btn-success" id="printOptionsButton" onclick="showPrintOptions()" style="display:none">
<i class="fas fa-print me-2"></i>列印選項
                    </button>
<button class="btn btn-success" id="printButton" onclick="triggerPrint()" style="display:none">
<i class="fas fa-print me-2"></i>列印報告
                    </button>
<button class="btn help-btn" id="helpButton" onclick="showHelp()">
<i class="fas fa-question-circle me-2"></i>使用說明
                    </button>
</div>
<div class="progress mt-3" id="progressBar" style="display:none">
<div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="progress-bar progress-bar-striped progress-bar-animated" id="progressBarInner" role="progressbar" style="width:0%">
</div>
<span class="progress-text" id="progressText"></span>
</div>
<div class="scheme-selector" id="schemeSelector" style="display:none">
<h5 id="schemeTitle">選擇切割方案:</h5>
<div id="schemeButtons"></div>
</div>
<div class="result-details text-start" id="resultDetails" style="display:none">
<div id="optimizationResults"></div>
<div class="quantity-needed" id="quantityNeededMessage" style="display:none"></div>
</div>
<canvas class="mt-3" id="cuttingCanvas" style="display:none"></canvas>
<div id="colorLegend" style="display:none">
<h4><span id="colorLegendTitle"><i class="fa-solid fa-palette me-2"></i>顏色圖例</span></h4>
<div id="colorLegendItems"></div>
</div>
</div>
</div>
</div>
<div aria-hidden="true" aria-labelledby="printOptionsModalLabel" class="modal fade" id="printOptionsModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="printOptionsModalLabel">列印選項</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p id="printSelectLabel">選擇要列印的內容:</p>
<div class="form-check">
<input checked="checked" class="form-check-input" id="printSettings" type="checkbox"/>
<label class="form-check-label" for="printSettings" id="printSettingsLabel">
                            <span id="printSettingsText">設置</span>
                            <span class="description" id="printSettingsDesc">語言、顯示單位、鋸片厚度</span>
</label>
</div>
<div class="form-check">
<input checked="checked" class="form-check-input" id="printCuttingItems" type="checkbox"/>
<label class="form-check-label" for="printCuttingItems" id="printCuttingItemsLabel">
                            <span id="printCuttingItemsText">切割項目</span>
                            <span class="description" id="printCuttingItemsDesc">所有輸入的切割長度、數量和用途</span>
</label>
</div>
<div class="form-check">
<input checked="checked" class="form-check-input" id="printMaterials" type="checkbox"/>
<label class="form-check-label" for="printMaterials" id="printMaterialsLabel">
                            <span id="printMaterialsText">材料</span>
                            <span class="description" id="printMaterialsDesc">所有輸入的材料長度和數量</span>
</label>
</div>
<div class="form-check">
<input checked="checked" class="form-check-input" id="printResults" type="checkbox"/>
<label class="form-check-label" for="printResults" id="printResultsLabel">
                            <span id="printResultsText">切割結果 (包含摘要)</span>
                            <span class="description" id="printResultsDesc">優化後的切割方案詳情</span>
</label>
</div>
<div class="form-check">
<input checked="checked" class="form-check-input" id="printVisualization" type="checkbox"/>
<label class="form-check-label" for="printVisualization" id="printVisualizationLabel">
                            <span id="printVisualizationText">視覺化圖表</span>
                            <span class="description" id="printVisualizationDesc">切割方案的圖形化展示</span>
</label>
</div>
<div class="form-check">
<input checked="checked" class="form-check-input" id="printLegend" type="checkbox"/>
<label class="form-check-label" for="printLegend" id="printLegendLabel">
                            <span id="printLegendText">顏色圖例</span>
                            <span class="description" id="printLegendDesc">切割件長度對應顏色說明</span>
</label>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" id="printCancelBtn" type="button">取消</button>
<button class="btn btn-primary" onclick="triggerPrint()" id="printConfirmBtn" type="button">確認列印</button>
</div>
</div>
</div>
</div>
<div aria-hidden="true" aria-labelledby="saveSchemeModalLabel" class="modal fade" id="saveSchemeModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="saveSchemeModalLabel">儲存方案</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="mb-3">
<label class="form-label" for="schemeName" id="schemeNameLabel">方案名稱:</label>
<input class="form-control" id="schemeName" placeholder="輸入方案名稱"/>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" id="saveCancelBtn" type="button">取消</button>
<button class="btn btn-primary" onclick="confirmSaveScheme()" id="saveConfirmBtn" type="button">確認儲存</button>
</div>
</div>
</div>
</div>
<div aria-hidden="true" aria-labelledby="loadSchemeModalLabel" class="modal fade" id="loadSchemeModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="loadSchemeModalLabel">載入方案</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #ddd">
<h6>📁 從檔案上載方案</h6>
<input accept=".json" id="schemeFileInput" style="margin-top:10px" type="file"/>
<button class="btn btn-primary" id="uploadSchemeBtn" onclick="uploadSchemeFile()" style="margin-top:10px;background-color:#0056b3;color:#fff;font-weight:700;font-size:15px;padding:8px 18px;border:none;border-radius:4px" type="button">📤
                            上載</button>
</div>
<div>
<h6>📋 已儲存的方案</h6>
<div id="savedSchemesList"></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" id="loadCancelBtn" type="button">取消</button>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="helpModalLabel" class="modal fade" id="helpModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="helpModalLabel">使用說明</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="helpContent"></div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" id="helpCloseBtn" type="button">關閉</button>
</div>
</div>
</div>
</div>

<div aria-hidden="true" aria-labelledby="qrModalLabel" class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">QR碼</h5>
        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-column align-items-center gap-3">
          <div id="qrCodeBox"></div>
          <div class="w-100">
            <div class="small text-muted" id="qrUrlLabel">網址：</div>
            <div class="small" style="word-break:break-all" id="qrUrlText"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button" id="qrCloseBtn">關閉</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  (function(){
    var baseFontPx = 16;
    try {
      var cs = window.getComputedStyle(document.documentElement);
      var px = parseFloat(cs.fontSize);
      if(!isNaN(px) && px>8 && px<40) baseFontPx = px;
    } catch(e) {}

    window.adjustFontSize = function(delta){
      baseFontPx = Math.max(12, Math.min(22, baseFontPx + delta));
      document.documentElement.style.fontSize = baseFontPx + 'px';
    };

    window.toggleTheme = function(){
      document.body.classList.toggle('light-mode');
      try { localStorage.setItem('theme_light_mode', document.body.classList.contains('light-mode') ? '1' : '0'); } catch(e) {}
    };

    window.toggleInfo = function(){
      return;
    };

    window.showQr = function(){
      try {
        var langSel = document.getElementById('language');
        var lang = langSel ? langSel.value : 'zh';
        var url = 'https://cw91020251212.github.io/cutting_optimizer_v5_auto/';
        var urlText = document.getElementById('qrUrlText');
        if (urlText) urlText.textContent = url;

        var box = document.getElementById('qrCodeBox');
        if (box) {
          box.innerHTML = '';
          var size = 220;
          new QRCode(box, {
            text: url,
            width: size,
            height: size,
            correctLevel: QRCode.CorrectLevel.M
          });
        }

        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
          var modalEl = document.getElementById('qrModal');
          if (modalEl) new bootstrap.Modal(modalEl).show();
        }
      } catch(e) {
        console.error(e);
      }
    };

    try {
      if(localStorage.getItem('theme_light_mode') === '1') document.body.classList.add('light-mode');
    } catch(e) {}
  })();
</script>
<script>
        let INCH_TO_MM = 25.4;
        let MM_TO_INCH = 1 / INCH_TO_MM;
        let FT_TO_MM = 304.8;
        let M_TO_MM = 1000;
        let CM_TO_MM = 10;
        let EIGHTH_TO_MM = INCH_TO_MM / 8;

        function escapeHTML(str) {
            if (str === null || str === undefined) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        let editingCuttingIndex = -1;
        let editingMaterialIndex = -1;

        const elements = {
            titleText: {
                zh: "鋁材切割排版",
                en: "Aluminum Cutting<br>Optimization"
            },
            settingsTitle: {
                zh: "設置",
                en: "Settings"
            },
            languageLabel: {
                zh: "語言:",
                en: "Language:"
            },
            unitLabel: {
                zh: "顯示單位:",
                en: "Result Display Unit:"
            },
            algorithmLabel: {
                zh: "算法:",
                en: "Algorithm:"
            },
            sawThicknessLabel: {
                zh: "鋸片厚度:",
                en: "Saw Thickness:"
            },

            schemeManagementLabel: {
                zh: "方案管理:",
                en: "Scheme Management:"
            },
            saveSchemeButton: {
                zh: '<i class="fas fa-save me-1"></i>儲存方案',
                en: '<i class="fas fa-save me-1"></i>Save Scheme'
            },
            loadSchemeButton: {
                zh: '<i class="fas fa-folder-open me-1"></i>載入方案',
                en: '<i class="fas fa-folder-open me-1"></i>Load Scheme'
            },
            cuttingItemsTitle: {
                zh: "切割項目",
                en: "Cutting Items"
            },
            cutLengthLabel: {
                zh: "長度:",
                en: "Length:"
            },
            cutQtyLabel: {
                zh: "數量:",
                en: "Quantity:"
            },
            cutPurposeLabel: {
                zh: "用途:",
                en: "Purpose:"
            },
            addCuttingButton: {
                zh: '<i class="fas fa-plus me-1"></i>新增項目',
                en: '<i class="fas fa-plus me-1"></i>Add Item'
            },
            updateCuttingButton: {
                zh: '<i class="fas fa-edit me-1"></i>更新項目',
                en: '<i class="fas fa-edit me-1"></i>Update Item'
            },
            clearCuttingButton: {
                zh: '<i class="fas fa-times me-1"></i>清除輸入',
                en: '<i class="fas fa-times me-1"></i>Clear Input'
            },
            materialTitle: {
                zh: "材料",
                en: "Material"
            },
            materialLengthLabel: {
                zh: "材料長度:",
                en: "Material Length:"
            },
            materialQtyLabel: {
                zh: "數量:",
                en: "Quantity:"
            },
            addMaterialButton: {
                zh: '<i class="fas fa-plus me-1"></i>新增材料',
                en: '<i class="fas fa-plus me-1"></i>Add Material'
            },
            updateMaterialButton: {
                zh: '<i class="fas fa-edit me-1"></i>更新材料',
                en: '<i class="fas fa-edit me-1"></i>Update Material'
            },
            clearMaterialButton: {
                zh: '<i class="fas fa-times me-1"></i>清除輸入',
                en: '<i class="fas fa-times me-1"></i>Clear Input'
            },
            calculateButton: {
                zh: '<i class="fas fa-calculator me-2"></i>計算',
                en: '<i class="fas fa-calculator me-2"></i>Calculate'
            },
            resetButton: {
                zh: '<i class="fas fa-undo me-2"></i>重置',
                en: '<i class="fas fa-undo me-2"></i>Reset'
            },
            printOptionsButton: {
                zh: '<i class="fas fa-print me-2"></i>列印選項',
                en: '<i class="fas fa-print me-2"></i>Print Options'
            },
            printButton: {
                zh: '<i class="fas fa-print me-2"></i>列印報告',
                en: '<i class="fas fa-print me-2"></i>Print Report'
            },
            schemeTitle: {
                zh: "選擇切割方案:",
                en: "Select Cutting Scheme:"
            },
            resultTitle: {
                zh: "切割結果",
                en: "Cutting Results"
            },
            colorLegendTitle: {
                zh: '<i class="fa-solid fa-palette me-2"></i>顏色圖例',
                en: '<i class="fa-solid fa-palette me-2"></i>Color Legend'
            },
            cutLengthHint: {
                zh: "例如：5 0 0",
                en: "e.g., 5 0 0"
            },
            cutQtyHint: {
                zh: "例如：5",
                en: "e.g., 5"
            },
            cutPurposeHint: {
                zh: "例如：邊框",
                en: "e.g., Frame"
            },
            materialLengthHint: {
                zh: "例如：5 0 0",
                en: "e.g., 5 0 0"
            },
            materialQtyHint: {
                zh: "例如：10",
                en: "e.g., 10"
            },
            sawThicknessHint: {
                zh: "例如: 3.2 (毫米) 或 1 (分)",
                en: "e.g., 3.2 (mm) or 1 (fen)"
            }
        };

        function updateLanguage() {
            let lang = document.getElementById("language").value;
            document.body.classList.toggle("lang-en", lang === "en");
            document.body.classList.toggle("lang-zh", lang === "zh");

            for (const [id, texts] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element && texts[lang]) {
                    if (id === "titleText") {
                        element.innerHTML = texts[lang];
                    } else {
                        element.innerHTML = texts[lang];
                    }
                }
            }

            document.querySelectorAll(".cutLengthLabel").forEach(e => e.textContent = elements.cutLengthLabel[lang]);
            document.querySelectorAll(".cutQtyLabel").forEach(e => e.textContent = elements.cutQtyLabel[lang]);
            document.querySelectorAll(".cutPurposeLabel").forEach(e => e.textContent = elements.cutPurposeLabel[lang]);
            document.querySelectorAll(".materialLengthLabel").forEach(e => e.textContent = elements.materialLengthLabel[lang]);
            document.querySelectorAll(".materialQtyLabel").forEach(e => e.textContent = elements.materialQtyLabel[lang]);
            document.querySelectorAll("#addCuttingButton").forEach(e => e.innerHTML = elements.addCuttingButton[lang]);
            document.querySelectorAll("#updateCuttingButton").forEach(e => e.innerHTML = elements.updateCuttingButton[lang]);
            document.querySelectorAll("#clearCuttingButton").forEach(e => e.innerHTML = elements.clearCuttingButton[lang]);
            document.querySelectorAll("#addMaterialButton").forEach(e => e.innerHTML = elements.addMaterialButton[lang]);
            document.querySelectorAll("#updateMaterialButton").forEach(e => e.innerHTML = elements.updateMaterialButton[lang]);
            document.querySelectorAll("#clearMaterialButton").forEach(e => e.innerHTML = elements.clearMaterialButton[lang]);
            document.querySelectorAll(".cutLengthHint").forEach(e => e.textContent = elements.cutLengthHint[lang]);
            document.querySelectorAll(".cutQtyHint").forEach(e => e.textContent = elements.cutQtyHint[lang]);
            document.querySelectorAll(".cutPurposeHint").forEach(e => e.textContent = elements.cutPurposeHint[lang]);
            document.querySelectorAll(".materialLengthHint").forEach(e => e.textContent = elements.materialLengthHint[lang]);
            document.querySelectorAll(".materialQtyHint").forEach(e => e.textContent = elements.materialQtyHint[lang]);

            document.getElementById("sawThicknessHint").textContent = elements.sawThicknessHint[lang];

            const modalTitles = {
                printOptionsModalLabel: lang === "zh" ? "列印選項" : "Print Options",
                saveSchemeModalLabel: lang === "zh" ? "儲存方案" : "Save Scheme",
                loadSchemeModalLabel: lang === "zh" ? "載入方案" : "Load Scheme",
                helpModalLabel: lang === "zh" ? "使用說明" : "User Guide",
                qrModalLabel: lang === "zh" ? "QR碼" : "QR Code"
            };

            for (const [id, text] of Object.entries(modalTitles)) {
                const element = document.getElementById(id);
                if (element) element.textContent = text;
            }

            var t = {
              fontInc: (lang === 'zh') ? '文字放大' : 'Increase font size',
              fontDec: (lang === 'zh') ? '文字縮細' : 'Decrease font size',
              theme:   (lang === 'zh') ? '光明/黑暗' : 'Light/Dark',
              help:    (lang === 'zh') ? '幫助' : 'Help',
              qr:      (lang === 'zh') ? 'QR碼' : 'QR Code',
              qrUrl:   (lang === 'zh') ? '網址：' : 'URL:',
              close:   (lang === 'zh') ? '關閉' : 'Close'
            };
            var b1=document.getElementById('fontIncBtn'); if(b1) b1.title=t.fontInc;
            var b2=document.getElementById('fontDecBtn'); if(b2) b2.title=t.fontDec;
            var b3=document.getElementById('themeToggleBtn'); if(b3) b3.title=t.theme;
            var b4=document.getElementById('newHelpBtn'); if(b4) b4.title=t.help;
            var b5=document.getElementById('qrBtn'); if(b5) b5.title=t.qr;
            var qrUrlLabel=document.getElementById('qrUrlLabel'); if(qrUrlLabel) qrUrlLabel.textContent=t.qrUrl;
            var qrCloseBtn=document.getElementById('qrCloseBtn'); if(qrCloseBtn) qrCloseBtn.textContent=t.close;

            updateInputLabels();
            // --- Extra modal & static UI translations ---
            var _xl = lang;
            // Print options modal
            var _ps = document.getElementById('printSelectLabel');        if(_ps) _ps.textContent = _xl==='zh'?'選擇要列印的內容:':'Select content to print:';
            var _psT = document.getElementById('printSettingsText');       if(_psT) _psT.textContent = _xl==='zh'?'設置':'Settings';
            var _psD = document.getElementById('printSettingsDesc');       if(_psD) _psD.textContent = _xl==='zh'?'語言、顯示單位、鋸片厚度':'Language, unit, saw thickness';
            var _pcT = document.getElementById('printCuttingItemsText');   if(_pcT) _pcT.textContent = _xl==='zh'?'切割項目':'Cutting Items';
            var _pcD = document.getElementById('printCuttingItemsDesc');   if(_pcD) _pcD.textContent = _xl==='zh'?'所有輸入的切割長度、數量和用途':'All entered cut lengths, quantities and purposes';
            var _pmT = document.getElementById('printMaterialsText');      if(_pmT) _pmT.textContent = _xl==='zh'?'材料':'Materials';
            var _pmD = document.getElementById('printMaterialsDesc');      if(_pmD) _pmD.textContent = _xl==='zh'?'所有輸入的材料長度和數量':'All entered material lengths and quantities';
            var _prT = document.getElementById('printResultsText');        if(_prT) _prT.textContent = _xl==='zh'?'切割結果 (包含摘要)':'Cutting Results (incl. summary)';
            var _prD = document.getElementById('printResultsDesc');        if(_prD) _prD.textContent = _xl==='zh'?'優化後的切割方案詳情':'Optimized cutting plan details';
            var _pvT = document.getElementById('printVisualizationText');  if(_pvT) _pvT.textContent = _xl==='zh'?'視覺化圖表':'Visualization Chart';
            var _pvD = document.getElementById('printVisualizationDesc');  if(_pvD) _pvD.textContent = _xl==='zh'?'切割方案的圖形化展示':'Graphical display of the cutting plan';
            var _plT = document.getElementById('printLegendText');         if(_plT) _plT.textContent = _xl==='zh'?'顏色圖例':'Color Legend';
            var _plD = document.getElementById('printLegendDesc');         if(_plD) _plD.textContent = _xl==='zh'?'切割件長度對應顏色說明':'Color key for cut piece lengths';
            var _pcB = document.getElementById('printCancelBtn');          if(_pcB) _pcB.textContent = _xl==='zh'?'取消':'Cancel';
            var _pCo = document.getElementById('printConfirmBtn');         if(_pCo) _pCo.textContent = _xl==='zh'?'確認列印':'Confirm Print';
            // Save scheme modal
            var _snL = document.getElementById('schemeNameLabel');         if(_snL) _snL.textContent = _xl==='zh'?'方案名稱:':'Scheme Name:';
            var _sn  = document.getElementById('schemeName');              if(_sn)  _sn.placeholder  = _xl==='zh'?'輸入方案名稱':'Enter scheme name';
            var _scB = document.getElementById('saveCancelBtn');           if(_scB) _scB.textContent = _xl==='zh'?'取消':'Cancel';
            var _sCo = document.getElementById('saveConfirmBtn');          if(_sCo) _sCo.textContent = _xl==='zh'?'確認儲存':'Confirm Save';
            // Load scheme modal cancel
            var _lcB = document.getElementById('loadCancelBtn');           if(_lcB) _lcB.textContent = _xl==='zh'?'取消':'Cancel';
            // Help modal close
            var _hcB = document.getElementById('helpCloseBtn');            if(_hcB) _hcB.textContent = _xl==='zh'?'關閉':'Close';
            // Help button in main UI
            var _hBtn = document.getElementById('helpButton');
            if(_hBtn) _hBtn.innerHTML = '<i class="fas fa-question-circle me-2"></i>'+(_xl==='zh'?'使用說明':'User Guide');

            var _usB = document.getElementById('uploadSchemeBtn'); if(_usB) _usB.innerHTML = _xl==='zh'?'📤 上載':'📤 Upload';
        }

        function updateImperialLabels(template) {
            const hintLabels = template.querySelectorAll(".small-hint");
            if (hintLabels.length >= 3) {
                const lang = document.getElementById("language").value;
                if (lang === "zh") {
                    hintLabels[0].textContent = "尺";
                    hintLabels[1].textContent = "寸";
                    hintLabels[2].textContent = "分";
                } else {
                    hintLabels[0].textContent = "ft";
                    hintLabels[1].textContent = "in";
                    hintLabels[2].textContent = "eighth";
                }
            }
        }

        function updateMetricLabels(template) {
            const hintLabels = template.querySelectorAll(".small-hint");
            if (hintLabels.length >= 3) {
                const lang = document.getElementById("language").value;
                if (lang === "zh") {
                    hintLabels[0].textContent = "米";
                    hintLabels[1].textContent = "厘米";
                    hintLabels[2].textContent = "毫米";
                } else {
                    hintLabels[0].textContent = "m";
                    hintLabels[1].textContent = "cm";
                    hintLabels[2].textContent = "mm";
                }
            }
        }

        function updateInputLabels() {
            const unitElem = document.getElementById("unit") || document.getElementById("globalCutUnit");
            const unit = unitElem ? unitElem.value : "metric";
            const lang = document.getElementById("language").value;

            const labels = {
                imperial: lang === "zh" ? ["尺", "寸", "分"] : ["ft", "in", "eighth"],
                imperial_decimal: lang === "zh" ? ["", "寸", ""] : ["", "in", ""],
                metric: lang === "zh" ? ["米", "厘米", "毫米"] : ["m", "cm", "mm"]
            };

            const cuttingEditMode = document.querySelector("#cuttingItems .cutting-item.edit-mode");
            const materialEditMode = document.querySelector("#materialItems .material-item.edit-mode");

            const settingsUnitSelect = document.getElementById("unit");
            if (settingsUnitSelect) {
                settingsUnitSelect.classList.remove("metric-active", "imperial-active");
                if (settingsUnitSelect.value === "metric") {
                    settingsUnitSelect.classList.add("metric-active");
                } else {
                    settingsUnitSelect.classList.add("imperial-active");
                }
            }

            document.querySelectorAll('.length-input-group').forEach(group => {
                if (group.closest('.edit-mode')) return;
                let unitSelect = group.querySelector('.unit-select');
                if (!unitSelect) {
                    if (group.closest('#cuttingItems')) unitSelect = document.getElementById('globalCutUnit');
                    else if (group.closest('#materialItems')) unitSelect = document.getElementById('globalMaterialUnit');
                }
                const unitType = unitSelect ? unitSelect.value : 'metric';
                const hintLabels = labels[unitType] || labels.metric;
                group.querySelectorAll('.form-control').forEach((input, index) => {
                    const hint = input.nextElementSibling;
                    if (hint && hint.classList.contains('small-hint')) {
                        hint.textContent = hintLabels[index] || '';
                    }
                });
            });

            const sawThicknessInput = document.getElementById("sawThickness");
            const sawThicknessUnit = document.getElementById("sawThicknessUnitLabel");
            if (unit === "imperial" || unit === "imperial_decimal") {
                sawThicknessUnit.textContent = lang === "zh" ? "分" : "fen";
                sawThicknessInput.setAttribute("placeholder", "1");
                if (!sawThicknessInput.value || sawThicknessInput.value === "3.2") {
                    sawThicknessInput.value = "1";
                }
            } else {
                sawThicknessUnit.textContent = lang === "zh" ? "毫米" : "mm";
                sawThicknessInput.setAttribute("placeholder", "3.2");
                if (!sawThicknessInput.value || sawThicknessInput.value === "1/8") {
                    sawThicknessInput.value = "3.2";
                }
            }
        }

        function parseSawThickness() {
            const input = document.getElementById("sawThickness").value.trim();
            const errorElement = document.getElementById("sawThicknessError");
            const unitElem = document.getElementById("unit") || document.getElementById("globalCutUnit");
            const unit = unitElem ? unitElem.value : "metric";
            const lang = document.getElementById("language").value;

            if (!input) {
                errorElement.textContent = lang === "zh" ? "請輸入鋸片厚度" : "Please enter saw thickness";
                errorElement.style.display = "block";
                document.getElementById("sawThickness").classList.add("is-invalid");
                return { value: 0, error: errorElement.textContent };
            }

            if (input.includes("/")) {
                const parts = input.split("/");
                if (parts.length === 2) {
                    const numerator = parseFloat(parts[0]);
                    const denominator = parseFloat(parts[1]);
                    if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                        const value = (numerator / denominator) * (unit === "imperial" ? EIGHTH_TO_MM : 1);
                        errorElement.textContent = "";
                        errorElement.style.display = "none";
                        document.getElementById("sawThickness").classList.remove("is-invalid");
                        return { value: value, error: "" };
                    }
                }
            }

            const value = parseFloat(input);
            if (isNaN(value) || value <= 0) {
                errorElement.textContent = lang === "zh" ? "請輸入有效的鋸片厚度" : "Please enter valid saw thickness";
                errorElement.style.display = "block";
                document.getElementById("sawThickness").classList.add("is-invalid");
                return { value: 0, error: errorElement.textContent };
            }

            const finalValue = unit === "imperial" ? value * EIGHTH_TO_MM : value;
            errorElement.textContent = "";
            errorElement.style.display = "none";
            document.getElementById("sawThickness").classList.remove("is-invalid");
            return { value: finalValue, error: "" };
        }

        window.parseLength = function(lengthInputGroup) {
            let unitSelect = lengthInputGroup.querySelector('.unit-select');
            if (!unitSelect) {
                if (lengthInputGroup.closest('#cuttingItems'))  unitSelect = document.getElementById('globalCutUnit');
                else if (lengthInputGroup.closest('#materialItems')) unitSelect = document.getElementById('globalMaterialUnit');
            }
            const unit = unitSelect ? unitSelect.value : 'metric';
            const inputs = lengthInputGroup.querySelectorAll('.form-control');
            const lang = document.getElementById('language')?.value || 'zh';
            let totalMM = 0, formatHint = 'standard';
            if (unit === 'imperial') {
                const ft = parseFloat(inputs[0].value) || 0;
                const inch = parseFloat(inputs[1].value) || 0;
                const eighth = parseFloat(inputs[2].value) || 0;
                if (isNaN(ft) && isNaN(inch) && isNaN(eighth)) {
                    return { value: 0, error: (lang === 'zh' ? '長度無效，請檢查' : 'Invalid length, please check') };
                }
                totalMM = ft * FT_TO_MM + inch * INCH_TO_MM + eighth * (INCH_TO_MM / 8);
            } else {
                const m = parseFloat(inputs[0].value) || 0;
                const cm = parseFloat(inputs[1].value) || 0;
                const mm = parseFloat(inputs[2].value) || 0;
                if (isNaN(m) && isNaN(cm) && isNaN(mm)) {
                    return { value: 0, error: (lang === 'zh' ? '長度無效，請檢查' : 'Invalid length, please check') };
                }
                totalMM = m * M_TO_MM + cm * CM_TO_MM + mm;
            }
            if (totalMM < 0) {
                return { value: 0, error: (lang === 'zh' ? '長度不能為負' : 'Length cannot be negative') };
            }
            return { value: totalMM, error: '' };
        };

        function validateInput(inputGroup, errorElement) {
            const result = window.parseLength(inputGroup);
            if (result.error) {
                inputGroup.querySelectorAll(".form-control").forEach(input => input.classList.add("is-invalid"));
                errorElement.textContent = result.error;
                errorElement.style.display = "block";
            } else {
                inputGroup.querySelectorAll(".form-control").forEach(input => input.classList.remove("is-invalid"));
                errorElement.textContent = "";
                errorElement.style.display = "none";
            }
        }

        window.formatLengthForDisplay = function(mm, unit) {
            if (unit === 'imperial_decimal') {
                return parseFloat((mm / 25.4).toFixed(3)) + '"';
            }
            if (unit !== 'imperial') {
                return mm.toFixed(2) + ' mm';
            }
            var totalInches = mm * MM_TO_INCH;
            var precise = parseFloat(totalInches.toFixed(8));
            var inchesWhole = Math.floor(precise);
            var frac = precise - inchesWhole;
            var eighths = Math.round(frac * 8);
            if (eighths === 8) { inchesWhole += 1; eighths = 0; }
            var result = '';
            var _lang = (document.getElementById('language')?document.getElementById('language').value:'zh');
            var _inUnit  = _lang === 'zh' ? ' 寸' : ' in';
            var _egUnit  = _lang === 'zh' ? ' 分' : ' eighth';
            var _zero    = _lang === 'zh' ? '0 寸' : '0 in';
            if (inchesWhole > 0) result += inchesWhole + _inUnit;
            if (eighths > 0) result += (result ? '' : '') + eighths + _egUnit;
            return result.trim() || _zero;
        };

        function clearCuttingInputs() {
            const template = document.querySelector("#cuttingItems .cutting-item");
            template.querySelectorAll(".form-control").forEach(input => {
                if (!input.classList.contains("cutQty") && !input.classList.contains("cutPurpose")) {
                    input.value = "";
                }
            });
            template.querySelector(".cutQty").value = "0";
            template.querySelector(".cutPurpose").value = "";
            
            template.querySelector('[data-part="ft"]').focus();
        }

        function clearMaterialInputs() {
            const template = document.querySelector("#materialItems .material-item");
            template.querySelectorAll(".form-control").forEach(input => {
                if (!input.classList.contains("materialQty")) {
                    input.value = "";
                }
            });
            template.querySelector(".materialQty").value = "1";
            
            template.querySelector('[data-part="ft"]').focus();
        }

        window.enterCuttingEditMode = function(index) {
            const prevTemplate = document.querySelector('#cuttingItems .cutting-item');
            if (prevTemplate) {
                prevTemplate.classList.remove('edit-mode');
                document.querySelectorAll('#cuttingItemsTable tbody tr').forEach(r => r.classList.remove('table-row-edit'));
            }

            const row = document.querySelectorAll('#cuttingItemsTable tbody tr')[index];
            if (!row) return;

            const template = document.querySelector('#cuttingItems .cutting-item');
            const unit = row.dataset.inputUnit || 'metric';
            const lengthMM = parseFloat(row.dataset.length) || 0;
            const formatHint = row.dataset.formatHint || 'standard';

            const unitSelect = template.querySelector('.unit-select');
            if (unitSelect) {
                unitSelect.value = unit;
                const group = unitSelect.closest('.length-input-group');
                if (group) group.dataset.currentUnit = unit;
                if (typeof window.forceUpdateUI === 'function') window.forceUpdateUI(unitSelect);
            }

            if (unit === 'imperial') {
                const totalInches = lengthMM / 25.4;
                const wholeFt    = Math.floor(totalInches / 12);
                const wholeIn    = Math.floor(totalInches % 12);
                const eighths    = Math.round((totalInches % 1) * 8);
                if (formatHint === 'inches_only' || formatHint === 'inchesonly') {
                    template.querySelector('[data-part="ft"]').value   = 0;
                    template.querySelector('[data-part="in"]').value   = Math.floor(totalInches);
                    template.querySelector('[data-part="eighth"]').value = eighths;
                } else {
                    template.querySelector('[data-part="ft"]').value   = wholeFt;
                    template.querySelector('[data-part="in"]').value   = wholeIn;
                    template.querySelector('[data-part="eighth"]').value = eighths;
                }
            } else {
                const meters = Math.floor(lengthMM / 1000);
                const cm     = Math.floor((lengthMM % 1000) / 10);
                const mm     = Math.round(lengthMM % 10);
                template.querySelector('[data-part="ft"]').value   = meters;
                template.querySelector('[data-part="in"]').value   = cm;
                template.querySelector('[data-part="eighth"]').value = mm;
            }

            template.querySelector('.cutQty').value       = row.dataset.quantity || 0;
            template.querySelector('.cutPurpose').value   = row.dataset.purpose  || '';

            editingCuttingIndex = index;
            document.getElementById('editingCuttingIndex').value = index;

            template.classList.add('edit-mode');
            row.classList.add('table-row-edit');

            document.getElementById('addCuttingButton').style.display    = 'none';
            document.getElementById('updateCuttingButton').style.display = 'inline-block';

            try {
                template.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch(e) {}
        };

        window.enterMaterialEditMode = function(index) {
            const prevTemplate = document.querySelector('#materialItems .material-item');
            if (prevTemplate) {
                prevTemplate.classList.remove('edit-mode');
                document.querySelectorAll('#materialItemsTable tbody tr').forEach(r => r.classList.remove('table-row-edit'));
            }

            const row = document.querySelectorAll('#materialItemsTable tbody tr')[index];
            if (!row) return;

            const template = document.querySelector('#materialItems .material-item');

            const unit     = row.dataset.inputUnit || 'metric';
            const lengthMM = parseFloat(row.dataset.length) || 0;

            const unitSelect = template.querySelector('.unit-select');
            if (unitSelect) {
                unitSelect.value = unit;
                const group = unitSelect.closest('.length-input-group');
                if (group) group.dataset.currentUnit = unit;
                if (typeof window.forceUpdateUI === 'function') window.forceUpdateUI(unitSelect);
            }

            if (unit === 'imperial') {
                const totalInches = lengthMM / 25.4;
                template.querySelector('[data-part="ft"]').value    = Math.floor(totalInches / 12);
                template.querySelector('[data-part="in"]').value    = Math.floor(totalInches % 12);
                template.querySelector('[data-part="eighth"]').value = Math.round((totalInches % 1) * 8);
            } else {
                const meters = Math.floor(lengthMM / 1000);
                const cm     = Math.floor((lengthMM % 1000) / 10);
                const mm     = Math.round(lengthMM % 10);
                template.querySelector('[data-part="ft"]').value    = meters;
                template.querySelector('[data-part="in"]').value    = cm;
                template.querySelector('[data-part="eighth"]').value = mm;
            }

            template.querySelector('.materialQty').value = row.dataset.quantity || 1;

            editingMaterialIndex = index;
            document.getElementById('editingMaterialIndex').value = index;

            template.classList.add('edit-mode');
            row.classList.add('table-row-edit');

            document.getElementById('addMaterialButton').style.display    = 'none';
            document.getElementById('updateMaterialButton').style.display = 'inline-block';

            try {
                template.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch(e) {}
        };

        function exitCuttingEditMode() {
            const template = document.querySelector("#cuttingItems .cutting-item");
            template.classList.remove("edit-mode");
            document.querySelectorAll("#cuttingItemsTable tbody tr").forEach(row => {
                row.classList.remove("table-row-edit");
            });
            document.getElementById("addCuttingButton").style.display = "inline-block";
            document.getElementById("updateCuttingButton").style.display = "none";
            editingCuttingIndex = -1;
            document.getElementById("editingCuttingIndex").value = "-1";
            clearCuttingInputs();
            updateInputLabels();
        }

        function exitMaterialEditMode() {
            const template = document.querySelector("#materialItems .material-item");
            template.classList.remove("edit-mode");
            document.querySelectorAll("#materialItemsTable tbody tr").forEach(row => {
                row.classList.remove("table-row-edit");
            });
            document.getElementById("addMaterialButton").style.display = "inline-block";
            document.getElementById("updateMaterialButton").style.display = "none";
            editingMaterialIndex = -1;
            document.getElementById("editingMaterialIndex").value = "-1";
            clearMaterialInputs();
            updateInputLabels();
        }

        function addCuttingItem() {
            const template = document.querySelector("#cuttingItems .cutting-item");
            const lengthResult = window.parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"請輸入有效的長度":"Please enter a valid length.");
                return;
            }

            const quantity = parseInt(template.querySelector(".cutQty").value) || 0;
            if (quantity <= 0) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"數量必須大於 0":"Quantity must be greater than 0.");
                return;
            }

            const purpose = template.querySelector(".cutPurpose").value || "";
            const unit = template.querySelector(".unit-select").value;

            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                var _dLang = (document.getElementById('language')?document.getElementById('language').value:'zh');
                var _ftU = _dLang==='zh'?'尺 ':'ft ';
                var _inU = _dLang==='zh'?'寸 ':'" ';
                var _egU = _dLang==='zh'?'分':'th';
                var _z0  = _dLang==='zh'?'0寸':'0"';
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + _ftU : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + _inU : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + _egU : "");
                display = display.trim() || _z0;
            }

            const tbody = document.querySelector("#cuttingItemsTable tbody");
            const row = document.createElement("tr");

            row.dataset.length = lengthResult.value;
            row.dataset.quantity = quantity;
            row.dataset.purpose = purpose;
            row.dataset.display = display;
            row.dataset.inputUnit = unit;

            const rowIndex = tbody.children.length;
            
            row.innerHTML = `
                <td>${escapeHTML(display)}</td>
                <td>${quantity}</td>
                <td>${escapeHTML(purpose || "-")}</td>
                <td class="text-center">
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-warning" onclick="enterCuttingEditMode(Array.from(this.closest('tbody').children).indexOf(this.closest('tr')))" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'編輯':'Edit'}">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitCuttingEditMode();" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'刪除':'Delete'}">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);

            clearCuttingInputs();
        }

        function updateCuttingItem() {
            if (editingCuttingIndex === -1) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"沒有選中要編輯的項目":"No item selected for editing.");
                return;
            }

            const template = document.querySelector("#cuttingItems .cutting-item");
            const lengthResult = window.parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"請輸入有效的長度":"Please enter a valid length.");
                return;
            }

            const quantity = parseInt(template.querySelector(".cutQty").value) || 0;
            if (quantity <= 0) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"數量必須大於 0":"Quantity must be greater than 0.");
                return;
            }

            const purpose = template.querySelector(".cutPurpose").value || "";
            const unit = template.querySelector(".unit-select").value;

            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                var _dLang = (document.getElementById('language')?document.getElementById('language').value:'zh');
                var _ftU = _dLang==='zh'?'尺 ':'ft ';
                var _inU = _dLang==='zh'?'寸 ':'" ';
                var _egU = _dLang==='zh'?'分':'th';
                var _z0  = _dLang==='zh'?'0寸':'0"';
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + _ftU : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + _inU : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + _egU : "");
                display = display.trim() || _z0;
            }

            const row = document.querySelectorAll("#cuttingItemsTable tbody tr")[editingCuttingIndex];
            if (row) {
                row.dataset.length = lengthResult.value;
                row.dataset.quantity = quantity;
                row.dataset.purpose = purpose;
                row.dataset.display = display;
                row.dataset.inputUnit = unit;

                row.innerHTML = `
                    <td>${display}</td>
                    <td>${quantity}</td>
                    <td>${purpose || "-"}</td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-warning" onclick="enterCuttingEditMode(Array.from(this.closest('tbody').children).indexOf(this.closest('tr')))" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'編輯':'Edit'}">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitCuttingEditMode();" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'刪除':'Delete'}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
            }

            exitCuttingEditMode();
        }

        function addMaterialItem() {
            const template = document.querySelector("#materialItems .material-item");
            const lengthResult = window.parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"請輸入有效的材料長度":"Please enter a valid material length.");
                return;
            }

            const quantity = parseInt(template.querySelector(".materialQty").value) || 0;
            if (quantity <= 0) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"數量必須大於 0":"Quantity must be greater than 0.");
                return;
            }

            const unit = template.querySelector(".unit-select").value;

            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                var _dLang = (document.getElementById('language')?document.getElementById('language').value:'zh');
                var _ftU = _dLang==='zh'?'尺 ':'ft ';
                var _inU = _dLang==='zh'?'寸 ':'" ';
                var _egU = _dLang==='zh'?'分':'th';
                var _z0  = _dLang==='zh'?'0寸':'0"';
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + _ftU : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + _inU : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + _egU : "");
                display = display.trim() || _z0;
            }

            const tbody = document.querySelector("#materialItemsTable tbody");
            const row = document.createElement("tr");

            row.dataset.length = lengthResult.value;
            row.dataset.quantity = quantity;
            row.dataset.display = display;
            row.dataset.inputUnit = unit;

            const rowIndex = tbody.children.length;
            
            row.innerHTML = `
                <td>${display}</td>
                <td>${quantity}</td>
                <td class="text-center">
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-warning" onclick="enterMaterialEditMode(Array.from(this.closest('tbody').children).indexOf(this.closest('tr')))" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'編輯':'Edit'}">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitMaterialEditMode();" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'刪除':'Delete'}">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </td>
                <td class="usage-status text-center">-</td>
            `;

            tbody.appendChild(row);

            clearMaterialInputs();
        }

        function updateMaterialItem() {
            if (editingMaterialIndex === -1) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"沒有選中要編輯的項目":"No item selected for editing.");
                return;
            }

            const template = document.querySelector("#materialItems .material-item");
            const lengthResult = window.parseLength(template.querySelector(".length-input-group"));

            if (!lengthResult.value || lengthResult.error) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"請輸入有效的材料長度":"Please enter a valid material length.");
                return;
            }

            const quantity = parseInt(template.querySelector(".materialQty").value) || 0;
            if (quantity <= 0) {
                alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"數量必須大於 0":"Quantity must be greater than 0.");
                return;
            }

            const unit = template.querySelector(".unit-select").value;

            const ftInput = template.querySelector('[data-part="ft"]');
            const inInput = template.querySelector('[data-part="in"]');
            const eighthInput = template.querySelector('[data-part="eighth"]');

            const ftVal = ftInput.value || "0";
            const inVal = inInput.value || "0";
            const eighthVal = eighthInput.value || "0";

            let display = "";
            if (unit === "metric") {
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + "m " : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + "cm " : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + "mm" : "");
                display = display.trim() || "0mm";
            } else {
                var _dLang = (document.getElementById('language')?document.getElementById('language').value:'zh');
                var _ftU = _dLang==='zh'?'尺 ':'ft ';
                var _inU = _dLang==='zh'?'寸 ':'" ';
                var _egU = _dLang==='zh'?'分':'th';
                var _z0  = _dLang==='zh'?'0寸':'0"';
                display = (ftVal !== "0" && ftVal !== "" ? ftVal + _ftU : "") +
                    (inVal !== "0" && inVal !== "" ? inVal + _inU : "") +
                    (eighthVal !== "0" && eighthVal !== "" ? eighthVal + _egU : "");
                display = display.trim() || _z0;
            }

            const row = document.querySelectorAll("#materialItemsTable tbody tr")[editingMaterialIndex];
            if (row) {
                row.dataset.length = lengthResult.value;
                row.dataset.quantity = quantity;
                row.dataset.display = display;
                row.dataset.inputUnit = unit;

                row.innerHTML = `
                    <td>${display}</td>
                    <td>${quantity}</td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-warning" onclick="enterMaterialEditMode(Array.from(this.closest('tbody').children).indexOf(this.closest('tr')))" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'編輯':'Edit'}">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitMaterialEditMode();" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'刪除':'Delete'}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                    <td class="usage-status text-center">-</td>
                `;
            }

            exitMaterialEditMode();
        }

        function getCuttingItems() {
            let items = [];
            document.querySelectorAll("#cuttingItemsTable tbody tr").forEach(row => {
                const length = parseFloat(row.dataset.length) || 0;
                const quantity = parseInt(row.dataset.quantity) || 0;
                const purpose = row.dataset.purpose || "";
                const display = row.dataset.display || "";

                if (length > 0 && quantity > 0) {
                    items.push({
                        length: length,
                        quantity: quantity,
                        purpose: purpose,
                        display: display
                    });
                }
            });
            return items;
        }

        function getMaterialItems() {
            let items = [];
            document.querySelectorAll("#materialItemsTable tbody tr").forEach(row => {
                const length = parseFloat(row.dataset.length) || 0;
                const quantity = parseInt(row.dataset.quantity) || 0;
                const display = row.dataset.display || "";

                if (length > 0 && quantity > 0) {
                    items.push({
                        length: length,
                        quantity: quantity,
                        display: display
                    });
                }
            });
            return items;
        }

        // ----- 後處理合併函數 -----
        function optimizeBins(bins, sawThickness) {
            let changed = true;
            while (changed) {
                changed = false;
                for (let i = bins.length - 1; i >= 0; i--) {
                    if (bins.length <= 1) break;
                    for (let j = 0; j < bins.length; j++) {
                        if (i === j) continue;
                        let targetBin = bins[j];
                        let sourceBin = bins[i];
                        let usedLength = targetBin.cuts.reduce((s, c) => s + c.length, 0);
                        let kerfLength = targetBin.cuts.length > 0 ? (targetBin.cuts.length - 1) * sawThickness : 0;
                        let required = sourceBin.cuts.reduce((s, c) => s + c.length, 0);
                        let totalCuts = targetBin.cuts.length + sourceBin.cuts.length;
                        let totalKerf = (totalCuts - 1) * sawThickness;
                        if (usedLength + required + totalKerf <= targetBin.length) {
                            targetBin.cuts = targetBin.cuts.concat(sourceBin.cuts);
                            bins.splice(i, 1);
                            changed = true;
                            break;
                        }
                    }
                }
            }
            return bins;
        }

        // 以下為三種演算法（BFD、FFD、SizeGrouping）的實現，使用 createOptimizerFixed 模式
        function createOptimizerFixed(algo) {
            return function(cuts, materials, sawThickness) {
                function expandCuts(cuts) {
                    var arr = [];
                    cuts.forEach(function(it) {
                        var q = Number(it.quantity || 0);
                        for (var i = 0; i < q; i++) {
                            arr.push({ length: it.length, display: it.display || '', purpose: it.purpose || '' });
                        }
                    });
                    return arr;
                }
                function expandMaterials(mats) {
                    var arr = [];
                    mats.forEach(function(m) {
                        var q = Number(m.quantity || 0);
                        for (var i = 0; i < q; i++) {
                            arr.push({ length: Number(m.length) || 0, display: m.display || '' });
                        }
                    });
                    return arr;
                }
                function selectSmallestAdequate(availableMaterials, requiredLen) {
                    for (var i = 0; i < availableMaterials.length; i++) {
                        var m = availableMaterials[i];
                        if ((m.length || 0) >= requiredLen) {
                            availableMaterials.splice(i, 1);
                            return m.length || 0;
                        }
                    }
                    return null;
                }

                var allCuts = expandCuts(cuts);
                if (algo !== 'SizeGrouping') allCuts.sort(function(a, b) { return b.length - a.length; });
                var availableMaterials = expandMaterials(materials).sort(function(a, b) { return a.length - b.length; });
                var defaultLen = materials && materials.length ? Math.max.apply(null, materials.map(function(m) { return m.length || 0; })) : 6000;
                var bins = [];

                function placeIntoExisting(cut) {
                    var best = null, bestRem = Infinity;
                    for (var i = 0; i < bins.length; i++) {
                        var bin = bins[i];
                        var used = bin.cuts.reduce(function(s, c) { return s + c.length; }, 0);
                        var kerf = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                        var req = cut.length + (bin.cuts.length > 0 ? sawThickness : 0);
                        var rem = bin.length - (used + kerf + req);
                        if (rem >= 0 && rem < bestRem) {
                            bestRem = rem;
                            best = bin;
                        }
                    }
                    if (best) {
                        best.cuts.push(cut);
                        return true;
                    }
                    return false;
                }

                if (algo === 'FFD') {
                    allCuts.forEach(function(cut) {
                        if (placeIntoExisting(cut)) return;
                        var reqLen = cut.length;
                        var takeLen = selectSmallestAdequate(availableMaterials, reqLen);
                        if (takeLen === null) {
                            bins.push({ length: defaultLen, cuts: [cut], autoAdded: true });
                        } else {
                            bins.push({ length: takeLen, cuts: [cut], autoAdded: false });
                        }
                    });
                } else if (algo === 'SizeGrouping') {
                    var groups = {};
                    allCuts.forEach(function(c) {
                        (groups[c.length] = groups[c.length] || []).push(c);
                    });
                    Object.keys(groups).map(Number).sort(function(a, b) { return b - a; }).forEach(function(len) {
                        var group = groups[len];
                        while (group.length) {
                            var bestBin = null, bestCount = 0;
                            for (var i = 0; i < bins.length; i++) {
                                var bin = bins[i];
                                var used = bin.cuts.reduce(function(s, c) { return s + c.length; }, 0);
                                var kerf = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                                var count = 0, curr = used + kerf;
                                for (var j = 0; j < group.length; j++) {
                                    var req = len + (bin.cuts.length + count > 0 ? sawThickness : 0);
                                    if (curr + req <= bin.length) {
                                        count++;
                                        curr += req;
                                    } else break;
                                }
                                if (count > 0 && count > bestCount) {
                                    bestCount = count;
                                    bestBin = bin;
                                }
                            }
                            if (bestBin) {
                                for (var k = 0; k < bestCount; k++) bestBin.cuts.push(group.shift());
                            } else {
                                var reqLen = len;
                                var takeLen = selectSmallestAdequate(availableMaterials, reqLen);
                                var newBin = { length: (takeLen === null ? defaultLen : takeLen), cuts: [], autoAdded: (takeLen === null) };
                                var remaining = newBin.length;
                                while (group.length) {
                                    var cut = group[0];
                                    var req = cut.length + (newBin.cuts.length > 0 ? sawThickness : 0);
                                    if (req <= remaining) {
                                        newBin.cuts.push(group.shift());
                                        remaining -= req;
                                    } else break;
                                }
                                bins.push(newBin);
                            }
                        }
                    });
                } else { // BFD
                    allCuts.forEach(function(cut) {
                        if (placeIntoExisting(cut)) return;
                        var reqLen = cut.length;
                        var takeLen = selectSmallestAdequate(availableMaterials, reqLen);
                        if (takeLen === null) {
                            bins.push({ length: defaultLen, cuts: [cut], autoAdded: true });
                        } else {
                            bins.push({ length: takeLen, cuts: [cut], autoAdded: false });
                        }
                    });
                }
                return bins;
            };
        }

        window.optimizeCutsFFD = createOptimizerFixed('FFD');
        window.optimizeCutsBFD = createOptimizerFixed('BFD');
        window.optimizeCutsSizeGrouping = createOptimizerFixed('SizeGrouping');

        function updateMaterialUsageStatus(bins) {
            // 統計每種長度實際使用嘅數量（只計非自動補料）
            const usageCount = {};
            bins.forEach(bin => {
                if (!bin.autoAdded) {
                    const len = bin.length;
                    usageCount[len] = (usageCount[len] || 0) + 1;
                }
            });

            // 更新材料表格每一行
            const rows = document.querySelectorAll("#materialItemsTable tbody tr");
            rows.forEach(row => {
                const len = parseFloat(row.dataset.length);
                const qty = parseInt(row.dataset.quantity);
                const used = usageCount[len] || 0;
                let statusCell = row.querySelector(".usage-status");
                if (!statusCell) {
                    statusCell = document.createElement("td");
                    statusCell.className = "usage-status text-center";
                    row.appendChild(statusCell);
                }
                if (used >= qty) {
                    { var _sl=document.getElementById('language')?document.getElementById('language').value:'zh'; statusCell.innerHTML = '<span style="color:green;">'+(_sl==='zh'?'✓ 全部使用':'✓ Fully Used')+'</span>'; }
                } else if (used > 0) {
                    { var _sl2=document.getElementById('language')?document.getElementById('language').value:'zh'; statusCell.innerHTML = `<span style="color:#f39c12;">${_sl2==='zh'?'⚠️ 部分使用':'⚠️ Partial Use'} (${used}/${qty})</span>`; }
                } else {
                    { var _sl3=document.getElementById('language')?document.getElementById('language').value:'zh'; statusCell.innerHTML = '<span style="color:red;">'+(_sl3==='zh'?'✗ 未使用':'✗ Unused')+'</span>'; }
                }
                // 扣除已用數量，避免重複計數（相同長度嘅下一行會少咗）
                usageCount[len] = Math.max(0, usageCount[len] - used);
            });
        }

        function calculate() {
            try {
                const cuttingItems = getCuttingItems();
                const materialItems = getMaterialItems();
                const sawThickness = parseSawThickness();

                if (cuttingItems.length === 0) {
                    alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"請輸入至少一個切割項目":"Please enter at least one cutting item.");
                    return;
                }

                if (materialItems.length === 0) {
                    alert((document.getElementById('language')?document.getElementById('language').value:'zh')==="zh"?"請輸入至少一種材料":"Please enter at least one material.");
                    return;
                }

                if (sawThickness.error) {
                    alert(sawThickness.error);
                    return;
                }

                const algorithm = document.getElementById("algorithmSelector").value || "BFD";
                const effectiveSawThickness = (Number(sawThickness.value) || 0);
                let optimizedResult;

                if (algorithm === 'AutoBest') {
                    const resFFD = optimizeCutsFFD(cuttingItems, materialItems, effectiveSawThickness);
                    const resBFD = optimizeCutsBFD(cuttingItems, materialItems, effectiveSawThickness);
                    const resSG  = optimizeCutsSizeGrouping(cuttingItems, materialItems, effectiveSawThickness);

                    const st = effectiveSawThickness;
                    function evaluate(bins) {
                        let totalWaste = 0;
                        let usedBars = 0;
                        bins.forEach(bin => {
                            if (!bin) return;
                            usedBars++;
                            const usedLength = (bin.cuts || []).reduce((sum, c) => sum + (Number(c.length) || 0), 0);
                            const kerfLength = (bin.cuts && bin.cuts.length > 0) ? (bin.cuts.length - 1) * st : 0;
                            const waste = (Number(bin.length) || 0) - (usedLength + kerfLength);
                            totalWaste += Math.max(0, waste);
                        });
                        return { totalWaste, usedBars };
                    }

                    const scoreFFD = evaluate(resFFD);
                    const scoreBFD = evaluate(resBFD);
                    const scoreSG  = evaluate(resSG);

                    function better(a, b) {
                        if (a.totalWaste !== b.totalWaste) return a.totalWaste < b.totalWaste;
                        return a.usedBars < b.usedBars;
                    }

                    let bestAlgo = 'FFD';
                    let bestRes = resFFD;
                    let bestScore = scoreFFD;
                    if (better(scoreBFD, bestScore)) { bestAlgo = 'BFD'; bestRes = resBFD; bestScore = scoreBFD; }
                    if (better(scoreSG,  bestScore)) { bestAlgo = 'SizeGrouping'; bestRes = resSG;  bestScore = scoreSG;  }

                    optimizedResult = bestRes;

                    const resultDetails = document.getElementById('resultDetails');
                    if (resultDetails) {
                        const banner = document.createElement('div');
                        banner.style.margin = '12px 0';
                        banner.style.padding = '10px';
                        banner.style.backgroundColor = '#e8f5e9';
                        banner.style.border = '1px solid #c8e6c9';
                        banner.style.borderRadius = '6px';
                        banner.style.color = '#2e7d32';
                        {
  var _bLang = document.getElementById('language')?document.getElementById('language').value:'zh';
  if (_bLang === 'zh') {
    banner.innerHTML = `<strong>自動最慳料</strong> 已選擇：<code>${bestAlgo}</code>｜總餘料：<code>${bestScore.totalWaste.toFixed(3)}</code>｜用料支數：<code>${bestScore.usedBars}</code>`;
  } else {
    banner.innerHTML = `<strong>Auto Best Saving</strong> Selected: <code>${bestAlgo}</code> | Total Waste: <code>${bestScore.totalWaste.toFixed(3)}</code> | Bars Used: <code>${bestScore.usedBars}</code>`;
  }
}
                        resultDetails.prepend(banner);
                    }
                } else {
                    switch (algorithm) {
                        case "FFD":
                            optimizedResult = optimizeCutsFFD(cuttingItems, materialItems, effectiveSawThickness);
                            break;
                        case "SizeGrouping":
                            optimizedResult = optimizeCutsSizeGrouping(cuttingItems, materialItems, effectiveSawThickness);
                            break;
                        case "BFD":
                        default:
                            optimizedResult = optimizeCutsBFD(cuttingItems, materialItems, effectiveSawThickness);
                            break;
                    }
                }

                // 後處理合併
                optimizedResult = optimizeBins(optimizedResult, effectiveSawThickness);

                renderCuttingResults(optimizedResult, effectiveSawThickness);
                updateMaterialUsageStatus(optimizedResult);

                const resultsCard = document.getElementById("results-card");
                if (resultsCard) {
                    resultsCard.style.display = "block";
                    resultsCard.scrollIntoView({ behavior: "smooth" });
                }

                console.log("計算完成:", optimizedResult);

            } catch (error) {
                console.error("Calculation error:", error);
                alert((document.getElementById("language")?document.getElementById("language").value:"zh")==="zh"?"計算過程出錯："+error.message:"Calculation error: "+error.message);
            }
        }

        function renderCuttingResults(bins, sawThickness) {
            const unit = document.getElementById("unit").value;

            let uniqueLengths = [];
            bins.forEach(bin => {
                bin.cuts.forEach(cut => {
                    const roundedLength = Math.round(cut.length * 10) / 10;
                    if (!uniqueLengths.includes(roundedLength)) {
                        uniqueLengths.push(roundedLength);
                    }
                });
            });

            uniqueLengths.sort((a, b) => b - a);

            const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#98D8C8", "#F7DC6F", "#BB8FCE", "#85C1E2"];
            const lengthColorMap = {};
            const lengthLabelMap = {};

            uniqueLengths.forEach((length, index) => {
                lengthColorMap[length] = colors[index % colors.length];
                lengthLabelMap[length] = String.fromCharCode(65 + index);
            });

            const resultDetails = document.getElementById("resultDetails");
            resultDetails.style.display = "block";

            const totalBins = bins.length;
            const totalUsedLength = bins.reduce((sum, bin) => {
                return sum + bin.cuts.reduce((cutSum, cut) => cutSum + cut.length, 0);
            }, 0);

            const totalMaterialLength = bins.reduce((sum, bin) => sum + bin.length, 0);
            const totalWaste = bins.reduce((sum, bin) => {
                const usedLength = bin.cuts.reduce((cutSum, cut) => cutSum + cut.length, 0);
                const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                return sum + (bin.length - usedLength - kerfLength);
            }, 0);

            const utilizationRate = ((totalUsedLength / totalMaterialLength) * 100).toFixed(1);

            var _rLang = document.getElementById('language')?document.getElementById('language').value:'zh';
            var _t = {
              summary: _rLang==='zh'?'📊 優化摘要':'📊 Optimization Summary',
              bars:    _rLang==='zh'?'所需支數':'Bars Needed',
              util:    _rLang==='zh'?'利用率':'Utilization',
              waste:   _rLang==='zh'?'總餘料':'Total Waste'
            };
            let html = `
                <div class="opt-summary-box" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 10px 0; color: #1b5e20;">${_t.summary}</h4>
                    <div style="display: flex; justify-content: space-around; font-size: 14px;">
                        <div>
                            <strong>${_t.bars}</strong><br>
                            <span style="color: #d32f2f; font-size: 24px; font-weight: bold;">${totalBins}</span>
                        </div>
                        <div>
                            <strong>${_t.util}</strong><br>
                            <span style="color: #388e3c; font-size: 24px; font-weight: bold;">${utilizationRate}%</span>
                        </div>
                        <div>
                            <strong>${_t.waste}</strong><br>
                            <span style="color: #f57c00; font-size: 16px;">${formatLengthForDisplay(totalWaste, unit)}</span>
                        </div>
                    </div>
                </div>
            `;

            bins.forEach((bin, binIndex) => {
                const usedLength = bin.cuts.reduce((sum, cut) => sum + cut.length, 0);
                const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
                const waste = bin.length - usedLength - kerfLength;
                const wastePercentage = ((waste / bin.length) * 100).toFixed(1);

                html += `
                    <div class="opt-material-box" style="margin-bottom: 15px; padding: 12px; border-radius: 6px; background: #f9f9f9;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
                            ${_rLang==='zh'?'原料':'Bar'} #${binIndex + 1} - ${formatLengthForDisplay(bin.length, unit)}
                            ${bin.autoAdded ? ' <span style="color: #f57c00; font-size: 0.9em;">['+(_rLang==='zh'?'自動添加':'Auto Added')+']</span>' : ''}
                        </div>
                        <div style="display: flex; height: 50px; border: 1px solid #000; border-radius: 4px; overflow: hidden; margin-bottom: 8px; background: white;">
                `;

                bin.cuts.forEach((cut, cutIndex) => {
                    const roundedLength = Math.round(cut.length * 10) / 10;
                    const percentage = (cut.length / bin.length) * 100;
                    const color = lengthColorMap[roundedLength];
                    const label = lengthLabelMap[roundedLength];

                    html += `
                        <div style="width: ${percentage.toFixed(1)}%; background: ${color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; padding: 0 4px; text-align: center; border-right: 1px solid #000;" 
                             title="${formatLengthForDisplay(cut.length, unit)}">
                            ${label}
                        </div>
                    `;
                });

                if (waste > 0) {
                    const wastePercentageVisual = (waste / bin.length) * 100;
                    html += `
                        <div style="width: ${wastePercentageVisual.toFixed(1)}%; background: repeating-linear-gradient(45deg, #ffcccc 0px, #ffcccc 5px, #ff9999 5px, #ff9999 10px); display: flex; align-items: center; justify-content: center; color: #a00; font-weight: bold; font-size: 11px; padding: 0 4px;">
                            ${_rLang==='zh'?'餘料':'Waste'}
                        </div>
                    `;
                }

                html += `
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            <strong>${_rLang==='zh'?'使用長度':'Used Length'}：</strong> ${formatLengthForDisplay(usedLength + kerfLength, unit)} | 
                            <strong>${_rLang==='zh'?'餘料':'Waste'}：</strong> ${formatLengthForDisplay(waste, unit)} (${wastePercentage}%)
                        </div>
                        <div style="font-size: 11px; color: #999;">
                            <strong>${_rLang==='zh'?'切割順序':'Cut Order'}：</strong> 
                            ${bin.cuts.map(cut => formatLengthForDisplay(Math.round(cut.length * 10) / 10, unit)).join(" → ")}
                        </div>
                    </div>
                `;
            });

            resultDetails.innerHTML = html;

            let legendHtml = `
                <div style="margin-top: 20px; padding: 15px; background: white; border: 1px solid #000; border-radius: 6px;">
                    <h5 style="margin: 0 0 12px 0; color: #000; font-size: 16px;">${_rLang==='zh'?'📋 切割件尺寸圖例':'📋 Cut Size Legend'}</h5>
                    <div style="display: grid; gap: 8px;">
            `;

            uniqueLengths.forEach(length => {
                legendHtml += `
                    <div style="display: flex; align-items: center; padding: 6px; background: #f0f0f0; border-radius: 4px;">
                        <div style="width: 20px; height: 20px; background: ${lengthColorMap[length]}; border: 1px solid #000; margin-right: 10px;"></div>
                        <strong style="color: #000; min-width: 25px;">${lengthLabelMap[length]}</strong>
                        <span style="color: #000; margin-left: 10px;">${formatLengthForDisplay(length, unit)}</span>
                    </div>
                `;
            });

            legendHtml += `
                    </div>
                </div>
            `;

            document.getElementById("colorLegendItems").innerHTML = legendHtml;
            document.getElementById("colorLegend").style.display = "block";
            document.getElementById("printOptionsButton").style.display = "inline-block";
            document.getElementById("printButton").style.display = "inline-block";
        }

        function saveScheme() {
            const cuttingRows = document.querySelectorAll("#cuttingItemsTable tbody tr").length;
            const materialRows = document.querySelectorAll("#materialItemsTable tbody tr").length;

            if (cuttingRows === 0 && materialRows === 0) {
                const lang = document.getElementById("language").value;
                alert(lang === "zh" ?
                    "沒有可保存的數據，請先輸入切割項目和材料" :
                    "No data to save. Please enter cutting items and materials first.");
                return;
            }

            const now = new Date();
            const defaultName = now.getFullYear() + "-" +
                String(now.getMonth() + 1).padStart(2, "0") + "-" +
                String(now.getDate()).padStart(2, "0") + " " +
                String(now.getHours()).padStart(2, "0") + ":" +
                String(now.getMinutes()).padStart(2, "0");

            const nameInput = document.getElementById("schemeName");
            if (nameInput) {
                nameInput.value = defaultName;
            }

            new bootstrap.Modal(document.getElementById("saveSchemeModal")).show();
        }

        function confirmSaveScheme() {
            const schemeName = document.getElementById("schemeName").value.trim();
            const lang = document.getElementById("language").value;

            if (!schemeName) {
                alert(lang === "zh" ? "請輸入方案名稱" : "Please enter scheme name");
                return;
            }

            const cuttingItems = [];
            document.querySelectorAll("#cuttingItemsTable tbody tr").forEach(row => {
                cuttingItems.push({
                    length: row.dataset.length || "0",
                    quantity: row.dataset.quantity || "1",
                    purpose: row.dataset.purpose || "",
                    display: row.dataset.display || "",
                    inputUnit: row.dataset.inputUnit || "metric"
                });
            });

            const materials = [];
            document.querySelectorAll("#materialItemsTable tbody tr").forEach(row => {
                materials.push({
                    length: row.dataset.length || "0",
                    quantity: row.dataset.quantity || "1",
                    display: row.dataset.display || "",
                    inputUnit: row.dataset.inputUnit || "metric"
                });
            });

            const cuttingInputUnit = document.querySelector("#cuttingItems .unit-select")?.value || "metric";
            const materialInputUnit = document.querySelector("#materialItems .unit-select")?.value || "metric";

            const schemeData = {
                name: schemeName,
                date: new Date().toLocaleString(),
                language: document.getElementById("language").value,
                unit: document.getElementById("unit").value,
                sawThickness: document.getElementById("sawThickness").value,
                algorithm: document.getElementById("algorithmSelector").value,
                cuttingInputUnit: cuttingInputUnit,
                materialInputUnit: materialInputUnit,
                cuttingItems: cuttingItems,
                materials: materials
            };

            let savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
            savedSchemes.push(schemeData);
            localStorage.setItem("aluminumCuttingSchemes", JSON.stringify(savedSchemes));

            bootstrap.Modal.getInstance(document.getElementById("saveSchemeModal")).hide();
            document.getElementById("schemeName").value = "";
            alert(lang === "zh" ? "方案已儲存" : "Scheme saved successfully");

            loadScheme();
        }

        function uploadSchemeFile() {
            const fileInput = document.getElementById("schemeFileInput");
            const lang = document.getElementById("language").value;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert(lang === "zh" ? "請選擇檔案" : "Please select a file");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const schemeData = JSON.parse(e.target.result);

                    if (schemeData.name && schemeData.cuttingItems && schemeData.materials) {
                        let savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
                        savedSchemes.push(schemeData);
                        localStorage.setItem("aluminumCuttingSchemes", JSON.stringify(savedSchemes));

                        fileInput.value = "";
                        loadScheme();

                        const newIndex = savedSchemes.length - 1;

                        const modalEl = document.getElementById("loadSchemeModal");
                        if (modalEl) {
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                            setTimeout(function() {
                                const resultsCard = document.getElementById('results-card');
                                if (resultsCard) {
                                    resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 500);
                        }

                        loadSchemeData(newIndex);

                        setTimeout(() => {
                            if (typeof calculate === 'function') {
                                calculate();
                            }
                            const canvas = document.getElementById("cuttingCanvas");
                            if (canvas) {
                                canvas.scrollIntoView({behavior: 'smooth', block: 'start'});
                            }
                            const buttons = document.getElementsByTagName('button');
                            for (let i = 0; i < buttons.length; i++) {
                                const txt = buttons[i].textContent || buttons[i].innerText;
                                if (txt.includes('切割結果') || txt.includes('Result') || txt.includes('Results')) {
                                    if (!txt.includes('列印') && !txt.includes('Print')) {
                                        buttons[i].click();
                                        break; 
                                    }
                                }
                            }
                        }, 300);

                    } else {
                        alert(lang === "zh" ? "檔案格式不正確" : "Invalid file format");
                    }
                } catch (error) {
                    alert(lang === "zh" ? "無法讀取檔案: " : "Cannot read file: " + error.message);
                }
            };

            reader.readAsText(file);
        }

        function loadScheme() {
            const savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
            const schemesList = document.getElementById("savedSchemesList");
            const lang = document.getElementById("language").value;

            if (savedSchemes.length === 0) {
                schemesList.innerHTML = `<p>${lang === "zh" ? "沒有已儲存的方案" : "No saved schemes found"}</p>`;
            } else {
                schemesList.innerHTML = savedSchemes.map((scheme, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <span style="color:#212529">${escapeHTML(scheme.name)}</span>
                        <div>
                            <button class="btn btn-sm btn-primary me-2" onclick="loadSchemeData(${index})">
                                ${lang === "zh" ? "載入" : "Load"}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteScheme(${index})">
                                ${lang === "zh" ? "刪除" : "Delete"}
                            </button>
                        </div>
                    </div>
                `).join("");
            }

            new bootstrap.Modal(document.getElementById("loadSchemeModal")).show();
        }

        function loadSchemeData(index) {
            const savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
            const scheme = savedSchemes[index];

            if (!scheme) return;

            document.getElementById("language").value = scheme.language || "zh";
            document.getElementById("unit").value = scheme.unit || "metric";
            document.getElementById("sawThickness").value = scheme.sawThickness || "3.2";
            document.getElementById("algorithmSelector").value = scheme.algorithm || "BFD";

            document.querySelector("#cuttingItemsTable tbody").innerHTML = "";
            document.querySelector("#materialItemsTable tbody").innerHTML = "";
            document.querySelectorAll('table tbody').forEach(function(tb){ tb.innerHTML = ""; });
            var schemeSel = document.getElementById("schemeSelector");
            if (schemeSel) { schemeSel.innerHTML = ""; schemeSel.style.display = "none"; }
            ["resultsTable","binsTable","resultsWrapper","cuttingResults"].forEach(function(id){
              var el = document.getElementById(id);
              if (el) { el.innerHTML = ""; el.style.display = "none"; }
            });

            const cuttingUnitSelect = document.querySelector("#cuttingItems .unit-select");
            const materialUnitSelect = document.querySelector("#materialItems .unit-select");
            
            if (cuttingUnitSelect) {
                cuttingUnitSelect.value = scheme.cuttingInputUnit || "metric";
                cuttingUnitSelect.classList.remove("metric-active", "imperial-active");
                cuttingUnitSelect.value === "metric" ? 
                    cuttingUnitSelect.classList.add("metric-active") : 
                    cuttingUnitSelect.classList.add("imperial-active");
            }
            
            if (materialUnitSelect) {
                materialUnitSelect.value = scheme.materialInputUnit || "metric";
                materialUnitSelect.classList.remove("metric-active", "imperial-active");
                materialUnitSelect.value === "metric" ? 
                    materialUnitSelect.classList.add("metric-active") : 
                    materialUnitSelect.classList.add("imperial-active");
            }

            if (scheme.cuttingItems && scheme.cuttingItems.length > 0) {
                scheme.cuttingItems.forEach(item => {
                    const length = item.length || "0";
                    const quantity = item.quantity || "1";
                    const purpose = item.purpose || "";
                    let display = item.display || "";
                    let inputUnit = item.inputUnit || scheme.cuttingInputUnit || "metric";

                    if (!display && length !== "0") {
                        const lengthNum = parseFloat(length);
                        if (!isNaN(lengthNum)) {
                            display = formatLengthForDisplay(lengthNum, inputUnit);
                        } else {
                            display = length;
                        }
                    }

                    const row = document.createElement("tr");
                    row.dataset.length = length;
                    row.dataset.quantity = quantity;
                    row.dataset.purpose = purpose;
                    row.dataset.display = display;
                    row.dataset.inputUnit = inputUnit;

                    const tbody = document.querySelector("#cuttingItemsTable tbody");
                    const rowIndex = tbody.children.length;
                    
                    row.innerHTML = `
                        <td>${display}</td>
                        <td>${quantity}</td>
                        <td>${purpose || "-"}</td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-warning" onclick="enterCuttingEditMode(Array.from(this.closest('tbody').children).indexOf(this.closest('tr')))" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'編輯':'Edit'}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitCuttingEditMode();" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'刪除':'Delete'}">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            if (scheme.materials && scheme.materials.length > 0) {
                scheme.materials.forEach(item => {
                    const length = item.length || "0";
                    const quantity = item.quantity || "1";
                    let display = item.display || "";
                    let inputUnit = item.inputUnit || scheme.materialInputUnit || "metric";

                    if (!display && length !== "0") {
                        const lengthNum = parseFloat(length);
                        if (!isNaN(lengthNum)) {
                            display = formatLengthForDisplay(lengthNum, inputUnit);
                        } else {
                            display = length;
                        }
                    }

                    const row = document.createElement("tr");
                    row.dataset.length = length;
                    row.dataset.quantity = quantity;
                    row.dataset.display = display;
                    row.dataset.inputUnit = inputUnit;

                    const tbody = document.querySelector("#materialItemsTable tbody");
                    const rowIndex = tbody.children.length;
                    
                    row.innerHTML = `
                        <td>${display}</td>
                        <td>${quantity}</td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-warning" onclick="enterMaterialEditMode(Array.from(this.closest('tbody').children).indexOf(this.closest('tr')))" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'編輯':'Edit'}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); exitMaterialEditMode();" title="${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'刪除':'Delete'}">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                        <td class="usage-status text-center">-</td>
                    `;

                    tbody.appendChild(row);
                });
            }

            exitCuttingEditMode();
            exitMaterialEditMode();

            setTimeout(function() {
                const settingsUnit = document.getElementById("unit");
                if (settingsUnit) {
                    settingsUnit.classList.remove("metric-active", "imperial-active");
                    if (settingsUnit.value === "metric") {
                        settingsUnit.classList.add("metric-active");
                    } else {
                        settingsUnit.classList.add("imperial-active");
                    }
                }

                const initCutUnit = document.getElementById("globalCutUnit");
                if (initCutUnit) {
                    initCutUnit.classList.remove("metric-active", "imperial-active");
                    if (initCutUnit.value === "metric") {
                        initCutUnit.classList.add("metric-active");
                    } else {
                        initCutUnit.classList.add("imperial-active");
                    }
                }

                const initMaterialUnit = document.getElementById("globalMaterialUnit");
                if (initMaterialUnit) {
                    initMaterialUnit.classList.remove("metric-active", "imperial-active");
                    if (initMaterialUnit.value === "metric") {
                        initMaterialUnit.classList.add("metric-active");
                    } else {
                        initMaterialUnit.classList.add("imperial-active");
                    }
                }
            }, 50);

            bootstrap.Modal.getInstance(document.getElementById("loadSchemeModal")).hide();
        }

        function deleteScheme(index) {
            const lang = document.getElementById("language").value;

            if (confirm(lang === "zh" ? "確定要刪除此方案嗎？" : "Are you sure you want to delete this scheme?")) {
                let savedSchemes = JSON.parse(localStorage.getItem("aluminumCuttingSchemes") || "[]");
                savedSchemes.splice(index, 1);
                localStorage.setItem("aluminumCuttingSchemes", JSON.stringify(savedSchemes));
                loadScheme();
            }
        }

        function reset() {
            const lang = document.getElementById("language").value;
            const confirmMsg = lang === "zh" ? "確定要重置所有資料嗎？" : "Are you sure you want to reset all data?";

            if (confirm(confirmMsg)) {
                location.reload();
            }
        }

        function showPrintOptions() {
            new bootstrap.Modal(document.getElementById("printOptionsModal")).show();
        }

        function triggerPrint() {
            const printSettings = document.getElementById("printSettings").checked;
            const printCuttingItems = document.getElementById("printCuttingItems").checked;
            const printMaterials = document.getElementById("printMaterials").checked;
            const printResults = document.getElementById("printResults").checked;
            const printVisualization = document.getElementById("printVisualization").checked;
            const printLegend = document.getElementById("printLegend").checked;

            document.getElementById("settings-card").classList.toggle("print-section", printSettings);
            document.getElementById("cutting-items-card").classList.toggle("print-section", printCuttingItems);
            document.getElementById("materials-card").classList.toggle("print-section", printMaterials);
            document.getElementById("results-card").classList.toggle("print-section", printResults || printVisualization || printLegend);
            document.getElementById("resultDetails").classList.toggle("print-section-results", printResults);
            document.getElementById("cuttingCanvas").classList.toggle("print-section-visualization", printVisualization);
            document.getElementById("colorLegend").classList.toggle("print-section-legend", printLegend);

            const modal = bootstrap.Modal.getInstance(document.getElementById("printOptionsModal"));
            if (modal) modal.hide();

            window.print();

            const cleanup = () => {
                document.getElementById("settings-card").classList.remove("print-section");
                document.getElementById("cutting-items-card").classList.remove("print-section");
                document.getElementById("materials-card").classList.remove("print-section");
                document.getElementById("results-card").classList.remove("print-section");
                document.getElementById("resultDetails").classList.remove("print-section-results");
                document.getElementById("cuttingCanvas").classList.remove("print-section-visualization");
                document.getElementById("colorLegend").classList.remove("print-section-legend");
            };

            if (window.matchMedia) {
                window.matchMedia("print").addListener(function (mq) {
                    if (!mq.matches) {
                        cleanup();
                    }
                });
            } else {
                setTimeout(cleanup, 1000);
            }
        }

        function showHelp() {
            const helpContent = document.getElementById("helpContent");
            const lang = document.getElementById("language").value;

            if (lang === "zh") {
                helpContent.innerHTML = `
                    <div class="help-guide">
                      <div class="hg-lead">
                        <i class="fa-solid fa-circle-info"></i>
                        <div>
                          <div style="font-weight:900">快速上手</div>
                          <div style="color:#334155">跟住下面 4 個步驟，由輸入到計算，再到列印／儲存方案。</div>
                        </div>
                      </div>

                      <div class="hg-section-title"><i class="fa-solid fa-shoe-prints" style="color:#2563eb"></i>流程（4 步）</div>
                      <div class="hg-steps">
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">1 / 設置</span><i class="fa-solid fa-gear" style="color:#1d4ed8"></i></div>
                          <h6>語言、單位、鋸片厚度</h6>
                          <p>先揀語言同顯示單位，再輸入鋸片厚度（會影響耗料）。</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">2 / 切割項目</span><i class="fa-solid fa-list-check" style="color:#1d4ed8"></i></div>
                          <h6>輸入要切嘅尺寸</h6>
                          <p>填長度、數量、用途 → 撳「新增項目」加到表格。</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">3 / 材料</span><i class="fa-solid fa-cubes" style="color:#1d4ed8"></i></div>
                          <h6>輸入可用材料</h6>
                          <p>填材料長度、數量 → 撳「新增材料」加到表格。</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">4 / 計算與輸出</span><i class="fa-solid fa-chart-line" style="color:#1d4ed8"></i></div>
                          <h6>計算 → 揀方案 → 列印／儲存</h6>
                          <p>撳「計算」睇結果；可儲存/載入常用方案；需要就列印報告。</p>
                        </div>
                      </div>

                      <div class="hg-section-title"><i class="fa-solid fa-wand-magic-sparkles" style="color:#2563eb"></i>常用操作</div>
                      <div class="hg-steps">
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">編輯（項目/材料）</span><i class="fa-solid fa-pen-to-square" style="color:#1d4ed8"></i></div>
                          <h6>表格 → 撳「編輯」</h6>
                          <p>項目會回填到輸入框，改完再撳「更新」保存。</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">智能優化</span><i class="fa-solid fa-bolt" style="color:#1d4ed8"></i></div>
                          <h6>同尺寸盡量排埋一齊</h6>
                          <p>提升開料效率，適合大量重複尺寸嘅情況。</p>
                        </div>
                      </div>

                      <div class="hg-section-title"><i class="fa-solid fa-lightbulb" style="color:#f59e0b"></i>提示</div>
                      <div class="hg-tips">
                        <div style="font-weight:900">輸入單位建議</div>
                        <ul>
                          <li>公制：米/厘米/毫米</li>
                          <li>英制：尺/寸/分</li>
                          <li><strong>鋸片厚度越大</strong>，理論耗料越多，結果會跟住變。</li>
                          <li>新增／更新後輸入欄會自動歸零，方便下一筆。</li>
                          <li>編輯時，單位會跟返該項目原本嘅單位（公制/英制）。</li>
                        </ul>
                      </div>
                    </div>
                `;
            } else {
                helpContent.innerHTML = `
                    <div class="help-guide">
                      <div class="hg-lead">
                        <i class="fa-solid fa-circle-info"></i>
                        <div>
                          <div style="font-weight:900">Quick start</div>
                          <div style="color:#334155">Follow the 4 steps below: inputs → calculate → save/print.</div>
                        </div>
                      </div>

                      <div class="hg-section-title"><i class="fa-solid fa-shoe-prints" style="color:#2563eb"></i>Workflow (4 steps)</div>
                      <div class="hg-steps">
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">1 / Settings</span><i class="fa-solid fa-gear" style="color:#1d4ed8"></i></div>
                          <h6>Language, units, saw thickness</h6>
                          <p>Choose language and unit, then enter saw thickness (affects utilization).</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">2 / Cutting items</span><i class="fa-solid fa-list-check" style="color:#1d4ed8"></i></div>
                          <h6>Enter required cuts</h6>
                          <p>Length, quantity, purpose → click “Add Item”.</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">3 / Materials</span><i class="fa-solid fa-cubes" style="color:#1d4ed8"></i></div>
                          <h6>Enter available stock</h6>
                          <p>Material length and quantity → click “Add Material”.</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">4 / Calculate & output</span><i class="fa-solid fa-chart-line" style="color:#1d4ed8"></i></div>
                          <h6>Calculate → review → save/print</h6>
                          <p>Click “Calculate” to view results, then save/load schemes or print report.</p>
                        </div>
                      </div>

                      <div class="hg-section-title"><i class="fa-solid fa-wand-magic-sparkles" style="color:#2563eb"></i>Common actions</div>
                      <div class="hg-steps">
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">Edit (items/materials)</span><i class="fa-solid fa-pen-to-square" style="color:#1d4ed8"></i></div>
                          <h6>Table → “Edit”</h6>
                          <p>Loads values back into the input fields. Modify, then click “Update”.</p>
                        </div>
                        <div class="hg-step">
                          <div class="hg-step-top"><span class="hg-badge">Smart optimization</span><i class="fa-solid fa-bolt" style="color:#1d4ed8"></i></div>
                          <h6>Groups same-size cuts</h6>
                          <p>Helps production efficiency when many repeated sizes exist.</p>
                        </div>
                      </div>

                      <div class="hg-section-title"><i class="fa-solid fa-lightbulb" style="color:#f59e0b"></i>Tips</div>
                      <div class="hg-tips">
                        <div style="font-weight:900">Input units</div>
                        <ul>
                          <li>Metric: m / cm / mm</li>
                          <li>Imperial: ft / in / 1/8 in</li>
                          <li><strong>Saw thickness</strong> changes the loss between cuts.</li>
                          <li>After add/update, inputs reset automatically for the next entry.</li>
                          <li>When editing, input units follow the original unit of that entry.</li>
                        </ul>
                      </div>
                    </div>
                `;
            }

            new bootstrap.Modal(document.getElementById("helpModal")).show();
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateLanguage();
            updateInputLabels();

            setTimeout(function() {
                const settingsUnit = document.getElementById("unit");
                if (settingsUnit) {
                    settingsUnit.classList.remove("metric-active", "imperial-active");
                    if (settingsUnit.value === "metric") {
                        settingsUnit.classList.add("metric-active");
                    } else {
                        settingsUnit.classList.add("imperial-active");
                    }
                }

                const initCutUnit = document.getElementById("globalCutUnit");
                if (initCutUnit) {
                    initCutUnit.classList.remove("metric-active", "imperial-active");
                    if (initCutUnit.value === "metric") {
                        initCutUnit.classList.add("metric-active");
                    } else {
                        initCutUnit.classList.add("imperial-active");
                    }
                }

                const initMaterialUnit = document.getElementById("globalMaterialUnit");
                if (initMaterialUnit) {
                    initMaterialUnit.classList.remove("metric-active", "imperial-active");
                    if (initMaterialUnit.value === "metric") {
                        initMaterialUnit.classList.add("metric-active");
                    } else {
                        initMaterialUnit.classList.add("imperial-active");
                    }
                }
            }, 50);

            const gUnit = document.getElementById("globalCutUnit");
            if (gUnit) {
                gUnit.addEventListener("change", function(){
                    updateCuttingUnitOnly();
                });
            }

            const gMaterialUnit = document.getElementById("globalMaterialUnit");
            if (gMaterialUnit) {
                gMaterialUnit.addEventListener("change", function(){
                    updateMaterialUnitOnly();
                });
            }

            const unit = document.getElementById("unit").value;
            document.getElementById("sawThickness").value = unit === "imperial" ? "1" : "3.2";

            document.getElementById("sawThickness").addEventListener("input", function () {
                parseSawThickness();
            });

            document.getElementById("unit").addEventListener("change", function () {
                const unit = this.value;
                const sawThicknessInput = document.getElementById("sawThickness");
                const currentValue = sawThicknessInput.value.trim();

                if (unit === "imperial") {
                    if (!currentValue || currentValue === "3.2") {
                        sawThicknessInput.value = "1";
                    }
                } else {
                    if (!currentValue || currentValue === "1") {
                        sawThicknessInput.value = "3.2";
                    }
                }

                updateInputLabels();
            });

            document.querySelectorAll(".length-input-group").forEach(group => {
                const inputs = group.querySelectorAll(".form-control");
                const errorElement = group.querySelector(".error-message");

                inputs.forEach(input => {
                    input.addEventListener("input", () => validateInput(group, errorElement));
                });

                const unitSelect = group.querySelector(".unit-select");
                if (unitSelect) {
                    unitSelect.addEventListener("change", () => {
                        updateInputLabels();
                        validateInput(group, errorElement);
                    });
                }
            });
        });
    </script>
<script>

window.forceUpdateUI = function(selectElement) {
    if (!selectElement) return;
    const unit = selectElement.value;
    const group = selectElement.closest(".length-input-group");
    if (!group) return;

    selectElement.classList.remove("metric-active", "imperial-active");
    if (unit === "imperial" || unit === "imperial_decimal") {
        selectElement.classList.add("imperial-active");
    } else {
        selectElement.classList.add("metric-active");
    }

    const lang = document.getElementById("language").value;
    const labels = {
        imperial: lang === "zh" ? ["尺", "寸", "分"] : ["ft", "in", "eighth"],
        metric: lang === "zh" ? ["米", "厘米", "毫米"] : ["m", "cm", "mm"]
    };
    const hintLabels = labels[unit] || labels.metric;

    group.querySelectorAll(".form-control").forEach((input, index) => {
        const hint = input.nextElementSibling;
        if (hint && hint.classList.contains("small-hint")) {
            hint.textContent = hintLabels[index] || "";
        }
    });
};

window.convertInputValues = function(group, targetUnit) {
    const inputs = group.querySelectorAll(".form-control");
    if (inputs.length < 3) return;

    const oldUnit = group.dataset.currentUnit || "metric"; 

    if (oldUnit === targetUnit) return; 

    console.log(`Converting from ${oldUnit} to ${targetUnit}`);

    let totalMM = 0;
    const val0 = parseFloat(inputs[0].value) || 0;
    const val1 = parseFloat(inputs[1].value) || 0;
    const val2 = parseFloat(inputs[2].value) || 0;

    if (oldUnit === "imperial") {
         totalMM = (val0 * 12 + val1 + val2/8) * 25.4;
    } else {
         totalMM = val0 * 1000 + val1 * 10 + val2;
    }

    if (targetUnit === "imperial") {
         const totalInches = totalMM / 25.4;
         const ft = Math.floor(totalInches / 12);
         const inch = Math.floor(totalInches % 12);
         const eighths = Math.round((totalInches % 1) * 8);
         inputs[0].value = ft;
         inputs[1].value = inch;
         inputs[2].value = eighths;
    } else {
         const m = Math.floor(totalMM / 1000);
         const cm = Math.floor((totalMM % 1000) / 10);
         const mm = Math.round(totalMM % 10);
         inputs[0].value = m;
         inputs[1].value = cm;
         inputs[2].value = mm;
    }

    group.dataset.currentUnit = targetUnit;
};

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".unit-select").forEach(select => {
        const group = select.closest(".length-input-group");
        if (group) {
            group.dataset.currentUnit = select.value;
        }
        select.addEventListener("focus", function() {
             const group = this.closest(".length-input-group");
             if(group) group.dataset.currentUnit = this.value;
        });
        select.addEventListener("change", function() {
            const group = this.closest(".length-input-group");
            if (group) {
                window.convertInputValues(group, this.value);
                window.forceUpdateUI(this);
            }
        });
        window.forceUpdateUI(select);
    });
});

</script>
<script>
(function(){
  const createOptimizer = (algoType) => {
    return function(cuts, materials, sawThickness) {
      let allCuts = [];
      cuts.forEach(item => {
        for(let i = 0; i < item.quantity; i++) {
          allCuts.push({length: item.length, purpose: item.purpose, display: item.display || ""});
        }
      });

      if(algoType !== 'SizeGrouping') {
        allCuts.sort((a, b) => a.length - b.length);
      }

      let bins = [];
      let availableMaterials = materials.flatMap(item => Array(item.quantity).fill(item)).sort((a, b) => a.length - b.length);
      const defaultLength = materials.length > 0 ? materials.reduce((max, item) => Math.max(max, item.length || 0), 0) : 6000;

      if(algoType === 'FFD') {
        allCuts.forEach(cut => {
          let placed = false;
          for(let i = 0; i < bins.length; i++) {
            const bin = bins[i];
            const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
            const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
            if(usedLength + kerfLength + cut.length + (bin.cuts.length > 0 ? sawThickness : 0) <= bin.length) {
              bin.cuts.push(cut);
              placed = true;
              break;
            }
          }
          if(!placed) {
            let binLength, autoAdded = false;
            if(availableMaterials.length > 0) {
              binLength = (availableMaterials.shift().length || 0);
            } else {
              binLength = defaultLength;
              autoAdded = true;
            }
            bins.push({length: binLength, cuts: [cut], autoAdded: autoAdded});
          }
        });
      } else if(algoType === 'SizeGrouping') {
        let lengthGroups = {};
        allCuts.forEach(cut => {
          if(!lengthGroups[cut.length]) lengthGroups[cut.length] = [];
          lengthGroups[cut.length].push(cut);
        });
        const sortedLengths = Object.keys(lengthGroups).map(Number).sort((a, b) => b - a);

        sortedLengths.forEach(length => {
          let groupCuts = lengthGroups[length];
          while(groupCuts.length > 0) {
            let bestBin = null, bestCount = 0;
            for(let i = 0; i < bins.length; i++) {
              const bin = bins[i];
              const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
              const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
              let count = 0, currentLength = usedLength + kerfLength;
              for(let j = 0; j < groupCuts.length; j++) {
                const required = length + (bin.cuts.length + count > 0 ? sawThickness : 0);
                if(currentLength + required <= bin.length) {
                  count++;
                  currentLength += required;
                } else {
                  break;
                }
              }
              if(count > 0 && count > bestCount) {
                bestCount = count;
                bestBin = bin;
              }
            }

            if(bestBin) {
              for(let k = 0; k < bestCount; k++) bestBin.cuts.push(groupCuts.shift());
            } else {
              let binLength, autoAdded = false;
              if(availableMaterials.length > 0) {
                binLength = (availableMaterials.shift().length || 0);
              } else {
                binLength = defaultLength;
                autoAdded = true;
              }
              const newBin = {length: binLength, cuts: [], autoAdded: autoAdded};
              let remainingLength = binLength;
              while(groupCuts.length > 0) {
                const cut = groupCuts[0];
                const required = cut.length + (newBin.cuts.length > 0 ? sawThickness : 0);
                if(required <= remainingLength) {
                  newBin.cuts.push(groupCuts.shift());
                  remainingLength -= required;
                } else {
                  break;
                }
              }
              bins.push(newBin);
            }
          }
        });
      } else {
        allCuts.forEach(cut => {
          let bestBin = null;
          let bestRemaining = Infinity;
          for(let i = 0; i < bins.length; i++) {
            const bin = bins[i];
            const usedLength = bin.cuts.reduce((sum, c) => sum + c.length, 0);
            const kerfLength = bin.cuts.length > 0 ? (bin.cuts.length - 1) * sawThickness : 0;
            const required = cut.length + (bin.cuts.length > 0 ? sawThickness : 0);
            const remaining = bin.length - (usedLength + kerfLength + required);
            if(remaining >= 0 && remaining < bestRemaining) {
              bestRemaining = remaining;
              bestBin = bin;
            }
          }

          if(bestBin) {
            bestBin.cuts.push(cut);
          } else {
            let binLength, autoAdded = false;
            if(availableMaterials.length > 0) {
              binLength = (availableMaterials.shift().length || 0);
            } else {
              binLength = defaultLength;
              autoAdded = true;
            }
            bins.push({length: binLength, cuts: [cut], autoAdded: autoAdded});
          }
        });
      }
      return bins;
    };
  };

  window.optimizeCutsBFD = createOptimizer('BFD');
  window.optimizeCutsFFD = createOptimizer('FFD');
  window.optimizeCutsSizeGrouping = createOptimizer('SizeGrouping');

  const originalRender = window.renderCuttingResults;
  window.renderCuttingResults = function(bins, sawThickness) {
    let missingMaterials = {};
    bins.forEach(bin => {
      if(bin && bin.autoAdded) {
        const len = bin.length;
        missingMaterials[len] = (missingMaterials[len] || 0) + 1;
      }
    });

    if(Object.keys(missingMaterials).length > 0) {
      const resultDetails = document.getElementById('resultDetails');
      if(resultDetails) {
        let missingHtml = `<div style="margin: 15px 0; padding: 12px; background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 5px; color: #856404;">
          <strong><i class="fa-solid fa-triangle-exclamation"></i> ${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'材料不足，自動補料 (Auto-Replenish):':'Insufficient material, Auto-Replenish:'}</strong>
          <ul style="margin: 8px 0 0 20px; padding-left: 0;">`;

        for(const [length, count] of Object.entries(missingMaterials)) {
          const displayLen = (typeof formatLengthForDisplay === 'function') ? formatLengthForDisplay(parseFloat(length), document.getElementById('unit') ? document.getElementById('unit').value : 'metric') : length;
          missingHtml += `<li>${displayLen} x ${count} ${(document.getElementById('language')?document.getElementById('language').value:'zh')==='zh'?'支':'bar(s)'}</li>`;
        }
        missingHtml += `</ul></div>`;

        const summaryBox = resultDetails.querySelector('[style*="background: #e8f5e9"]') || resultDetails.querySelector('[style*="background-color: #e8f5e9"]');
        if(summaryBox) {
          summaryBox.insertAdjacentHTML('afterend', missingHtml);
        }
      }
    }

    if(typeof originalRender === 'function') {
      originalRender.call(this, bins, sawThickness);
    }
  };
})();
</script>
<script>
(function(){
  const selectors = [
    '.cutQty',
    '.materialQty'
  ];

  function normalizeNumericString(v){
    const s = v.trim();
    if (s === '') return '';
    if (/^\d+$/.test(s)) return String(Number(s));
    if (/^0\.[0-9]+$/.test(s)) return s;
    const num = Number(s);
    if (!Number.isNaN(num)) return String(num);
    return s;
  }

  function getDefaultFor(el){
    if (el.classList && el.classList.contains('materialQty')) return '1';
    return '0';
  }

  function setup(el){
    el.addEventListener('focus', function(){
      if (this.value === '0' && !this.dataset._clearedOnce) {
        this.value = '';
        this.dataset._clearedOnce = '1';
      }
    });

    el.addEventListener('input', function(){
      const v = this.value;
      if (/^\d+$/.test(v)) {
        const normalized = String(Number(v));
        if (normalized !== v) this.value = normalized;
      }
    });

    el.addEventListener('blur', function(){
      const v = this.value.trim();
      if (v === '') {
        this.value = getDefaultFor(this);
      } else {
        this.value = normalizeNumericString(v);
      }
    });
  }

  function init(){
    selectors.forEach(sel => {
      document.querySelectorAll(sel).forEach(setup);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<script>
(function(){
  function isImperialContext(el){
    const group = el.closest('.length-input-group') || el.closest('.saw-thickness-input') || document;
    const localSelect = group.querySelector('.unit-select');
    const unit = localSelect ? localSelect.value : (document.getElementById('unit') ? document.getElementById('unit').value : 'metric');
    return unit === 'imperial' || unit === 'imperial_decimal';
  }

  function setupImperialZeroClear(selector){
    document.querySelectorAll(selector).forEach(el => {
      el.addEventListener('focus', function(){
        if (!isImperialContext(this)) return;
        if (this.value === '0' && !this.dataset._imperialClearedOnce) {
          this.value = '';
          this.dataset._imperialClearedOnce = '1';
        } else if (this.value === '0') {
          try { this.select(); } catch(e) {}
        }
      });
    });
  }

  function init(){
    setupImperialZeroClear('.cutLengthPart');
    setupImperialZeroClear('.materialLengthPart');
    setupImperialZeroClear('#sawThickness');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<script>
(function(){
  function autoRecalc(){
    try {
      const hasData = document.querySelector('#cuttingItemsTable tbody tr') || document.querySelector('#materialItemsTable tbody tr');
      if (hasData && typeof calculate === 'function') {
        calculate();
      }
    } catch(e) {}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', autoRecalc);
  } else {
    if (!window.__suppressAutoRecalc) setTimeout(autoRecalc, 50);
  }
})();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cuttingScrollInputs = 
                        }
                    }
                }, 300);
            });
        });

        const materialScrollInputs = document.querySelectorAll('.auto-scroll-material');

        materialScrollInputs.forEach(function(input) {
            input.addEventListener('focus', function() {
                setTimeout(function() {
                    const materialCard = document.getElementById('materials-card');
                    if (materialCard) {
                        const sectionHeader = materialCard.querySelector('.section-header');
                        if (sectionHeader) {
                            const rect = sectionHeader.getBoundingClientRect();
                            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                            const targetY = rect.top + scrollTop - 20;
                            window.scrollTo({
                                top: targetY,
                                behavior: 'smooth'
                            });
                        }
                    }
                }, 300);
            });
        });
    });
    </script>
<script>
    function updateCuttingUnitOnly() {
        const cutUnit = document.getElementById('globalCutUnit');
        if (!cutUnit) return;

        const unit = cutUnit.value;
        const lang = document.getElementById('language').value;

        cutUnit.classList.remove('metric-active', 'imperial-active');
        if (unit === 'metric') {
            cutUnit.classList.add('metric-active');
        } else {
            cutUnit.classList.add('imperial-active');
        }

        const labels = {
            imperial: lang === 'zh' ? ['尺', '寸', '分'] : ['ft', 'in', 'eighth'],
            metric: lang === 'zh' ? ['米', '厘米', '毫米'] : ['m', 'cm', 'mm']
        };
        const hintLabels = labels[unit] || labels.metric;

        const cuttingItems = document.getElementById('cuttingItems');
        if (cuttingItems) {
            const groups = cuttingItems.querySelectorAll('.length-input-group');
            groups.forEach(group => {
                if (group.closest('.edit-mode')) return;
                const inputs = group.querySelectorAll('.form-control');
                inputs.forEach((input, index) => {
                    const hint = input.nextElementSibling;
                    if (hint && hint.classList.contains('small-hint')) {
                        hint.textContent = hintLabels[index] || '';
                    }
                });
            });
        }
    }

    function updateMaterialUnitOnly() {
        const materialUnit = document.getElementById('globalMaterialUnit');
        if (!materialUnit) return;

        const unit = materialUnit.value;
        const lang = document.getElementById('language').value;

        materialUnit.classList.remove('metric-active', 'imperial-active');
        if (unit === 'metric') {
            materialUnit.classList.add('metric-active');
        } else {
            materialUnit.classList.add('imperial-active');
        }

        const labels = {
            imperial: lang === 'zh' ? ['尺', '寸', '分'] : ['ft', 'in', 'eighth'],
            metric: lang === 'zh' ? ['米', '厘米', '毫米'] : ['m', 'cm', 'mm']
        };
        const hintLabels = labels[unit] || labels.metric;

        const materialItems = document.getElementById('materialItems');
        if (materialItems) {
            const groups = materialItems.querySelectorAll('.length-input-group');
            groups.forEach(group => {
                if (group.closest('.edit-mode')) return;
                const inputs = group.querySelectorAll('.form-control');
                inputs.forEach((input, index) => {
                    const hint = input.nextElementSibling;
                    if (hint && hint.classList.contains('small-hint')) {
                        hint.textContent = hintLabels[index] || '';
                    }
                });
            });
        }
    }

    window.scrollToCalculate = function() {
        setTimeout(function() {
            const resultsCard = document.getElementById('results-card');
            if (resultsCard) {
                const header = resultsCard.querySelector('.section-header');
                if (header) {
                    header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }, 300);
    };
    
(function() {
    console.log('初始化自動滾動功能...');

    document.addEventListener('focus', function(event) {
        const target = event.target;

        const isInput = target.matches('input[type="number"], input[type="text"], textarea, select');

        if (isInput) {
            console.log('輸入欄被點擊:', target.tagName, target.id || target.name);

            let card = target.closest('.card');

            if (card) {
                let sectionHeader = card.querySelector('.section-header');

                if (sectionHeader) {
                    console.log('找到標題區域:', sectionHeader.textContent.trim().substring(0, 20));

                    const headerRect = sectionHeader.getBoundingClientRect();
                    const headerTop = headerRect.top;

                    if (headerTop > 5 || headerTop < 0) {
                        const scrollAmount = window.pageYOffset + headerTop - 5;

                        console.log('滾動到位置:', scrollAmount, '(距離頂部5px)');

                        window.scrollTo({
                            top: scrollAmount,
                            behavior: 'smooth'
                        });
                    } else {
                        console.log('已經在正確位置，無需滾動');
                    }
                } else {
                    console.log('找不到 .section-header');
                }
            } else {
                console.log('找不到 .card');
            }
        }
    }, true);

    console.log('✅ 自動滾動功能已啟動（使用 .section-header）');
})();
</script>
<script>
    (function(){
      function hideResults(){
        const ids = [
          'resultDetails','cuttingCanvas','colorLegend','progressBar',
          'schemeSelector','printOptionsButton','printButton'
        ];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (id === 'progressBar') {
            el.style.display = 'none';
          } else {
            el.style.display = 'none';
          }
        });
      }
      function bind(el){
        if (!el) return;
        el.addEventListener('input', hideResults);
        el.addEventListener('change', hideResults);
      }
      function attachAutoHide(){
        ['#language','#unit','#algorithmSelector','#sawThickness',
         '#globalCutUnit','#globalMaterialUnit']
         .forEach(sel => document.querySelectorAll(sel).forEach(bind));
        document.querySelectorAll('.cutLengthPart,.cutQty,.cutPurpose')
          .forEach(bind);
        document.querySelectorAll('.materialLengthPart,.materialQty')
          .forEach(bind);
        ['#addCuttingButton','#clearCuttingButton','#updateCuttingButton',
         '#addMaterialButton','#clearMaterialButton','#updateMaterialButton']
         .forEach(id => { const b=document.querySelector(id); if(b){ b.addEventListener('click', hideResults); }});
        document.addEventListener('click', function(e){
          const btn = e.target.closest('.action-buttons button');
          if(btn) hideResults();
        });
        window.hideCuttingResults = hideResults;
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachAutoHide);
      } else {
        attachAutoHide();
      }
    })();
    </script>
<script>
    (function(){
      function applyOptionalNote(){
        try {
          var langSel = document.getElementById('language');
          var lang = langSel ? langSel.value : 'zh';
          var baseLabel = (lang === 'zh') ? '用途:' : 'Purpose:';
          var noteText = (lang === 'zh') ? '(非必填)' : '(optional)';
          document.querySelectorAll('.cutPurposeLabel').forEach(function(lbl){
            lbl.innerHTML = baseLabel + ' <span class="optional-note">' + noteText + '</span>';
          });
        } catch(e) {}
      }
      var __origUpdateLanguage = window.updateLanguage;
      if (typeof __origUpdateLanguage === 'function') {
        window.updateLanguage = function(){
          __origUpdateLanguage();
          applyOptionalNote();
        };
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyOptionalNote);
      } else {
        applyOptionalNote();
      }
      document.addEventListener('click', function(ev){
        if (ev.target && (ev.target.id === 'addCuttingButton' || ev.target.id === 'updateCuttingButton' || ev.target.id === 'clearCuttingButton')) {
          setTimeout(applyOptionalNote, 0);
        }
      });
      window.applyOptionalPurposeNote = applyOptionalNote;
    })();
  </script>

  <script>
  (function(){
    function initTitleNut(){
      if (typeof THREE === 'undefined') return;
      var container = document.getElementById('titleNut');
      if (!container || container.dataset.inited) return;
      container.dataset.inited = '1';

      var w = container.clientWidth || 112;
      var h = container.clientHeight || 112;

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 1000);
      camera.position.z = 25;

      var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(w, h);
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setClearColor(0x000000, 0);
      container.appendChild(renderer.domElement);

      var hexRadius = 5;
      var holeRadius = 2.8;
      var thickness = 3.5;

      var shape = new THREE.Shape();
      for (var i = 0; i < 6; i++) {
        var angle = (i / 6) * Math.PI * 2;
        var x = Math.cos(angle) * hexRadius;
        var y = Math.sin(angle) * hexRadius;
        if (i === 0) shape.moveTo(x, y);
        else shape.lineTo(x, y);
      }
      shape.lineTo(Math.cos(0) * hexRadius, Math.sin(0) * hexRadius);

      var holePath = new THREE.Path();
      holePath.absarc(0, 0, holeRadius, 0, Math.PI * 2, false);
      shape.holes.push(holePath);

      var extrudeSettings = {
        depth: thickness,
        bevelEnabled: true,
        bevelSegments: 5,
        steps: 1,
        bevelSize: 0.4,
        bevelThickness: 0.4
      };

      var geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
      geometry.center();

      var material = new THREE.MeshStandardMaterial({
        color: 0xffd700,
        metalness: 0.8,
        roughness: 0.2
      });

      var nut = new THREE.Mesh(geometry, material);
      scene.add(nut);

      scene.add(new THREE.HemisphereLight(0xffffff, 0x888888, 1.35));
      var mainLight = new THREE.DirectionalLight(0xffffff, 1.8);
      mainLight.position.set(10, 20, 15);
      scene.add(mainLight);
      var backLight = new THREE.PointLight(0xffaa00, 1.2);
      backLight.position.set(-15, -10, -10);
      scene.add(backLight);

      function animate(){
        requestAnimationFrame(animate);
        nut.rotation.x += 0.010;
        nut.rotation.y += 0.020;
        renderer.render(scene, camera);
      }
      animate();

      var resizeTimer;
      window.addEventListener('resize', function(){
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function(){
          if (!container.isConnected) return;
          var nw = container.clientWidth || w;
          var nh = container.clientHeight || h;
          camera.aspect = nw / nh;
          camera.updateProjectionMatrix();
          renderer.setSize(nw, nh);
        }, 120);
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTitleNut);
    } else {
      initTitleNut();
    }
  })();
  </script>

<script>
(function(){
  const STORAGE_KEY = 'aluminum_cut_user_prefs_v1';
  let isRestoring = false;

  function saveSettings(){
    if (isRestoring) return;
    try {
      const settings = {
        language: document.getElementById('language') ? document.getElementById('language').value : 'zh',
        unit: document.getElementById('unit') ? document.getElementById('unit').value : 'metric',
        globalCutUnit: document.getElementById('globalCutUnit') ? document.getElementById('globalCutUnit').value : undefined,
        globalMaterialUnit: document.getElementById('globalMaterialUnit') ? document.getElementById('globalMaterialUnit').value : undefined,
        algorithm: document.getElementById('algorithmSelector') ? document.getElementById('algorithmSelector').value : 'BFD',
        sawThickness: document.getElementById('sawThickness') ? document.getElementById('sawThickness').value : '',
        theme: document.body.classList.contains('sepia-mode') ? 'sepia' : 'normal',
        fontSize: document.documentElement.style.fontSize || ''
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    } catch(e) {}
  }

  function loadSettings(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) {
      document.documentElement.classList.remove('preload-sepia','preload-normal','no-transitions');
      return;
    }

    isRestoring = true;
    try {
      const s = JSON.parse(saved);

      if (s && s.theme === 'sepia') document.body.classList.add('sepia-mode');
      else document.body.classList.remove('sepia-mode');

      if (s && s.fontSize) document.documentElement.style.fontSize = s.fontSize;

      const langEl = document.getElementById('language');
      if (langEl && s && s.language) {
        langEl.value = s.language;
        if (typeof window.updateLanguage === 'function') window.updateLanguage();
        langEl.dispatchEvent(new Event('change'));
      }

      const unitEl = document.getElementById('unit');
      if (unitEl && s && s.unit) {
        unitEl.value = s.unit;
        unitEl.dispatchEvent(new Event('change'));
      }

      const gCutEl = document.getElementById('globalCutUnit');
      if (gCutEl && s && s.globalCutUnit) {
        gCutEl.value = s.globalCutUnit;
        gCutEl.dispatchEvent(new Event('change'));
      }
      const gMatEl = document.getElementById('globalMaterialUnit');
      if (gMatEl && s && s.globalMaterialUnit) {
        gMatEl.value = s.globalMaterialUnit;
        gMatEl.dispatchEvent(new Event('change'));
      }

      const algoEl = document.getElementById('algorithmSelector');
      if (algoEl && s && s.algorithm) algoEl.value = s.algorithm;

      const sawEl = document.getElementById('sawThickness');
      if (sawEl && s && s.sawThickness !== undefined) sawEl.value = s.sawThickness;

    } catch(e) {
      console.warn('Settings load failed:', e);
    } finally {
      document.documentElement.classList.remove('preload-sepia','preload-normal','no-transitions');
      requestAnimationFrame(() => document.documentElement.classList.remove('no-transitions'));
      setTimeout(() => isRestoring = false, 100);
    }
  }

  function init(){
    loadSettings();

    ['language','unit','globalCutUnit','globalMaterialUnit','algorithmSelector','sawThickness'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', saveSettings);
      el.addEventListener('input', saveSettings);
    });

    if (typeof window.toggleTheme === 'function') {
      const originalToggle = window.toggleTheme;
      window.toggleTheme = function(){
        originalToggle();
        saveSettings();
      };
    }

    new MutationObserver(() => saveSettings()).observe(document.documentElement, { attributes:true, attributeFilter:['style'] });
    new MutationObserver(() => saveSettings()).observe(document.body, { attributes:true, attributeFilter:['class'] });

    window.addEventListener('beforeunload', saveSettings);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
</body>
<script>
(function(){
  function getLang(){
    var el = document.getElementById('language');
    return el ? el.value : 'zh';
  }
  function updateAlgorithmOptions(){
    var lang = getLang();
    var sel = document.getElementById('algorithmSelector');
    if (!sel) return;
    var labels = (lang === 'zh')
      ? { AutoBest: '自動最慳料', BFD: 'BFD', FFD: 'FFD', SizeGrouping: '智能優化' }
      : { AutoBest: 'Auto Best Saving', BFD: 'BFD', FFD: 'FFD', SizeGrouping: 'Smart Optimization' };
    Array.from(sel.options).forEach(function(opt){
      if (labels[opt.value]) opt.textContent = labels[opt.value];
    });
  }
  function updateTableHeaders(){
    var lang = getLang();
    var cutHead = document.querySelector('#cuttingItemsTable thead');
    if (cutHead) {
      var ths = cutHead.querySelectorAll('th');
      if (ths.length >= 4) {
        if (lang === 'zh') {
          ths[0].textContent = '長度';
          ths[1].textContent = '數量';
          ths[2].textContent = '用途';
          ths[3].textContent = '操作';
        } else {
          ths[0].textContent = 'Length';
          ths[1].textContent = 'Quantity';
          ths[2].textContent = 'Purpose';
          ths[3].textContent = 'Action';
        }
      }
    }
    var matHead = document.querySelector('#materialItemsTable thead');
    if (matHead) {
      var ths2 = matHead.querySelectorAll('th');
      if (ths2.length >= 4) { // 注意材料表現在有4欄
        if (lang === 'zh') {
          ths2[0].textContent = '材料長度';
          ths2[1].textContent = '數量';
          ths2[2].textContent = '操作';
          ths2[3].textContent = '使用狀態';
        } else {
          ths2[0].textContent = 'Material Length';
          ths2[1].textContent = 'Quantity';
          ths2[2].textContent = 'Action';
          ths2[3].textContent = 'Usage Status';
        }
      }
    }
  }
  function updateLoadModalTexts(){
    var lang = getLang();
    var label = document.getElementById('loadSchemeModalLabel');
    if (label) label.textContent = (lang === 'zh') ? '載入方案' : 'Load Scheme';
    var body = document.querySelector('#loadSchemeModal .modal-body');
    if (body) {
      var h6s = body.querySelectorAll('h6');
      if (h6s[0]) h6s[0].textContent = (lang === 'zh') ? '📁 從檔案上載方案' : '📁 Upload scheme from file';
      if (h6s[1]) h6s[1].textContent = (lang === 'zh') ? '📋 已儲存的方案' : '📋 Saved schemes';
      var uploadBtn = document.getElementById('uploadSchemeBtn') || body.querySelector('button.btn.btn-primary');
      if (uploadBtn) uploadBtn.innerHTML = (lang === 'zh') ? '📤 上載' : '📤 Upload';
    }
    var footerCancel = document.querySelector('#loadSchemeModal .modal-footer .btn.btn-secondary');
    if (footerCancel) footerCancel.textContent = (lang === 'zh') ? '取消' : 'Cancel';
  }
  function updateHelpModalFooter(){
    var lang = getLang();
    var closeBtn = document.querySelector('#helpModal .modal-footer .btn.btn-secondary');
    if (closeBtn) closeBtn.textContent = (lang === 'zh') ? '關閉' : 'Close';
  }
  function runAll(){
    updateAlgorithmOptions();
    updateTableHeaders();
    updateLoadModalTexts();
    updateHelpModalFooter();
  }
  document.addEventListener('DOMContentLoaded', runAll);
  window.addEventListener('load', runAll);
  var langSel = document.getElementById('language');
  if (langSel) langSel.addEventListener('change', runAll);
})();
</script>
<script>
(function(){
  function bind(){
    document.addEventListener('DOMContentLoaded', function(){ updateInputLabels(); });
    window.addEventListener('load', function(){ updateInputLabels(); });
    var u = document.getElementById('unit');
    if (u) u.addEventListener('change', updateInputLabels);
    var g = document.getElementById('globalCutUnit');
    if (g) g.addEventListener('change', updateInputLabels);
  }
  bind();
})();
</script>
<script>
(function(){
  function getUnit(){
    var u = document.getElementById('unit');
    if (u && u.value) return u.value;
    var g = document.getElementById('globalCutUnit');
    return g && g.value ? g.value : 'metric';
  }
  function getLang(){
    var l = document.getElementById('language');
    return l && l.value ? l.value : 'zh';
  }
  function applySawUnit(){
    var unit = getUnit();
    var lang = getLang();
    var label = document.getElementById('sawThicknessUnitLabel');
    var input = document.getElementById('sawThickness');
    if (!label || !input) return;
    if (unit === 'imperial' || unit === 'imperial_decimal'){
      label.textContent = (lang === 'zh') ? '分' : 'eighth';
      input.setAttribute('placeholder','1/8');
    } else {
      label.textContent = (lang === 'zh') ? '毫米' : 'mm';
      input.setAttribute('placeholder','3.2');
    }
  }
  function bind(){
    document.addEventListener('DOMContentLoaded', applySawUnit);
    window.addEventListener('load', applySawUnit);
    var u = document.getElementById('unit');
    if (u) u.addEventListener('change', applySawUnit);
    var g = document.getElementById('globalCutUnit');
    if (g) g.addEventListener('change', applySawUnit);
    var l = document.getElementById('language');
    if (l) l.addEventListener('change', applySawUnit);
    setInterval(applySawUnit, 500);
  }
  bind();
})();
</script>
<style>
#cutting-items-card .card-body, #materials-card .card-body { padding-top: 1.25rem; padding-bottom: 1.5rem; }


#cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1rem; }
#cutting-items-card .row.g-2, #materials-card .row.g-2 { margin-bottom: 0.75rem; }
#cuttingItems .controls-row { margin-top: 0.75rem; margin-bottom: 1.25rem; }
@media (max-width: 767.98px) {
  #cutting-items-card .card-body, #materials-card .card-body { padding-top: 1.5rem; padding-bottom: 2rem; }
  
  
  #cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1.25rem; }
}
</style>
<style>
#cutting-items-card .card-body, #materials-card .card-body { padding-top: 2rem !important; padding-bottom: 2.5rem !important; }


#cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1.5rem !important; }
#cutting-items-card .row.g-2, #materials-card .row.g-2 { margin-bottom: 1.25rem !important; }
#cuttingItems .controls-row { margin-top: 1rem !important; margin-bottom: 1.75rem !important; }
@media (max-width: 767.98px) {
  #cutting-items-card .card-body, #materials-card .card-body { padding-top: 2.25rem !important; padding-bottom: 3rem !important; }
  
  
  #cutting-items-card .row.g-3, #materials-card .row.g-3 { margin-bottom: 1.75rem !important; }
}
</style>
<style>
#cutting-items-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
#cutting-items-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }

#materials-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
#materials-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }

#cutting-items-card .card-body, #materials-card .card-body { padding-bottom: 0.25rem !important; }



#cuttingItems .controls-row { margin-bottom: 0.5rem !important; }

@media (max-width: 767.98px) {
  #cutting-items-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
  #cutting-items-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }
  #materials-card .row.g-2.length-input-group { margin-bottom: 1.25rem !important; }
  #materials-card .row.g-2.mt-2 { margin-top: 1.25rem !important; }
  #cutting-items-card .card-body, #materials-card .card-body { padding-bottom: 0.25rem !important; }
}

        #calculateButton {
            background-color: #198754;
            border-color: #198754;
            color: #fff;
        }
        #calculateButton:hover {
            background-color: #157347;
            border-color: #146c43;
        }
</style>
<script>
(function(){
  function selectSmallestAdequate(availableMaterials, requiredLen){
    for(var i=0;i<availableMaterials.length;i++){
      var m = availableMaterials[i];
      if((m.length||0) >= requiredLen){
        availableMaterials.splice(i,1);
        return m.length||0;
      }
    }
    return null;
  }
  function expandCuts(cuts){ var arr=[]; cuts.forEach(function(it){ var q=Number(it.quantity||0); for(var i=0;i<q;i++){ arr.push({length:it.length, display:it.display||'', purpose:it.purpose||''}); } }); return arr; }
  function expandMaterials(mats){ var arr=[]; mats.forEach(function(m){ var q=Number(m.quantity||0); for(var i=0;i<q;i++){ arr.push({length:Number(m.length)||0, display:m.display||''}); } }); return arr; }

  function createOptimizerFixed(algo){
    return function(cuts, materials, sawThickness){
      var allCuts = expandCuts(cuts);
      if(algo!=='SizeGrouping') allCuts.sort(function(a,b){ return b.length-a.length; });
      var availableMaterials = expandMaterials(materials).sort(function(a,b){ return a.length-b.length; });
      var defaultLen = materials && materials.length ? Math.max.apply(null, materials.map(function(m){ return m.length||0; })) : 6000;
      var bins=[];

      function placeIntoExisting(cut){
        var best=null, bestRem=Infinity;
        for(var i=0;i<bins.length;i++){
          var bin=bins[i];
          var used=bin.cuts.reduce(function(s,c){return s+c.length;},0);
          var kerf = bin.cuts.length>0 ? (bin.cuts.length-1)*sawThickness : 0;
          var req = cut.length + (bin.cuts.length>0 ? sawThickness : 0);
          var rem = bin.length - (used+kerf+req);
          if(rem>=0 && rem<bestRem){ bestRem=rem; best=bin; }
        }
        if(best){ best.cuts.push(cut); return true; }
        return false;
      }

      if(algo==='FFD'){
        allCuts.forEach(function(cut){
          if(placeIntoExisting(cut)) return;
          var reqLen = cut.length;
          var takeLen = selectSmallestAdequate(availableMaterials, reqLen);
          if(takeLen===null){ takeLen = defaultLen; bins.push({length: takeLen, cuts:[cut], autoAdded:true}); }
          else { bins.push({length: takeLen, cuts:[cut], autoAdded:false}); }
        });
      } else if(algo==='SizeGrouping'){
        var groups={}; allCuts.forEach(function(c){ (groups[c.length]=groups[c.length]||[]).push(c); });
        Object.keys(groups).map(Number).sort(function(a,b){ return b-a; }).forEach(function(len){
          var group=groups[len];
          while(group.length){
            var best=null, bestCount=0;
            for(var i=0;i<bins.length;i++){
              var bin=bins[i];
              var used=bin.cuts.reduce(function(s,c){return s+c.length;},0);
              var kerf = bin.cuts.length>0 ? (bin.cuts.length-1)*sawThickness : 0;
              var count=0, curr=used+kerf;
              for(var j=0;j<group.length;j++){
                var req=len+(bin.cuts.length+count>0? sawThickness:0);
                if(curr+req<=bin.length){ count++; curr+=req; } else break;
              }
              if(count>0 && count>bestCount){ bestCount=count; best=bin; }
            }
            if(best){ for(var k=0;k<bestCount;k++) best.cuts.push(group.shift()); }
            else {
              var reqLen = len;
              var takeLen = selectSmallestAdequate(availableMaterials, reqLen);
              var newBin = { length: (takeLen===null? defaultLen: takeLen), cuts: [], autoAdded: (takeLen===null) };
              var remaining = newBin.length;
              while(group.length){ var cut=group[0]; var req=cut.length+(newBin.cuts.length>0? sawThickness:0); if(req<=remaining){ newBin.cuts.push(group.shift()); remaining-=req; } else break; }
              bins.push(newBin);
            }
          }
        });
      } else {
        allCuts.forEach(function(cut){
          if(placeIntoExisting(cut)) return;
          var reqLen = cut.length;
          var takeLen = selectSmallestAdequate(availableMaterials, reqLen);
          if(takeLen===null){ bins.push({length: defaultLen, cuts:[cut], autoAdded:true}); }
          else { bins.push({length: takeLen, cuts:[cut], autoAdded:false}); }
        });
      }
      return bins;
    };
  }
  window.optimizeCutsFFD = createOptimizerFixed('FFD');
  window.optimizeCutsBFD = createOptimizerFixed('BFD');
  window.optimizeCutsSizeGrouping = createOptimizerFixed('SizeGrouping');
})();
</script>
<style>
button, .btn {
    text-shadow: none !important;
    -webkit-text-stroke: 0 !important;
}

#fontIncBtn, #fontDecBtn,
button[onclick*="toggleTheme"],
button[onclick*="showHelp"],
#qrBtn {
    width: 32px !important;
    height: 32px !important;
    min-width: 32px !important;
    min-height: 32px !important;
    border-radius: 50% !important;
    padding: 0 !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

body:not(.sepia-mode) .card {
    background-color: #454d55 !important;
    border: 1px solid #6c757d !important;
    color: #fff !important;
}

body:not(.sepia-mode) .card-body-light {
    background-color: #e9ecef !important;
    color: #212529 !important;
}

.btn-3d,
#globalCutUnit,
#globalMaterialUnit {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15) !important;
    transition: all 0.2s ease !important;
    border: 1px solid #dee2e6 !important;
}

.btn-3d:hover,
#globalCutUnit:hover,
#globalMaterialUnit:hover {
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2) !important;
    transform: translateY(-1px) !important;
}

.btn-3d:active,
#globalCutUnit:active,
#globalMaterialUnit:active {
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    transform: translateY(0px) !important;
}

body:not(.sepia-mode) .card-body-light #colorLegend,
body:not(.sepia-mode) .card-body-light .color-legend {
    color: #212529 !important;
}

body:not(.sepia-mode) .card-body:not(.card-body-light) #colorLegend,
body:not(.sepia-mode) .card-body:not(.card-body-light) .color-legend {
    color: #ffffff !important;
}

#calculateButton {
    background: linear-gradient(135deg, #00ff48 0%, #006400 100%) !important;
    border: none !important;
    color: white !important;
    position: relative;
    overflow: hidden;
    box-shadow: 
        0 -1px 0 rgba(255,255,255,0.5) inset,
        0 1px 0 rgba(0,0,0,0.3) inset,
        -1px 0 0 rgba(255,255,255,0.3) inset,
        1px 0 0 rgba(0,0,0,0.2) inset,
        0 4px 15px rgba(0,0,0,0.4) !important;
}

#calculateButton:hover {
    box-shadow: 
        0 -2px 0 rgba(255,255,255,0.6) inset,
        0 2px 0 rgba(0,0,0,0.3) inset,
        -2px 0 0 rgba(255,255,255,0.4) inset,
        2px 0 0 rgba(0,0,0,0.2) inset,
        0 6px 20px rgba(0,0,0,0.5) !important;
    transform: translateY(-1px);
}

#calculateButton:active {
    box-shadow: 
        0 1px 0 rgba(0,0,0,0.4) inset,
        0 -1px 0 rgba(255,255,255,0.2) inset,
        0 2px 8px rgba(0,0,0,0.3) !important;
    transform: translateY(1px);
}

#calculateButton::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 50%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
    border-radius: inherit;
    pointer-events: none;
    z-index: 2;
}

#calculateButton::after {
    content: '';
    position: absolute;
    top: -50%; left: -100%;
    width: 30%; height: 200%;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.9), transparent);
    transform: rotate(25deg);
    animation: shine 8s infinite ease-in-out;
    pointer-events: none;
    z-index: 3;
}

@keyframes shine {
    0% { left: -100%; opacity: 0; }
    10% { opacity: 1; }
    40% { left: 200%; opacity: 0; }
    100% { left: 200%; }
}

#helpButton, #printButton { display: none !important; }

#resetButton,
body:not(.sepia-mode) #resetButton,
body:not(.sepia-mode) .btn-danger {
    background: linear-gradient(135deg, #ffb36b 0%, #ff5500 50%, #ff8f8f 100%) !important;
    border: 2px solid #ff5500 !important;
    color: #ffffff !important;
    box-shadow: 0 2px 6px rgba(255, 85, 0, 0.30) !important;
    text-shadow: none !important;
    -webkit-text-stroke: 0 !important;
    font-weight: 600 !important;
}
body:not(.sepia-mode) #resetButton:hover,
body:not(.sepia-mode) .btn-danger:hover {
    background: linear-gradient(135deg, #ffc78f 0%, #ff7733 50%, #ffa8a8 100%) !important;
    transform: translateY(-1px);
}

body.sepia-mode * {
    text-shadow: none !important;
    -webkit-text-stroke: 0 !important;
}

body.sepia-mode {
    background: #f4ecd8 !important;
    color: #4a3a2a !important;
}

body.sepia-mode .card {
    background: #faf6ed !important;
    border: 2px solid #c9a876 !important;
    box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2) !important;
}

body.sepia-mode .card-header,
body.sepia-mode .section-header {
    background: linear-gradient(135deg, #6a5040 0%, #8a6a50 100%) !important;
    border-bottom: 2px solid #8b6f47 !important;
}

body.sepia-mode .card-body,
body.sepia-mode .card-body-light {
    background-color: #f5ead5 !important;
    background-image:
      repeating-linear-gradient(
        90deg,
        rgba(255,255,255,0.60) 0px,
        rgba(255,255,255,0.60) 1px,
        rgba(101,67,33,0.15) 2px,
        rgba(255,255,255,0.30) 4px,
        rgba(101,67,33,0.10) 6px
      ),
      linear-gradient(
        180deg,
        rgba(255,255,255,0.60) 0%,
        rgba(255,255,255,0.00) 25%,
        rgba(101,67,33,0.08) 60%,
        rgba(255,255,255,0.30) 100%
      ) !important;
    background-size: auto, 100% 100% !important;
    background-attachment: local !important;
}

body.sepia-mode h1,
body.sepia-mode #titleText,
body.sepia-mode .section-title,
body.sepia-mode .card-header *,
body.sepia-mode .section-header * {
    color: #ffffff !important;
}

body.sepia-mode h2, body.sepia-mode h3,
body.sepia-mode h4, body.sepia-mode h5, body.sepia-mode h6 {
    color: #5a4030 !important;
}

body.sepia-mode .form-control,
body.sepia-mode .form-select {
    background: #fffbf5 !important;
    border: 1px solid #c9a876 !important;
    color: #4a3a2a !important;
}

body.sepia-mode .table {
    color: #4a3a2a !important;
    border-color: #c9a876 !important;
    background: #faf6ed !important;
}

body.sepia-mode .table thead,
body.sepia-mode .table-active {
    background: #e8dcc4 !important;
}

body.sepia-mode [class*="bg-light"],
body.sepia-mode .bg-secondary {
    background: #f0e6d2 !important;
}

body.sepia-mode .btn-primary,
body.sepia-mode .btn-success {
    background: 
        repeating-linear-gradient(
            45deg,
            #8b6f47,
            #8b6f47 10px,
            #7a5f37 10px,
            #7a5f37 20px
        ) !important;
    border: 2px solid #6b5533 !important;
    color: #fff !important;
    box-shadow: 0 3px 8px rgba(107, 85, 51, 0.3) !important;
}

body.sepia-mode .btn-secondary,
body.sepia-mode .btn-outline-secondary {
    background: linear-gradient(135deg, #c9a876 0%, #a88a5e 100%) !important;
    border: 2px solid #8b7355 !important;
    color: #3a2a1a !important;
    box-shadow: 0 2px 6px rgba(139, 115, 85, 0.2) !important;
}

body.sepia-mode .btn-warning {
    background: linear-gradient(135deg, #d4a574 0%, #b88a54 100%) !important;
    border: 2px solid #9d7545 !important;
    color: #3a2a1a !important;
    box-shadow: 0 2px 6px rgba(157, 117, 69, 0.22) !important;
}

body.sepia-mode #resetButton,
body.sepia-mode .btn-danger {
    background: linear-gradient(135deg, #ffb36b 0%, #ff5500 50%, #ff8f8f 100%) !important;
    border: 2px solid #ff5500 !important;
    color: #fff !important;
    box-shadow: 0 3px 8px rgba(255, 85, 0, 0.30) !important;
}

body.sepia-mode .btn-info {
    background: 
        radial-gradient(circle at 5px 5px, #b8956a 1px, transparent 1px),
        #e8dcc4 !important;
    background-size: 10px 10px !important;
    border: 2px solid #a0826d !important;
    color: #4a3a2a !important;
}

body.sepia-mode .btn {
    background: 
        linear-gradient(45deg, #f0e6d2 25%, transparent 25%),
        linear-gradient(-45deg, #f0e6d2 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #f0e6d2 75%),
        linear-gradient(-45deg, transparent 75%, #f0e6d2 75%),
        #ead9bf !important;
    background-size: 20px 20px !important;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px !important;
    border: 1px solid #b8956a !important;
    color: #4a3a2a !important;
}

body.sepia-mode .btn:hover {
    background: 
        linear-gradient(45deg, #e8dcc4 25%, transparent 25%),
        linear-gradient(-45deg, #e8dcc4 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e8dcc4 75%),
        linear-gradient(-45deg, transparent 75%, #e8dcc4 75%),
        #dcc9a5 !important;
    background-size: 20px 20px !important;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px !important;
}

body.sepia-mode .btn-outline-warning {
    background: linear-gradient(to bottom, #d4a574, #c9956a) !important;
    border: 2px solid #a0826d !important;
    color: #3a2a1a !important;
}

body.sepia-mode .btn-outline-danger {
    background: linear-gradient(to bottom, #b8714a, #a0522d) !important;
    border: 2px solid #8b4513 !important;
    color: #fff !important;
}

body.sepia-mode .modal-content {
    background: #faf6ed !important;
    border: 2px solid #c9a876 !important;
    color: #4a3a2a !important;
}

body.sepia-mode label {
    color: #5a4030 !important;
}

body.sepia-mode .text-muted,
body.sepia-mode .small-hint {
    color: #8b7355 !important;
}

body.sepia-mode #colorLegend,
body.sepia-mode .color-legend,
body.sepia-mode [id*="colorLegend"] {
    color: #3a2a1a !important;
}

body.sepia-mode .btn-3d,
body.sepia-mode #globalCutUnit,
body.sepia-mode #globalMaterialUnit {
    box-shadow: 0 2px 4px rgba(107, 85, 51, 0.2) !important;
}

body.sepia-mode select.form-select:not(.unit-select),
body.sepia-mode select.form-select-sm:not(.unit-select) {
  -webkit-appearance: none !important;
  appearance: none !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%235a4030' d='M4.2 6.2a1 1 0 0 1 1.4 0L8 8.6l2.4-2.4a1 1 0 1 1 1.4 1.4l-3.1 3.1a1 1 0 0 1-1.4 0L4.2 7.6a1 1 0 0 1 0-1.4z'/%3E%3C/svg%3E") !important;
  background-repeat: no-repeat !important;
  background-position: right .55rem center !important;
  background-size: .8rem .8rem !important;
  padding-right: 1.9rem !important;
}

body.sepia-mode select.unit-select,
body.sepia-mode #unit,
body.sepia-mode #globalCutUnit,
body.sepia-mode #globalMaterialUnit {
  background-image: none !important;
  padding-right: 0 !important;
}

.form-control,
.form-select,
textarea {
  box-shadow: 0 3px 10px rgba(0,0,0,.18), 0 1px 3px rgba(0,0,0,.12) !important;
  transition: box-shadow .15s ease !important;
}
.form-control:focus,
.form-select:focus,
textarea:focus {
  box-shadow: 0 0 0 .16rem rgba(0,0,0,.08), 0 6px 16px rgba(0,0,0,.22) !important;
}

.btn,
.top-tools .tool-btn {
  box-shadow: 0 3px 10px rgba(0,0,0,.22), 0 1px 3px rgba(0,0,0,.14) !important;
  transition: box-shadow .12s ease, transform .08s ease !important;
}
.btn:hover,
.top-tools .tool-btn:hover {
  box-shadow: 0 6px 18px rgba(0,0,0,.28), 0 2px 6px rgba(0,0,0,.16) !important;
  transform: translateY(-1px) !important;
}
.btn:active,
.top-tools .tool-btn:active {
  box-shadow: 0 2px 6px rgba(0,0,0,.20) !important;
  transform: translateY(0) !important;
}

body.sepia-mode #resetButton {
  box-shadow: 0 4px 12px rgba(0,0,0,.26) !important;
}
</style>

<script>
(function() {
    document.body.classList.remove('sepia-mode', 'light-mode', 'dark-mode', 'dark-beauty-mode');

    try {
        localStorage.removeItem('theme');
        localStorage.removeItem('my_custom_theme');
        localStorage.removeItem('themelightmode');
    } catch(e) {}

    setTimeout(function() {
        var themeBtn = document.querySelector('button[onclick*="toggleTheme"]');
        if (themeBtn && !document.getElementById('newHelpBtn')) {
            var langSel = document.getElementById('language');
            var lang = langSel ? langSel.value : 'zh';

            var helpBtn = document.createElement('button');
            helpBtn.id = 'newHelpBtn';
            helpBtn.className = themeBtn.className;
            helpBtn.onclick = function() { if(window.showHelp) showHelp(); };
            helpBtn.title = (lang === 'zh') ? '幫助' : 'Help';
            helpBtn.innerHTML = '<i class="fas fa-question"></i>';
            themeBtn.parentNode.insertBefore(helpBtn, themeBtn.nextSibling);

            if (!document.getElementById('qrBtn')) {
              var qrBtn = document.createElement('button');
              qrBtn.id = 'qrBtn';
              qrBtn.className = themeBtn.className;
              qrBtn.onclick = function(){ if(window.showQr) showQr(); };
              qrBtn.title = (lang === 'zh') ? 'QR碼' : 'QR Code';
              qrBtn.innerHTML = '<span style="font-size:12px;font-weight:700;line-height:1;">QR</span>';
              helpBtn.parentNode.insertBefore(qrBtn, helpBtn.nextSibling);
            }

            if (typeof window.updateLanguage === 'function') {
              setTimeout(function(){ try{ window.updateLanguage(); }catch(e){} }, 0);
            }
        }
    }, 100);

    window.toggleTheme = function() {
        document.body.classList.toggle('sepia-mode');
    };

    setTimeout(function() {
        var schemeList = document.getElementById('savedSchemesList');
        if (schemeList) {
            schemeList.addEventListener('click', function(e) {
                var target = e.target;

                while (target && target !== schemeList) {
                    if (target.tagName === 'BUTTON' && 
                        (target.onclick || target.getAttribute('onclick'))) {

                        setTimeout(function() {
                            var modals = document.querySelectorAll('.modal.show');
                            modals.forEach(function(modal) {
                                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                                    var bsModal = bootstrap.Modal.getInstance(modal);
                                    if (bsModal) {
                                        bsModal.hide();
                                    } else {
                                        var newModal = new bootstrap.Modal(modal);
                                        newModal.hide();
                                    }
                                }
                            });
                        }, 400);
                        break;
                    }
                    target = target.parentElement;
                }
            });
        }
    }, 1000);
})();
</script>
</html>